<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Normal - Oliver Twist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFFFF;
            overflow: hidden;
            width: 428px;
            height: 926px;
            margin: 0 auto;
            position: relative;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #FFFFFF;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-button-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 127px;
            background: #FFFFFF;
            z-index: 100;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 20px 20px;
        }

        .top-button-bar.hidden {
            transform: translateX(-50%) translateY(-100%);
        }

        .top-button-bar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .top-nav-content {
            position: absolute;
            top: 50px;
            left: 53.5px;
            width: 320.41px;
            height: 51px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            width: 19px;
            height: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        .back-button img {
            width: 19px;
            height: 16px;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .book-title {
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #19191B;
            text-align: center;
        }

        .book-author {
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #9D9D9D;
            text-align: center;
        }

        .menu-button {
            width: 4px;
            height: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dot {
            width: 4px;
            height: 4px;
            background: #19191B;
            border-radius: 50%;
        }

        /* é˜…è¯»å†…å®¹åŒºåŸŸ */
        .reading-content {
            position: absolute;
            top: 128px;
            left: 0;
            width: 428px;
            height: 798px;
            padding: 10px 24px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #FFFFFF;
        }

        .text-content {
            width: 380px;
            min-height: 725px;
            margin-bottom: 63px;
            font-weight: 300;
            font-size: 16px;
            line-height: 2.25em;
            color: #9D9D9D;
            text-align: left;
            cursor: pointer;
            background: #FFFFFF;
        }

        .chapter {
            margin-bottom: 40px;
        }

        .chapter h2 {
            font-weight: 600;
            font-size: 20px;
            color: #19191B;
            margin-bottom: 20px;
            text-align: center;
        }

        .chapter p {
            margin-bottom: 20px;
            text-align: justify;
        }

        /* é«˜äº®æ–‡æœ¬æ ·å¼ */
        .highlighted {
            background: linear-gradient(120deg, #A88DCB 0%, #C4A8E8 100%);
            color: #FFFFFF;
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .highlighted:hover {
            background: linear-gradient(120deg, #9B7BB8 0%, #B395D4 100%);
            transform: scale(1.02);
        }

        .highlighted.selected {
            background: linear-gradient(120deg, #8A6FA8 0%, #A88DCB 100%);
            box-shadow: 0 0 10px rgba(168, 141, 203, 0.5);
        }

        /* å–æ¶ˆé«˜äº®æŒ‰é’® */
        .unhighlight-btn {
            position: absolute;
            top: -20px;
            right: -20px;
            width: 20px;
            height: 20px;
            background: #FF4757;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }

        .highlighted:hover .unhighlight-btn {
            display: flex;
        }

        /* é¡µé¢åŠ è½½åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .reading-content::-webkit-scrollbar {
            display: none;
        }

        .reading-content {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Overlayé®ç½©æ ·å¼ */
        .overlay-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(234, 234, 234, 0.2);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            pointer-events: none;
        }

        .top-tab-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 428px;
            height: 127px;
            background: #FFFFFF;
            z-index: 1002;
            pointer-events: auto;
            left: 50%;
            transform: translateX(-50%);
        }

        .top-nav-content {
            position: absolute;
            top: 51px;
            left: 53.5px;
            width: 320.41px;
            height: 51px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            width: 19px;
            height: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        .back-button img {
            width: 19px;
            height: 16px;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .book-title {
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #19191B;
            text-align: center;
        }

        .book-author {
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #9D9D9D;
            text-align: center;
        }

        .menu-button {
            width: 4px;
            height: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dot {
            width: 4px;
            height: 4px;
            background: #19191B;
            border-radius: 50%;
        }

        .content-overlay {
            position: absolute;
            top: 127px;
            left: 0;
            width: 428px;
            height: 741px;
            background: rgba(234, 234, 234, 0.2);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            z-index: 1002;
            pointer-events: auto;
            left: 50%;
            transform: translateX(-50%);
        }

        .bottom-label-bar {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 428px;
            height: 88px;
            background: #FFFFFF;
            border-radius: 30px 30px 0px 0px;
            box-shadow: 0px -2px 12px 3px rgba(0, 0, 0, 0.25);
            z-index: 1002;
            pointer-events: auto;
            transition: transform 0.3s ease-out;
        }

        .bottom-label-bar.show {
            transform: translateX(-50%) translateY(0);
        }

        .bottom-icons {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 100px;
        }

        .icon-item {
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-item.active {
            transform: scale(1.1);
        }

        .icon-item svg {
            width: 30px;
            height: 30px;
            transition: all 0.3s ease;
        }

        .icon-item.active img {
            filter: brightness(0) saturate(100%) invert(67%) sepia(15%) saturate(1234%) hue-rotate(240deg) brightness(95%) contrast(90%);
        }

        .icon-item:not(.active) img {
            filter: brightness(0) saturate(100%) invert(55%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(89%) contrast(86%);
        }

        /* OverlayåŠ¨ç”» - ä»ä¸­é—´å¼¹å‡º */
        @keyframes centerSlideIn {
            from {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes centerSlideOut {
            from {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
        }

        /* Recordingç»Ÿè®¡å¼¹çª—æ ·å¼ - æ ¹æ®Figmaè®¾è®¡ */
        .stats-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 320px;
            background: #FFFFFF;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            visibility: hidden;
            opacity: 0;
            padding: 0;
        }

        .stats-modal.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .stats-header {
            position: absolute;
            top: 7px;
            left: 50%;
            transform: translateX(-50%);
            width: 94px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #000000;
        }

        .stats-section {
            position: absolute;
            width: 184px;
            height: 71px;
        }

        .stats-section.reading-time {
            top: 57px;
            left: 15px;
        }

        .stats-section.exit-count {
            top: 148px;
            left: 15px;
            width: 104px;
        }

        .stats-section.stroke-count {
            top: 239px;
            left: 15px;
            width: 121px;
        }

        .stats-label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            background: #EAEAEA;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 12px;
            line-height: 1.5em;
            color: #000000;
        }

        .stats-value {
            position: absolute;
            top: 43px;
            left: 15px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .stats-value > div {
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }

        .stats-display {
            width: 42px;
            height: 28px;
            border: 1px solid #A88DCB;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            color: #19191B;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
        }

        .stats-unit {
            font-weight: 300;
            font-size: 13px;
            line-height: 1.5em;
            color: #000000;
        }

        /* ç¬”è®°æœ¬å¼¹çª—æ ·å¼ */
        .notebook-modal {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 690px;
            background: #FFFFFF;
            border-radius: 30px 30px 0 0;
            display: none;
            flex-direction: column;
            z-index: 10000;
            box-shadow: 0px -2px 12px 3px rgba(0, 0, 0, 0.25);
        }

        .notebook-modal.show {
            display: flex !important;
        }

        .notebook-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            width: 100%;
        }

        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-icon {
            width: 19px;
            height: 16px;
            object-fit: contain;
        }

        .notebook-title-bg {
            background: #A88DCB;
            border-radius: 10px;
            padding: 5px 10px;
            flex: 1;
            display: flex;
            justify-content: center;
            margin: 0 20px;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .notebook-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #FFFFFF;
            text-align: center;
        }


        .notebook-content {
            width: 380px;
            height: 440px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            padding-right: 10px;
            margin: 0 auto;
        }

        .notebook-item {
            background: #FFFFFF;
            border: 1px solid #757575;
            border-radius: 20px;
            padding: 10px;
            position: relative;
        }

        .notebook-item .text {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            font-size: 16px;
            line-height: 1.5em;
            color: #000000;
            text-align: left;
            word-wrap: break-word;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            line-clamp: 6;
            -webkit-box-orient: vertical;
        }

        .notebook-item .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .no-notes {
            text-align: center;
            color: #9D9D9D;
            font-style: italic;
            padding: 40px 20px;
        }

        .notebook-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #D9D9D9;
        }

        .indicator.active {
            background: #A88DCB;
        }

        .notebook-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 88px;
            background: #FFFFFF;
            border-radius: 30px 30px 0 0;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 100px;
            z-index: 10001;
        }

        .notebook-bottom-bar.show {
            display: flex;
        }

        .notebook-tab {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notebook-tab.active .tab-icon {
            filter: brightness(0) saturate(100%) invert(67%) sepia(15%) saturate(1200%) hue-rotate(240deg) brightness(0.8) contrast(0.8);
        }

        .tab-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        /* åˆ é™¤é€‰æ‹©ç•Œé¢æ ·å¼ */
        .delete-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .delete-title h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 18px;
            color: #000000;
            margin: 0;
        }

        .notebook-item.selectable {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .note-checkbox {
            margin-top: 5px;
        }

        .note-checkbox input[type="checkbox"] {
            display: none;
        }

        .note-checkbox label {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #757575;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .note-checkbox input[type="checkbox"]:checked + label {
            background: #A88DCB;
            border-color: #A88DCB;
        }

        .note-checkbox input[type="checkbox"]:checked + label::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .delete-buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }

        .cancel-delete-btn, .confirm-delete-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-delete-btn {
            background: #f5f5f5;
            color: #666;
        }

        .cancel-delete-btn:hover {
            background: #e0e0e0;
        }

        .confirm-delete-btn {
            background: #ff4444;
            color: white;
        }

        .confirm-delete-btn:hover {
            background: #cc3333;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 428px) {
            body {
                width: 100vw;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .container {
                width: 100vw;
                height: 100vh;
                transform: scale(1);
            }
            
            .top-button-bar {
                width: 100vw;
                left: 0;
                transform: translateX(0);
            }
            
            .bottom-label-bar {
                width: 100vw;
                left: 0;
                transform: translateX(0) translateY(100%);
            }
            
            .bottom-label-bar.show {
                transform: translateX(0) translateY(0);
            }
            
            .notebook-bottom-bar {
                width: 100vw;
                left: 0;
                transform: translateX(0);
            }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="top-button-bar" id="topBar">
            <div class="top-nav-content">
                <div class="back-button" onclick="goBack()">
                    <img src="../images/Vector.svg" width="19" height="16" alt="è¿”å›">
                </div>
                <div class="book-info">
                    <div class="book-title">Oliver Twist</div>
                    <div class="book-author">Charles Dickens</div>
                </div>
                <div class="menu-button" onclick="showRecording()">
                    <div class="menu-dot"></div>
                    <div class="menu-dot"></div>
                    <div class="menu-dot"></div>
                </div>
            </div>
        </div>

        <!-- é˜…è¯»å†…å®¹åŒºåŸŸ -->
        <div class="reading-content" id="readingContent">
            <div class="text-content" id="textContent">
                <!-- è¿™é‡Œå°†æ’å…¥é•¿æ–‡æœ¬å†…å®¹ -->
            </div>
            
            
            <!-- å¯¼å‡ºæ•°æ®æŒ‰é’® -->
            <div style="position: fixed; top: 300px; left: 20px; z-index: 9999; background: #4ECDC4; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="exportUserData()">
                å¯¼å‡ºæ•°æ®
            </div>
            
            
            <!-- è¿›åº¦å¼¹çª— -->
            <div id="progressModal" style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 428px; height: 200px; background: white; border-radius: 30px 30px 0 0; z-index: 10002; visibility: hidden; opacity: 0; box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;">
                <!-- è¿›åº¦å¼¹çª—å†…å®¹ -->
                <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                    <!-- é¡¶éƒ¨åŒºåŸŸï¼šé˜…è¯»æ—¶é—´å’Œè¿›åº¦ -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <!-- é˜…è¯»æ—¶é—´ -->
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div id="readingHours" style="font-size: 20px; font-weight: 600; color: #000000;">0</div>
                            <div style="font-size: 12px; font-weight: 400; color: #9D9D9D;">Hour</div>
                            <div id="readingMinutes" style="font-size: 20px; font-weight: 600; color: #000000;">0</div>
                            <div style="font-size: 12px; font-weight: 400; color: #9D9D9D;">min</div>
                        </div>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div style="width: 1px; height: 30px; background: #E0E0E0;"></div>
                        
                        <!-- é˜…è¯»è¿›åº¦ -->
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <div id="readingProgress" style="font-size: 20px; font-weight: 600; color: #333333;">0</div>
                            <div style="font-size: 14px; font-weight: 400; color: #9D9D9D;">%</div>
                        </div>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <div style="width: 1px; height: 30px; background: #E0E0E0;"></div>
                        
                        <!-- ä¸€å‘¨é˜…è¯»é¢‘æ¬¡ï¼ˆ7ä¸ªæŸ±çŠ¶å›¾ï¼‰ -->
                        <div id="weeklyBars" style="display: flex; align-items: flex-end; gap: 6px;">
                            <div style="width: 3px; height: 8px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 12px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 6px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 14px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 18px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 10px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 16px; background: #19191B; border-radius: 2px;"></div>
                        </div>
                    </div>
                    
                    <!-- ä¸­é—´è¿›åº¦æ¡ -->
                    <div style="position: relative; width: 100%; height: 20px; margin-bottom: 15px;">
                        <!-- è¿›åº¦æ¡èƒŒæ™¯ -->
                        <div style="width: 100%; height: 20px; background: #EEEEEE; border-radius: 32px; position: relative;">
                            <!-- è¿›åº¦æ¡å¡«å…… -->
                            <div id="progressFill" style="width: 0%; height: 20px; background: #D9D9D9; border-radius: 32px; position: absolute; top: 0; left: 0;"></div>
                            <!-- è¿›åº¦æ¡æ‹–æ‹½ç‚¹ -->
                            <div id="progressHandle" style="width: 28px; height: 28px; background: white; border-radius: 50%; position: absolute; top: -4px; left: -14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); cursor: pointer; border: 3px solid #D9D9D9;"></div>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨å¯¼èˆªæ  -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 100px; padding-top: 10px; border-top: 1px solid #F0F0F0;">
                        <!-- ç¬”è®°æœ¬å›¾æ ‡ -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToNotebook(this)">
                            <img src="../images/notebook.svg" width="30" height="30" alt="notebook" style="filter: grayscale(1);">
                        </div>
                        
                        <!-- è¿›åº¦å›¾æ ‡ -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToProcessing(this)">
                            <img src="../images/processing.svg" width="30" height="30" alt="processing" style="filter: hue-rotate(240deg) saturate(2);">
                        </div>
                        
                        <!-- äº®åº¦å›¾æ ‡ -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToLight(this)">
                            <img src="../images/light.svg" width="30" height="30" alt="light" style="filter: grayscale(1);">
                        </div>
                    </div>
                </div>
            </div>
             
            <div id="simpleRecordingModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 320px; background: white; color: black; display: none; visibility: hidden; opacity: 0; z-index: 10002; padding: 20px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);">
                <h3 style="text-align: center; margin-bottom: 20px;">Recording</h3>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Reading Time</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingHours">0</div>
                            <div style="font-size: 13px;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingMinutes">0</div>
                            <div style="font-size: 13px;">Min</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of Exits</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleExitCount">0</div>
                            <div style="font-size: 13px;">Times</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of strokes</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleHighlightCount">0</div>
                            <div style="font-size: 13px;">Items</div>
                        </div>
                    </div>
                </div>
            </div>
            
           

        <!-- Recordingç»Ÿè®¡å¼¹çª— - æ ¹æ®Figmaè®¾è®¡ -->
        <div class="stats-modal" id="statsModal">
            <div class="stats-header">Recording</div>
            
            <div class="stats-section reading-time">
                <div class="stats-label">Reading Time</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="readingHours">0</div>
                        <div class="stats-unit">Hour</div>
                    </div>
                    <div>
                        <div class="stats-display" id="readingMinutes">0</div>
                        <div class="stats-unit">Min</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section exit-count">
                <div class="stats-label">Number of Exits</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="exitCount">0</div>
                        <div class="stats-unit">Times</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section stroke-count">
                <div class="stats-label">Number of strokes</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="highlightCount">0</div>
                        <div class="stats-unit">Items</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬”è®°æœ¬å¼¹çª— -->
        <div class="notebook-modal" id="notebookModal">
            <div class="notebook-container">
                <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
                <div class="notebook-header">
                    <button class="back-btn" onclick="closeNotebook()">
                        <img src="../images/Vector.svg" alt="è¿”å›" class="back-icon">
                    </button>
                    <div class="notebook-title-bg">
                        <span class="notebook-title">My Notes</span>
                    </div>
                    <button class="delete-btn" onclick="deleteAllNotes()">
                        <img src="../images/delete.png" alt="åˆ é™¤" class="delete-icon">
                    </button>
                </div>
                
                <!-- ç¬”è®°å†…å®¹åŒºåŸŸ -->
                <div class="notebook-content" id="notebookContent">
                    <!-- ç¬”è®°å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <!-- åº•éƒ¨æŒ‡ç¤ºå™¨ -->
                <div class="notebook-indicators">
                    <div class="indicator active" onclick="goToPage(0)"></div>
                    <div class="indicator" onclick="goToPage(1)"></div>
                    <div class="indicator" onclick="goToPage(2)"></div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨æ ‡ç­¾æ  - è¦†ç›–åœ¨å¼¹çª—ä¸Šé¢ -->
        <div class="notebook-bottom-bar" id="notebookBottomBar">
            <div class="notebook-tab active">
                <img src="../images/notebook.svg" alt="ç¬”è®°æœ¬" class="tab-icon">
            </div>
            <div class="notebook-tab">
                <img src="../images/processing.svg" alt="è¿›åº¦" class="tab-icon">
            </div>
            <div class="notebook-tab">
                <img src="../images/light.svg" alt="äº®åº¦" class="tab-icon">
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å®šä¹‰
        let readingTime = 0;
        let exitCount = 0;
        let totalStrokes = 0;
        let startTime = Date.now();
        let highlightedElements = []; // å­˜å‚¨æ‰€æœ‰åˆ’çº¿å…ƒç´ çš„ä¿¡æ¯
        let currentPage = 0; // å½“å‰é¡µç 
        let notesPerPage = 3; // æ¯é¡µæ˜¾ç¤ºçš„ç¬”è®°æ•°é‡
        
        // æ–‡æœ¬é€‰æ‹©ç›¸å…³å˜é‡
        let isSelectingText = false;
        let selectionStartElement = null;
        let selectionEndElement = null;
        let highlightTimer = null;
        let isLongPressing = false;
        
        // å–æ¶ˆé•¿æŒ‰è®¡æ—¶
        function cancelHighlightTimer() {
            if (highlightTimer) {
                clearTimeout(highlightTimer);
                highlightTimer = null;
            }
            isLongPressing = false;
        }
        
        // é•¿æŒ‰å¼€å§‹è®¡æ—¶ - æ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡
        function startHighlightTimer(e) {
            // é•¿æŒ‰åŠŸèƒ½å·²åˆ é™¤ï¼Œä½¿ç”¨ç½‘é¡µç«¯è‡ªå¸¦çš„é•¿æŒ‰é€‰ä¸­
        }
        
        // å¯ç”¨ç½‘é¡µç«¯è‡ªå¸¦æ–‡æœ¬é€‰æ‹©åŠŸèƒ½
        function enableNativeTextSelection() {
            // ç›‘å¬æ–‡æœ¬é€‰æ‹©äº‹ä»¶
            document.addEventListener('selectionchange', function() {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText && selectedText.length > 0) {
                    showSelectionMenu(selection);
                } else {
                    hideSelectionMenu();
                }
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼Œé˜²æ­¢é€‰æ‹©èœå•ç‚¹å‡»æ—¶è§¦å‘ç°è‰²é®ç½©
            document.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯é€‰æ‹©èœå•ï¼Œé˜»æ­¢äº‹ä»¶ä¼ æ’­
                if (e.target.closest('#native-selection-menu')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µ
        }
        
        // æ˜¾ç¤ºé€‰æ‹©èœå•
        function showSelectionMenu(selection) {
            // ç§»é™¤å·²å­˜åœ¨çš„èœå•
            hideSelectionMenu();
            
            // è·å–é€‰æ‹©èŒƒå›´
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            // åˆ›å»ºæ“ä½œèœå•
            const actionMenu = document.createElement('div');
            actionMenu.id = 'native-selection-menu';
            actionMenu.style.cssText = `
                position: fixed;
                top: ${rect.top - 50}px;
                left: ${rect.left + rect.width / 2}px;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                border-radius: 8px;
                padding: 8px 0;
                z-index: 10003;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                min-width: 120px;
            `;
            
            actionMenu.innerHTML = `
                <div class="menu-item" style="
                    padding: 8px 16px;
                    color: white;
                    cursor: pointer;
                    font-size: 14px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    transition: background-color 0.2s ease;
                " data-action="add-to-notes">æ·»åŠ åˆ°ç¬”è®°</div>
                <div class="menu-item" style="
                    padding: 8px 16px;
                    color: white;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background-color 0.2s ease;
                " data-action="cancel">å–æ¶ˆ</div>
            `;
            
            // æ·»åŠ èœå•é¡¹æ‚¬åœæ•ˆæœ
            const menuItems = actionMenu.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                });
            });
            
            // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
            actionMenu.addEventListener('click', function(e) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å•å‡»äº‹ä»¶
                e.preventDefault();
                e.stopPropagation();
                
                const action = e.target.getAttribute('data-action');
                const selectedText = window.getSelection().toString().trim();
                
                if (action === 'add-to-notes' && selectedText) {
                    addToNotesFromSelection(selectedText, selection);
                    hideSelectionMenu();
                } else if (action === 'cancel') {
                    hideSelectionMenu();
                }
            });
            
            document.body.appendChild(actionMenu);
        }
        
        // éšè—é€‰æ‹©èœå•
        function hideSelectionMenu() {
            const existingMenu = document.getElementById('native-selection-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
        }
        
        // ä»é€‰æ‹©æ·»åŠ åˆ°ç¬”è®°
        function addToNotesFromSelection(selectedText, selection) {
            // å…ˆä¿å­˜åˆ°ç¬”è®°æ•°æ®åº“
            saveToNotesDatabase(selectedText);
            
            // åˆ›å»ºé«˜äº®æ•ˆæœ
            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = 'highlighted';
            span.style.cssText = `
                background-color: #FFEB3B;
                padding: 2px 4px;
                border-radius: 3px;
                cursor: pointer;
                display: inline-block;
                margin: 2px 0;
            `;
            
            // è®¾ç½®é«˜äº®æ–‡æœ¬å†…å®¹
            span.textContent = selectedText;
            
            try {
                // å°è¯•ä½¿ç”¨surroundContents
                range.surroundContents(span);
            } catch (error) {
                try {
                    // å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨extractContentså’ŒinsertNode
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                } catch (error2) {
                    // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥æ›¿æ¢æ–‡æœ¬å†…å®¹
                    const parentElement = range.commonAncestorContainer.parentElement || range.commonAncestorContainer;
                    if (parentElement && parentElement.textContent) {
                        const originalText = parentElement.textContent;
                        const newText = originalText.replace(selectedText, span.outerHTML);
                        parentElement.innerHTML = newText;
                    }
                }
            }
            
            // æ¸…é™¤é€‰æ‹©
            selection.removeAllRanges();
            
            // ç¡®ä¿èœå•è¢«éšè—
            hideSelectionMenu();
            
        }
        
        
        // å–æ¶ˆé€‰æ‹©ï¼ˆå·²åˆ é™¤è‡ªå®šä¹‰é€‰æ‹©åŠŸèƒ½ï¼‰
        function cancelSelection() {
            // å–æ¶ˆé€‰æ‹©åŠŸèƒ½å·²åˆ é™¤
        }
        
        // ä¿å­˜åˆ°ç¬”è®°æ•°æ®åº“
        function saveToNotesDatabase(text) {
            // åˆ›å»ºç¬”è®°è®°å½•
            const noteRecord = {
                id: Date.now(),
                text: text,
                timestamp: new Date().toLocaleString(),
                page: 'bookNormal',
                type: 'highlight'
            };
            
            // è·å–ç°æœ‰ç¬”è®°
            let notes = JSON.parse(localStorage.getItem('notes') || '[]');
            
            // æ·»åŠ æ–°ç¬”è®°
            notes.push(noteRecord);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('notes', JSON.stringify(notes));
            
            // æ›´æ–°recordingé¡µé¢çš„åˆ’çº¿è®¡æ•°
            updateRecordingStrokes();
        }
        
        // æ›´æ–°recordingé¡µé¢çš„åˆ’çº¿è®¡æ•°
        function updateRecordingStrokes() {
            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
            const strokesCount = notes.length;
            
            // æ›´æ–°recordingé¡µé¢æ˜¾ç¤º
            const strokesElement = document.querySelector('.recording-strokes .recording-number');
            if (strokesElement) {
                strokesElement.textContent = strokesCount;
            }
        }
        
        // å®Œæ•´æ•°æ®åº“ç³»ç»Ÿ
        class UserBehaviorDatabase {
            constructor() {
                this.dbName = 'ebookReadingDatabase';
                this.version = '1.0';
                this.initDatabase();
            }
            
            initDatabase() {
                // åˆå§‹åŒ–æ•°æ®åº“ç»“æ„
                if (!localStorage.getItem(this.dbName)) {
                    const initialData = {
                        version: this.version,
                        users: {},
                        sessions: {},
                        highlights: {},
                        statistics: {},
                        exports: []
                    };
                    localStorage.setItem(this.dbName, JSON.stringify(initialData));
                    console.log('ğŸ’¾ æ•°æ®åº“å·²åˆå§‹åŒ–');
                }
            }
            
            getCurrentUser() {
                return localStorage.getItem('currentUserId') || 'anonymous';
            }
            
            getCurrentSession() {
                return localStorage.getItem('userSessionStart') || new Date().toISOString();
            }
            
            // ä¿å­˜ç”¨æˆ·è¡Œä¸ºè®°å½•
            saveBehavior(action, data) {
                try {
                    const userId = this.getCurrentUser();
                    const sessionId = this.getCurrentSession();
                    const timestamp = new Date().toISOString();
                    
                    const record = {
                        id: this.generateId(),
                        userId: userId,
                        sessionId: sessionId,
                        action: action,
                        data: data,
                        timestamp: timestamp,
                        page: 'book_normal'
                    };
                    
                    // è·å–æ•°æ®åº“
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    // åˆå§‹åŒ–ç”¨æˆ·è®°å½•
                    if (!db.users[userId]) {
                        db.users[userId] = {
                            userId: userId,
                            totalSessions: 0,
                            totalHighlights: 0,
                            totalReadingTime: 0,
                            totalExits: 0,
                            createdAt: timestamp,
                            lastActive: timestamp
                        };
                    }
                    
                    // åˆå§‹åŒ–ä¼šè¯è®°å½•
                    if (!db.sessions[sessionId]) {
                        db.sessions[sessionId] = {
                            sessionId: sessionId,
                            userId: userId,
                            startTime: sessionId,
                            endTime: null,
                            highlights: [],
                            readingTime: 0,
                            exits: 0,
                            strokes: 0
                        };
                        db.users[userId].totalSessions++;
                    }
                    
                    // æ ¹æ®è¡Œä¸ºç±»å‹å¤„ç†æ•°æ®
                    switch (action) {
                        case 'highlight':
                            this.saveHighlight(db, record);
                            break;
                        case 'delete_highlight':
                            this.deleteHighlight(db, record);
                            break;
                        case 'batch_delete_highlights':
                            this.batchDeleteHighlights(db, record);
                            break;
                        case 'reading_time_update':
                            this.updateReadingTime(db, record);
                            break;
                        case 'page_exit':
                            this.recordPageExit(db, record);
                            break;
                        default:
                            // é€šç”¨è®°å½•ä¿å­˜
                            if (!db.statistics[userId]) {
                                db.statistics[userId] = [];
                            }
                            db.statistics[userId].push(record);
                    }
                    
                    // æ›´æ–°ç”¨æˆ·æœ€åæ´»è·ƒæ—¶é—´
                    db.users[userId].lastActive = timestamp;
                    
                    // ä¿å­˜æ•°æ®åº“
                    localStorage.setItem(this.dbName, JSON.stringify(db));
                    
                    console.log('ğŸ’¾ å·²ä¿å­˜åˆ°æ•°æ®åº“:', action, data);
                    return record.id;
                } catch (error) {
                    console.error('âŒ ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥:', error);
                    return null;
                }
            }
            
            // ä¿å­˜åˆ’çº¿è®°å½•
            saveHighlight(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // ä¿å­˜åˆ°highlightsè¡¨
                if (!db.highlights[userId]) {
                    db.highlights[userId] = [];
                }
                db.highlights[userId].push(record);
                
                // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
                db.users[userId].totalHighlights++;
                
                // æ›´æ–°ä¼šè¯ç»Ÿè®¡
                db.sessions[sessionId].highlights.push(record.id);
                db.sessions[sessionId].strokes++;
            }
            
            // åˆ é™¤åˆ’çº¿è®°å½•
            deleteHighlight(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // ä»highlightsè¡¨ä¸­ç§»é™¤
                if (db.highlights[userId]) {
                    db.highlights[userId] = db.highlights[userId].filter(h => h.id !== record.data.originalId);
                }
                
                // æ›´æ–°ä¼šè¯ç»Ÿè®¡
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].strokes = Math.max(0, db.sessions[sessionId].strokes - 1);
                }
            }
            
            // æ‰¹é‡åˆ é™¤åˆ’çº¿è®°å½•
            batchDeleteHighlights(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                const deletedCount = record.data.deletedCount;
                
                // æ›´æ–°ä¼šè¯ç»Ÿè®¡
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].strokes = Math.max(0, db.sessions[sessionId].strokes - deletedCount);
                }
            }
            
            // æ›´æ–°é˜…è¯»æ—¶é—´
            updateReadingTime(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // æ›´æ–°ç”¨æˆ·æ€»é˜…è¯»æ—¶é—´
                db.users[userId].totalReadingTime = record.data.totalReadingTime;
                
                // æ›´æ–°ä¼šè¯é˜…è¯»æ—¶é—´
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].readingTime = record.data.sessionReadingTime;
                }
            }
            
            // è®°å½•é¡µé¢é€€å‡º
            recordPageExit(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // æ›´æ–°ç”¨æˆ·æ€»é€€å‡ºæ¬¡æ•°
                db.users[userId].totalExits++;
                
                // æ›´æ–°ä¼šè¯é€€å‡ºæ¬¡æ•°
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].exits++;
                }
            }
            
            // ç”Ÿæˆå”¯ä¸€ID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // å¯¼å‡ºç”¨æˆ·æ•°æ®
            exportUserData(userId = null) {
                try {
                    const targetUserId = userId || this.getCurrentUser();
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    const exportData = {
                        exportId: this.generateId(),
                        exportTime: new Date().toISOString(),
                        userId: targetUserId,
                        userInfo: db.users[targetUserId] || {},
                        sessions: Object.values(db.sessions).filter(s => s.userId === targetUserId),
                        highlights: db.highlights[targetUserId] || [],
                        statistics: db.statistics[targetUserId] || []
                    };
                    
                    // ä¿å­˜å¯¼å‡ºè®°å½•
                    db.exports.push(exportData);
                    localStorage.setItem(this.dbName, JSON.stringify(db));
                    
                    console.log('ğŸ“¤ ç”¨æˆ·æ•°æ®å¯¼å‡ºå®Œæˆ:', exportData);
                    return exportData;
                } catch (error) {
                    console.error('âŒ å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            // è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            getUserStats(userId = null) {
                try {
                    const targetUserId = userId || this.getCurrentUser();
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    return {
                        user: db.users[targetUserId] || {},
                        currentSession: db.sessions[this.getCurrentSession()] || {},
                        totalHighlights: db.highlights[targetUserId]?.length || 0,
                        totalExports: db.exports.filter(e => e.userId === targetUserId).length
                    };
                } catch (error) {
                    console.error('âŒ è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥:', error);
                    return null;
                }
            }
        }
        
        // åˆ›å»ºæ•°æ®åº“å®ä¾‹
        const userDB = new UserBehaviorDatabase();
        
        // å…¼å®¹æ€§å‡½æ•°
        function saveToDatabase(action, data) {
            return userDB.saveBehavior(action, data);
        }
        
        function loadFromDatabase() {
            return userDB.getUserStats();
        }
        
        
        // å¯¼å‡ºç”¨æˆ·æ•°æ®
        function exportUserData() {
            console.log('ğŸ“¤ å¼€å§‹å¯¼å‡ºç”¨æˆ·æ•°æ®');
            const exportData = userDB.exportUserData();
            if (exportData) {
                console.log('ğŸ“¤ å¯¼å‡ºå®Œæˆï¼Œæ•°æ®:', exportData);
                alert('æ•°æ®å¯¼å‡ºå®Œæˆï¼è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†æ•°æ®ã€‚');
            } else {
                console.log('âŒ å¯¼å‡ºå¤±è´¥');
                alert('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼');
            }
        }
        
        // æ˜¾ç¤ºç°è‰²é®ç½©ï¼ˆoverlayï¼‰
        function showOverlay() {
            console.log('ğŸ“± æ˜¾ç¤ºç°è‰²é®ç½©');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰é®ç½©
            const existingOverlay = document.querySelector('.overlay-mask');
            if (existingOverlay) {
                console.log('ğŸ“± é®ç½©å·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º');
                return;
            }
            
            // åˆ›å»ºç°è‰²é®ç½©
            const overlay = document.createElement('div');
            overlay.className = 'overlay-mask';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(157, 157, 157, 0.3);
                z-index: 9998;
                -webkit-backdrop-filter: blur(2px);
                backdrop-filter: blur(2px);
            `;
            
            // åˆ›å»ºåº•éƒ¨å¯¼èˆªæ 
            const bottomBar = document.createElement('div');
            bottomBar.className = 'overlay-bottom-bar';
            bottomBar.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 80px;
                background: rgba(255, 255, 255, 0.95);
                -webkit-backdrop-filter: blur(40%);
                backdrop-filter: blur(40%);
                border-radius: 30px 30px 0 0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 9999;
            `;
            
            // æ·»åŠ å¯¼èˆªå›¾æ ‡
            const icons = ['notebook', 'processing', 'light'];
            icons.forEach((icon, index) => {
                const iconDiv = document.createElement('div');
                iconDiv.className = `overlay-icon ${icon}`;
                iconDiv.style.cssText = `
                    width: 30px;
                    height: 30px;
                    background: #ccc;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                iconDiv.onclick = () => {
                    console.log(`ğŸ“± ç‚¹å‡»äº†${icon}å›¾æ ‡`);
                    if (icon === 'notebook') {
                        // è¿›å…¥æ–‡æœ¬é€‰æ‹©æ¨¡å¼
                        enterTextSelectionMode();
                    } else if (icon === 'processing') {
                        showRecording();
                    } else if (icon === 'light') {
                        console.log('ğŸ“± äº®åº¦è°ƒèŠ‚åŠŸèƒ½');
                    }
                };
                
                bottomBar.appendChild(iconDiv);
            });
            
            // æ·»åŠ ç‚¹å‡»å…³é—­äº‹ä»¶
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    console.log('ğŸ“± ç‚¹å‡»é®ç½©å¤–éƒ¨ï¼Œå…³é—­é®ç½©');
                    closeOverlay();
                }
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(bottomBar);
            
            console.log('ğŸ“± ç°è‰²é®ç½©å·²æ˜¾ç¤º');
        }
        
        // å…³é—­ç°è‰²é®ç½©
        function closeOverlay() {
            console.log('ğŸ“± å…³é—­ç°è‰²é®ç½©');
            
            const overlay = document.querySelector('.overlay-mask');
            const bottomBar = document.querySelector('.overlay-bottom-bar');
            
            if (overlay) overlay.remove();
            if (bottomBar) bottomBar.remove();
            
            console.log('ğŸ“± ç°è‰²é®ç½©å·²å…³é—­');
        }
        
        // æ˜¾ç¤ºrecordingç»Ÿè®¡å¼¹çª—
        
        // æ˜¾ç¤ºè¿›åº¦å¼¹çª—
        function showProgressModal() {
            console.log('ğŸ“Š æ˜¾ç¤ºè¿›åº¦å¼¹çª—');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨overlayæ¨¡å¼ä¸‹
            const overlayContainer = document.querySelector('.overlay-container');
            if (!overlayContainer) {
                console.log('âš ï¸ ä¸åœ¨overlayæ¨¡å¼ï¼Œå…ˆæ‰“å¼€overlay');
                createOverlay();
                // ç­‰å¾…overlayåˆ›å»ºå®Œæˆåå†æ˜¾ç¤ºè¿›åº¦å¼¹çª—
                setTimeout(() => {
                    showProgressModalInOverlay();
                }, 100);
                return;
            }
            
            showProgressModalInOverlay();
        }
        
        // åœ¨overlayä¸­æ˜¾ç¤ºè¿›åº¦å¼¹çª—
        function showProgressModalInOverlay() {
            const progressModal = document.getElementById('progressModal');
            if (progressModal) {
                // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('click', handleProgressModalClick);
                
                // è®¾ç½®æ˜¾ç¤ºçŠ¶æ€ï¼Œä»åº•éƒ¨æ»‘å…¥ï¼ˆæŠ˜å æ•ˆæœï¼‰
                progressModal.style.visibility = 'visible';
                progressModal.style.opacity = '1';
                progressModal.style.zIndex = '10002'; // åœ¨overlayä¹‹ä¸Š
                progressModal.style.transform = 'translateX(-50%) translateY(0)';
                
                // æ›´æ–°é˜…è¯»æ—¶é—´ï¼ˆçœŸå®æ•°æ®ï¼‰
                updateRealReadingTime();
                
                // æ›´æ–°é˜…è¯»è¿›åº¦ï¼ˆå®æ—¶æ•°æ®ï¼‰
                updateRealReadingProgress();
                
                // æ›´æ–°ä¸€å‘¨é˜…è¯»é¢‘æ¬¡ï¼ˆç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼‰
                updateRealWeeklyReadingFrequency();
                
                // åˆå§‹åŒ–è¿›åº¦æ¡æ‹–æ‹½åŠŸèƒ½ï¼ˆé”šå®šåŸæ–‡æœ¬ï¼‰
                initProgressBarWithTextAnchor();
                
                // åˆå§‹åŒ–è¿›åº¦æ¡ä½ç½®
                initProgressBarPosition();
                
                // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
                setTimeout(() => {
                    document.addEventListener('click', handleProgressModalClick);
                }, 100);
            } else {
                console.error('âŒ è¿›åº¦å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°');
            }
        }
        
        // å¤„ç†è¿›åº¦å¼¹çª—ç‚¹å‡»äº‹ä»¶
        function handleProgressModalClick(e) {
            const progressModal = document.getElementById('progressModal');
            if (progressModal && progressModal.style.visibility === 'visible') {
                // æ£€æŸ¥ç‚¹å‡»çš„ç›®æ ‡
                const target = e.target;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å¼¹çª—æœ¬èº«ï¼Œä¸å…³é—­
                if (progressModal.contains(target)) {
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯åº•éƒ¨èœå•æ ï¼Œä¸å…³é—­
                const bottomBar = document.querySelector('.overlay-bottom-bar');
                if (bottomBar && bottomBar.contains(target)) {
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯overlayçš„åº•éƒ¨å¯¼èˆªæ ï¼Œä¸å…³é—­
                const overlayBottomBar = document.querySelector('.bottom-label-bar');
                if (overlayBottomBar && overlayBottomBar.contains(target)) {
                    return;
                }
                
                // å…¶ä»–æƒ…å†µå…³é—­å¼¹çª—
                console.log('ğŸ“± ç‚¹å‡»è¿›åº¦å¼¹çª—å¤–éƒ¨ï¼Œå…³é—­å¼¹çª—');
                hideProgressModal();
                // å…³é—­overlayï¼Œè¿”å›bookNormalé¡µé¢
                closeOverlay();
            }
        }
        
        // éšè—è¿›åº¦å¼¹çª—
        function hideProgressModal() {
            const progressModal = document.getElementById('progressModal');
            if (progressModal) {
                progressModal.style.visibility = 'hidden';
                progressModal.style.opacity = '0';
                progressModal.style.transform = 'translateX(-50%) translateY(100%)';
                
                // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('click', handleProgressModalClick);
            }
        }
        
        // æ›´æ–°é˜…è¯»æ—¶é—´
        function updateReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            // æ›´æ–°æ˜¾ç¤º
            const timeElements = document.querySelectorAll('#progressModal div[style*="font-size: 24px"]');
            if (timeElements.length >= 2) {
                timeElements[0].textContent = hours;
                timeElements[1].textContent = minutes;
            }
        }
        
        // æ›´æ–°é˜…è¯»è¿›åº¦
        function updateReadingProgress() {
            const totalTextLength = document.getElementById('textContent').textContent.length;
            const currentPosition = localStorage.getItem('currentReadingPosition') || 0;
            const progress = Math.round((currentPosition / totalTextLength) * 100);
            
            // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
            const progressElement = document.querySelector('#progressModal div[style*="font-size: 24px"][style*="color: #333333"]');
            if (progressElement) {
                progressElement.textContent = progress;
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            if (progressFill && progressHandle) {
                const percentage = Math.min(100, Math.max(0, progress));
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 15px)`;
            }
        }
        
        // æ›´æ–°ä¸€å‘¨é˜…è¯»é¢‘æ¬¡
        function updateWeeklyReadingFrequency() {
            const weeklyData = JSON.parse(localStorage.getItem('weeklyReadingData') || '[]');
            const bars = document.querySelectorAll('#progressModal div[style*="width: 3px"][style*="background: #19191B"]');
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            if (weeklyData.length === 0) {
                const defaultHeights = [20, 5, 12, 1, 16, 12, 22];
                bars.forEach((bar, index) => {
                    if (index < defaultHeights.length) {
                        bar.style.height = defaultHeights[index] + 'px';
                    }
                });
                return;
            }
            
            // æ ¹æ®å®é™…æ•°æ®è®¾ç½®é«˜åº¦
            bars.forEach((bar, index) => {
                if (index < weeklyData.length) {
                    const readingTime = weeklyData[index]; // åˆ†é’Ÿ
                    let height;
                    if (readingTime >= 60) {
                        height = 20; // è¶…è¿‡1å°æ—¶
                    } else if (readingTime >= 10) {
                        height = 12; // 10-60åˆ†é’Ÿ
                    } else {
                        height = 6; // å°äº10åˆ†é’Ÿ
                    }
                    bar.style.height = height + 'px';
                }
            });
        }
        
        // åˆå§‹åŒ–è¿›åº¦æ¡æ‹–æ‹½åŠŸèƒ½
        function initProgressBar() {
            const progressHandle = document.getElementById('progressHandle');
            const progressFill = document.getElementById('progressFill');
            const progressContainer = progressHandle.parentElement;
            
            if (!progressHandle || !progressFill || !progressContainer) return;
            
            let isDragging = false;
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            progressHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const containerRect = progressContainer.getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                
                // æ›´æ–°è¿›åº¦æ¡
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 15px)`;
                
                // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
                const progressElement = document.querySelector('#progressModal div[style*="font-size: 24px"][style*="color: #333333"]');
                if (progressElement) {
                    progressElement.textContent = Math.round(percentage);
                }
                
                // å®šä½åˆ°å¯¹åº”æ–‡æœ¬ä½ç½®
                scrollToTextPosition(percentage);
            });
            
            // é¼ æ ‡æŠ¬èµ·äº‹ä»¶
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    // ä¿å­˜å½“å‰ä½ç½®
                    const percentage = parseFloat(progressFill.style.width);
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
        }
        
        // æ ¹æ®è¿›åº¦ç™¾åˆ†æ¯”æ»šåŠ¨åˆ°å¯¹åº”æ–‡æœ¬ä½ç½®
        function scrollToTextPosition(percentage) {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            const scrollHeight = textContent.scrollHeight - textContent.clientHeight;
            const targetScrollTop = (scrollHeight * percentage) / 100;
            
            textContent.scrollTo({
                top: targetScrollTop,
                behavior: 'smooth'
            });
        }
        
        // åˆå§‹åŒ–ä¸€å‘¨é˜…è¯»æ•°æ®ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰
        function initWeeklyReadingData() {
            const weeklyData = localStorage.getItem('weeklyReadingData');
            if (!weeklyData) {
                // è®¾ç½®ç¤ºä¾‹æ•°æ®ï¼š7å¤©çš„é˜…è¯»æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
                const sampleData = [120, 30, 75, 5, 90, 60, 135]; // å¯¹åº”è®¾è®¡ç¨¿ä¸­çš„é«˜åº¦
                localStorage.setItem('weeklyReadingData', JSON.stringify(sampleData));
            }
        }
        
        // æ›´æ–°å½“å‰é˜…è¯»ä½ç½®
        function updateCurrentReadingPosition() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            const scrollTop = textContent.scrollTop;
            const scrollHeight = textContent.scrollHeight - textContent.clientHeight;
            const percentage = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            
            localStorage.setItem('currentReadingPosition', percentage);
        }
        
        // æ›´æ–°çœŸå®é˜…è¯»æ—¶é—´
        function updateRealReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            const hoursElement = document.getElementById('readingHours');
            const minutesElement = document.getElementById('readingMinutes');
            
            if (hoursElement) hoursElement.textContent = hours;
            if (minutesElement) minutesElement.textContent = minutes;
        }
        
        // æ›´æ–°çœŸå®é˜…è¯»è¿›åº¦
        function updateRealReadingProgress() {
            const readingContent = document.getElementById('readingContent');
            if (!readingContent) return;
            
            const scrollTop = readingContent.scrollTop;
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const percentage = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
            
            const progressElement = document.getElementById('readingProgress');
            if (progressElement) {
                progressElement.textContent = percentage;
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            if (progressFill && progressHandle) {
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
            }
            
            // ä¿å­˜å½“å‰è¿›åº¦åˆ°localStorage
            localStorage.setItem('currentReadingPosition', percentage);
        }
        
        // æ›´æ–°çœŸå®ä¸€å‘¨é˜…è¯»é¢‘æ¬¡
        function updateRealWeeklyReadingFrequency() {
            // è·å–è¿‡å»7å¤©çš„é˜…è¯»æ•°æ®
            const weeklyData = JSON.parse(localStorage.getItem('weeklyReadingData') || '[]');
            const bars = document.querySelectorAll('#weeklyBars div');
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
            if (weeklyData.length === 0) {
                const defaultHeights = [8, 12, 6, 14, 18, 10, 16];
                bars.forEach((bar, index) => {
                    if (index < defaultHeights.length) {
                        bar.style.height = defaultHeights[index] + 'px';
                    }
                });
                return;
            }
            
            // æ ¹æ®å®é™…æ•°æ®è®¾ç½®é«˜åº¦
            bars.forEach((bar, index) => {
                if (index < weeklyData.length) {
                    const readingTime = weeklyData[index]; // åˆ†é’Ÿ
                    let height;
                    if (readingTime >= 60) {
                        height = 18; // è¶…è¿‡1å°æ—¶
                    } else if (readingTime >= 10) {
                        height = 12; // 10-60åˆ†é’Ÿ
                    } else {
                        height = 6; // å°äº10åˆ†é’Ÿ
                    }
                    bar.style.height = height + 'px';
                }
            });
        }
        
        // åˆå§‹åŒ–è¿›åº¦æ¡æ‹–æ‹½åŠŸèƒ½ï¼ˆé”šå®šåŸæ–‡æœ¬ï¼‰
        function initProgressBarWithTextAnchor() {
            const progressHandle = document.getElementById('progressHandle');
            const progressFill = document.getElementById('progressFill');
            const progressContainer = progressHandle.parentElement;
            
            if (!progressHandle || !progressFill || !progressContainer) return;
            
            let isDragging = false;
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            progressHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const containerRect = progressContainer.getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                
                // æ›´æ–°è¿›åº¦æ¡
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
                
                // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
                const progressElement = document.getElementById('readingProgress');
                if (progressElement) {
                    progressElement.textContent = Math.round(percentage);
                }
                
                // é”šå®šåˆ°åŸæ–‡æœ¬ä½ç½®
                anchorToTextPosition(percentage);
            });
            
            // é¼ æ ‡æŠ¬èµ·äº‹ä»¶
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    // ä¿å­˜å½“å‰ä½ç½®
                    const percentage = parseFloat(progressFill.style.width);
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
            
            // ç‚¹å‡»è¿›åº¦æ¡è½¨é“ä¹Ÿå¯ä»¥è·³è½¬
            progressContainer.addEventListener('click', function(e) {
                if (e.target === progressContainer || e.target === progressFill) {
                    const containerRect = progressContainer.getBoundingClientRect();
                    const x = e.clientX - containerRect.left;
                    const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    progressFill.style.width = percentage + '%';
                    progressHandle.style.left = `calc(${percentage}% - 14px)`;
                    
                    // æ›´æ–°ç™¾åˆ†æ¯”æ˜¾ç¤º
                    const progressElement = document.getElementById('readingProgress');
                    if (progressElement) {
                        progressElement.textContent = Math.round(percentage);
                    }
                    
                    // é”šå®šåˆ°åŸæ–‡æœ¬ä½ç½®
                    anchorToTextPosition(percentage);
                    
                    // ä¿å­˜å½“å‰ä½ç½®
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
        }
        
        // é”šå®šåˆ°æ–‡æœ¬ä½ç½®
        function anchorToTextPosition(percentage) {
            // ä½¿ç”¨readingContentä½œä¸ºä¸»è¦æ»šåŠ¨å®¹å™¨
            const readingContent = document.getElementById('readingContent');
            
            if (!readingContent) {
                console.warn('æœªæ‰¾åˆ°readingContentå®¹å™¨');
                return;
            }
            
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const targetScrollTop = (scrollHeight * percentage) / 100;
            
            console.log(`ğŸ“– è·³è½¬åˆ°æ–‡æœ¬ä½ç½®: ${percentage}% (${targetScrollTop}px)`);
            console.log(`ğŸ“– å®¹å™¨ä¿¡æ¯: scrollHeight=${readingContent.scrollHeight}, clientHeight=${readingContent.clientHeight}, å¯æ»šåŠ¨é«˜åº¦=${scrollHeight}`);
            
            readingContent.scrollTo({
                top: targetScrollTop,
                behavior: 'smooth'
            });
        }
        
        // åˆå§‹åŒ–è¿›åº¦æ¡ä½ç½®
        function initProgressBarPosition() {
            // ä½¿ç”¨readingContentä½œä¸ºä¸»è¦æ»šåŠ¨å®¹å™¨
            const readingContent = document.getElementById('readingContent');
            
            if (!readingContent) {
                console.warn('æœªæ‰¾åˆ°readingContentå®¹å™¨ï¼Œæ— æ³•åˆå§‹åŒ–è¿›åº¦æ¡ä½ç½®');
                return;
            }
            
            const scrollTop = readingContent.scrollTop;
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const percentage = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
            
            console.log(`ğŸ“Š åˆå§‹åŒ–è¿›åº¦æ¡ä½ç½®: ${percentage}%`);
            console.log(`ğŸ“Š å®¹å™¨ä¿¡æ¯: scrollTop=${scrollTop}, scrollHeight=${readingContent.scrollHeight}, clientHeight=${readingContent.clientHeight}, å¯æ»šåŠ¨é«˜åº¦=${scrollHeight}`);
            
            // æ›´æ–°è¿›åº¦æ¡æ˜¾ç¤º
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            const progressElement = document.getElementById('readingProgress');
            
            if (progressFill && progressHandle) {
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
            }
            
            if (progressElement) {
                progressElement.textContent = percentage;
            }
        }
        
        // åˆå§‹åŒ–ç•Œé¢åœç•™æ—¶é—´è®°å½•
        function initPageStayTime() {
            // è®°å½•é¡µé¢è¿›å…¥æ—¶é—´
            const pageEnterTime = Date.now();
            localStorage.setItem('pageEnterTime', pageEnterTime);
            
            console.log('â° å¼€å§‹è®°å½•ç•Œé¢åœç•™æ—¶é—´ï¼Œé¡µé¢è¿›å…¥æ—¶é—´:', new Date(pageEnterTime).toLocaleTimeString());
            
            // åˆå§‹åŒ–é€€å‡ºè®°å½•åŠŸèƒ½
            initExitTracking();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡åœç•™æ—¶é—´
            const timeInterval = setInterval(() => {
                const currentTime = Date.now();
                const stayTime = Math.floor((currentTime - pageEnterTime) / 1000); // ç§’
                
                // æ›´æ–°reading time
                localStorage.setItem('readingTime', stayTime);
                
                // æ›´æ–°processingå¼¹çª—ä¸­çš„æ—¶é—´æ˜¾ç¤º
                updateRealReadingTime();
                
                // æ›´æ–°recordingå¼¹çª—ä¸­çš„æ—¶é—´æ˜¾ç¤º
                updateRecordingReadingTime();
                
            }, 1000);
            
            // é¡µé¢å¸è½½æ—¶ä¿å­˜æœ€ç»ˆæ—¶é—´
            window.addEventListener('beforeunload', function() {
                const finalTime = Math.floor((Date.now() - pageEnterTime) / 1000);
                localStorage.setItem('readingTime', finalTime);
                clearInterval(timeInterval);
            });
        }
        
        // åˆå§‹åŒ–é€€å‡ºè·Ÿè¸ªåŠŸèƒ½
        function initExitTracking() {
            let isPageVisible = true;
            let exitStartTime = null;
            let exitCount = parseInt(localStorage.getItem('exitCount') || '0');
            let isTrackingExit = false; // é˜²æ­¢é‡å¤è®¡æ•°
            let isInitialLoad = true; // æ ‡è®°æ˜¯å¦ä¸ºåˆå§‹åŠ è½½
            
            console.log('ğŸ“± åˆå§‹åŒ–é¡µé¢é€€å‡ºè·Ÿè¸ªåŠŸèƒ½ï¼Œå½“å‰é€€å‡ºæ¬¡æ•°:', exitCount);
            
            // å°†å˜é‡ä¿å­˜åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿åœ¨beforeunloadäº‹ä»¶ä¸­èƒ½è®¿é—®
            window.exitTrackingState = {
                isPageVisible,
                exitStartTime,
                exitCount,
                isTrackingExit,
                isInitialLoad
            };
            
            // å»¶è¿Ÿå¯åŠ¨é€€å‡ºè·Ÿè¸ªï¼Œé¿å…é¡µé¢åŠ è½½æ—¶çš„è¯¯è§¦å‘
            setTimeout(() => {
                isInitialLoad = false;
                window.exitTrackingState.isInitialLoad = false; // åŒæ­¥æ›´æ–°å…¨å±€çŠ¶æ€
                console.log('ğŸ“± é€€å‡ºè·Ÿè¸ªå·²æ¿€æ´»ï¼Œå¼€å§‹ç›‘å¬é¡µé¢çŠ¶æ€');
            }, 1000); // 1ç§’åæ¿€æ´»
            
            // é¡µé¢å¯è§æ€§å˜åŒ–äº‹ä»¶
            document.addEventListener('visibilitychange', function() {
                console.log('ğŸ“± é¡µé¢å¯è§æ€§å˜åŒ–:', document.visibilityState);
                console.log('ğŸ“± å½“å‰çŠ¶æ€:', { isPageVisible, isTrackingExit, isInitialLoad, exitStartTime: exitStartTime ? new Date(exitStartTime).toLocaleTimeString() : null });
                
                if (document.hidden) {
                    // é¡µé¢è¢«éšè—ï¼ˆç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨æˆ–é¡µé¢å¯¼èˆªï¼‰
                    if (isPageVisible && !isTrackingExit && !isInitialLoad) {
                        isPageVisible = false;
                        isTrackingExit = true;
                        exitStartTime = Date.now();
                        console.log('ğŸ“± é¡µé¢å¤±å»ç„¦ç‚¹ï¼Œå¼€å§‹è®°å½•é€€å‡ºæ—¶é—´ï¼Œæ—¶é—´æˆ³:', new Date(exitStartTime).toLocaleTimeString());
                        
                        // æ›´æ–°å…¨å±€çŠ¶æ€
                        window.exitTrackingState.isPageVisible = isPageVisible;
                        window.exitTrackingState.isTrackingExit = isTrackingExit;
                        window.exitTrackingState.exitStartTime = exitStartTime;
                    } else {
                        console.log('ğŸ“± ä¸æ»¡è¶³å¤±å»ç„¦ç‚¹è®°å½•æ¡ä»¶:', { isPageVisible, isTrackingExit, isInitialLoad });
                    }
                } else {
                    // é¡µé¢é‡æ–°å¯è§
                    if (!isPageVisible && exitStartTime && isTrackingExit) {
                        isPageVisible = true;
                        isTrackingExit = false;
                        const exitDuration = Math.floor((Date.now() - exitStartTime) / 1000);
                        
                        console.log(`ğŸ“± é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œé€€å‡ºæ—¶é•¿: ${exitDuration}ç§’`);
                        
                        // åªæœ‰é€€å‡ºæ—¶é•¿å¤§äº1ç§’æ‰è®°å½•ï¼ˆé¿å…è¯¯è§¦å‘ï¼‰
                        if (exitDuration >= 1) {
                            exitCount++;
                            
                            // è®°å½•é€€å‡ºä¿¡æ¯
                            const exitRecord = {
                                timestamp: new Date().toISOString(),
                                duration: exitDuration,
                                exitNumber: exitCount,
                                exitStartTime: new Date(exitStartTime).toISOString(),
                                exitEndTime: new Date().toISOString()
                            };
                            
                            // ä¿å­˜é€€å‡ºè®°å½•
                            let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                            exitHistory.push(exitRecord);
                            localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                            localStorage.setItem('exitCount', exitCount.toString());
                            
                            console.log(`ğŸ“± è®°å½•é€€å‡ºï¼Œæ€»é€€å‡ºæ¬¡æ•°: ${exitCount}`);
                            console.log('ğŸ“± é€€å‡ºè®°å½•è¯¦æƒ…:', exitRecord);
                            
                            // æ›´æ–°recordingå¼¹çª—ä¸­çš„é€€å‡ºæ¬¡æ•°æ˜¾ç¤º
                            updateRecordingExitCount();
                        } else {
                            console.log(`ğŸ“± é€€å‡ºæ—¶é•¿è¿‡çŸ­(${exitDuration}ç§’)ï¼Œä¸è®°å½•é€€å‡º`);
                        }
                        
                        exitStartTime = null;
                        
                        // æ›´æ–°å…¨å±€çŠ¶æ€
                        window.exitTrackingState.isPageVisible = isPageVisible;
                        window.exitTrackingState.isTrackingExit = isTrackingExit;
                        window.exitTrackingState.exitStartTime = exitStartTime;
                        window.exitTrackingState.exitCount = exitCount;
                    } else {
                        console.log('ğŸ“± ä¸æ»¡è¶³é‡æ–°è·å¾—ç„¦ç‚¹è®°å½•æ¡ä»¶:', { isPageVisible, exitStartTime: exitStartTime ? new Date(exitStartTime).toLocaleTimeString() : null, isTrackingExit });
                    }
                }
            });
            
            // é¡µé¢å¸è½½äº‹ä»¶ï¼ˆæ£€æµ‹é¡µé¢å¯¼èˆªï¼‰
            window.addEventListener('beforeunload', function() {
                const state = window.exitTrackingState;
                console.log('ğŸ“± é¡µé¢å³å°†å¸è½½ï¼Œæ£€æŸ¥é€€å‡ºçŠ¶æ€:', { 
                    isTrackingExit: state.isTrackingExit, 
                    exitStartTime: state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : null,
                    isInitialLoad: state.isInitialLoad
                });
                
                if (state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                    const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                    console.log(`ğŸ“± é¡µé¢å¸è½½ï¼Œé€€å‡ºæ—¶é•¿: ${exitDuration}ç§’`);
                    
                    if (exitDuration >= 1) {
                        const newExitCount = state.exitCount + 1;
                        
                        // è®°å½•é€€å‡ºä¿¡æ¯
                        const exitRecord = {
                            timestamp: new Date().toISOString(),
                            duration: exitDuration,
                            exitNumber: newExitCount,
                            exitStartTime: new Date(state.exitStartTime).toISOString(),
                            exitEndTime: new Date().toISOString(),
                            reason: 'page_unload'
                        };
                        
                        // ä¿å­˜é€€å‡ºè®°å½•
                        let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                        exitHistory.push(exitRecord);
                        localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                        localStorage.setItem('exitCount', newExitCount.toString());
                        
                        console.log(`ğŸ“± é¡µé¢å¸è½½è®°å½•é€€å‡ºï¼Œæ€»é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                        console.log('ğŸ“± é¡µé¢å¸è½½é€€å‡ºè®°å½•è¯¦æƒ…:', exitRecord);
                    } else {
                        console.log(`ğŸ“± é¡µé¢å¸è½½é€€å‡ºæ—¶é•¿è¿‡çŸ­(${exitDuration}ç§’)ï¼Œä¸è®°å½•é€€å‡º`);
                    }
                } else {
                    console.log('ğŸ“± é¡µé¢å¸è½½æ—¶æœªåœ¨è·Ÿè¸ªé€€å‡ºçŠ¶æ€æˆ–ä»åœ¨åˆå§‹åŠ è½½ä¸­');
                }
            });
            
            
            // é¡µé¢éšè—äº‹ä»¶ï¼ˆæ£€æµ‹é¡µé¢å¯¼èˆªçš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
            window.addEventListener('pagehide', function() {
                const state = window.exitTrackingState;
                console.log('ğŸ“± é¡µé¢éšè—ï¼Œæ£€æŸ¥é€€å‡ºçŠ¶æ€:', { 
                    isTrackingExit: state.isTrackingExit, 
                    exitStartTime: state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : null,
                    isInitialLoad: state.isInitialLoad
                });
                
                if (state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                    const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                    console.log(`ğŸ“± é¡µé¢éšè—ï¼Œé€€å‡ºæ—¶é•¿: ${exitDuration}ç§’`);
                    
                    if (exitDuration >= 1) {
                        const newExitCount = state.exitCount + 1;
                        
                        // è®°å½•é€€å‡ºä¿¡æ¯
                        const exitRecord = {
                            timestamp: new Date().toISOString(),
                            duration: exitDuration,
                            exitNumber: newExitCount,
                            exitStartTime: new Date(state.exitStartTime).toISOString(),
                            exitEndTime: new Date().toISOString(),
                            reason: 'page_hide'
                        };
                        
                        // ä¿å­˜é€€å‡ºè®°å½•
                        let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                        exitHistory.push(exitRecord);
                        localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                        localStorage.setItem('exitCount', newExitCount.toString());
                        
                        console.log(`ğŸ“± é¡µé¢éšè—è®°å½•é€€å‡ºï¼Œæ€»é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                        console.log('ğŸ“± é¡µé¢éšè—é€€å‡ºè®°å½•è¯¦æƒ…:', exitRecord);
                    } else {
                        console.log(`ğŸ“± é¡µé¢éšè—é€€å‡ºæ—¶é•¿è¿‡çŸ­(${exitDuration}ç§’)ï¼Œä¸è®°å½•é€€å‡º`);
                    }
                } else {
                    console.log('ğŸ“± é¡µé¢éšè—æ—¶æœªåœ¨è·Ÿè¸ªé€€å‡ºçŠ¶æ€æˆ–ä»åœ¨åˆå§‹åŠ è½½ä¸­');
                }
            });
        }
        
        // æ›´æ–°recordingå¼¹çª—ä¸­çš„é€€å‡ºæ¬¡æ•°æ˜¾ç¤º
        function updateRecordingExitCount() {
            const exitCount = parseInt(localStorage.getItem('exitCount') || '0');
            
            console.log(`ğŸ“Š æ›´æ–°é€€å‡ºæ¬¡æ•°æ˜¾ç¤º: ${exitCount}`);
            
            // æ›´æ–°statsModalä¸­çš„é€€å‡ºæ¬¡æ•°æ˜¾ç¤º
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const exitElement = statsModal.querySelector('#exitCount');
                if (exitElement) {
                    exitElement.textContent = exitCount;
                    console.log('âœ… å·²æ›´æ–°statsModalä¸­çš„é€€å‡ºæ¬¡æ•°');
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°statsModalä¸­çš„#exitCountå…ƒç´ ');
                }
            }
            
            // æ›´æ–°simpleRecordingModalä¸­çš„é€€å‡ºæ¬¡æ•°æ˜¾ç¤º
            const simpleModal = document.getElementById('simpleRecordingModal');
            if (simpleModal && simpleModal.style.display === 'block') {
                const simpleExitElement = simpleModal.querySelector('#exitCount');
                if (simpleExitElement) {
                    simpleExitElement.textContent = exitCount;
                    console.log('âœ… å·²æ›´æ–°simpleRecordingModalä¸­çš„é€€å‡ºæ¬¡æ•°');
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°simpleRecordingModalä¸­çš„#exitCountå…ƒç´ ');
                }
            }
            
            // æ›´æ–°å…¨å±€å˜é‡
            window.exitCount = exitCount;
        }
        
        
        // é‡ç½®é€€å‡ºæ•°æ®
        
        
        
        // é¡µé¢å¯¼èˆªé€€å‡ºè®°å½•å‡½æ•°ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
        function recordPageNavigationExit() {
            const state = window.exitTrackingState;
            console.log('ğŸ“± é¡µé¢å¯¼èˆªé€€å‡ºè®°å½•ï¼Œæ£€æŸ¥çŠ¶æ€:', { 
                isTrackingExit: state ? state.isTrackingExit : 'stateä¸å­˜åœ¨', 
                exitStartTime: state && state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : 'æ— å¼€å§‹æ—¶é—´',
                isInitialLoad: state ? state.isInitialLoad : 'stateä¸å­˜åœ¨',
                state: state
            });
            
            // å¦‚æœé€€å‡ºè·Ÿè¸ªå·²ç»æ¿€æ´»ï¼Œä½¿ç”¨ç°æœ‰çš„é€€å‡ºæ—¶é•¿
            if (state && state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                console.log(`ğŸ“± é¡µé¢å¯¼èˆªï¼Œé€€å‡ºæ—¶é•¿: ${exitDuration}ç§’`);
                
                if (exitDuration >= 1) {
                    // ç›´æ¥ä»localStorageè¯»å–å½“å‰é€€å‡ºæ¬¡æ•°
                    const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                    const newExitCount = currentExitCount + 1;
                    
                    console.log(`ğŸ“± å½“å‰é€€å‡ºæ¬¡æ•°: ${currentExitCount}, æ–°é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                    
                    // è®°å½•é€€å‡ºä¿¡æ¯
                    const exitRecord = {
                        timestamp: new Date().toISOString(),
                        duration: exitDuration,
                        exitNumber: newExitCount,
                        exitStartTime: new Date(state.exitStartTime).toISOString(),
                        exitEndTime: new Date().toISOString(),
                        reason: 'page_navigation'
                    };
                    
                    // ä¿å­˜é€€å‡ºè®°å½•
                    let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                    exitHistory.push(exitRecord);
                    localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                    localStorage.setItem('exitCount', newExitCount.toString());
                    
                    console.log(`ğŸ“± é¡µé¢å¯¼èˆªè®°å½•é€€å‡ºï¼Œæ€»é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                    console.log('ğŸ“± é¡µé¢å¯¼èˆªé€€å‡ºè®°å½•è¯¦æƒ…:', exitRecord);
                    console.log('ğŸ“± localStorageå†™å…¥åéªŒè¯:', {
                        exitCount: localStorage.getItem('exitCount'),
                        exitHistoryLength: JSON.parse(localStorage.getItem('exitHistory') || '[]').length
                    });
                    
                    return true; // æˆåŠŸè®°å½•
                } else {
                    console.log(`ğŸ“± é¡µé¢å¯¼èˆªé€€å‡ºæ—¶é•¿è¿‡çŸ­(${exitDuration}ç§’)ï¼Œä¸è®°å½•é€€å‡º`);
                }
            } 
            // å¦‚æœé€€å‡ºè·Ÿè¸ªæ²¡æœ‰æ¿€æ´»ï¼Œä½†é¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œåˆ™ç›´æ¥è®°å½•é¡µé¢å¯¼èˆªé€€å‡º
            else if (state && !state.isInitialLoad) {
                console.log('ğŸ“± é¡µé¢å¯¼èˆªæ—¶é€€å‡ºè·Ÿè¸ªæœªæ¿€æ´»ï¼Œç›´æ¥è®°å½•é¡µé¢å¯¼èˆªé€€å‡º');
                
                // ç›´æ¥ä»localStorageè¯»å–å½“å‰é€€å‡ºæ¬¡æ•°
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                const newExitCount = currentExitCount + 1;
                
                console.log(`ğŸ“± å½“å‰é€€å‡ºæ¬¡æ•°: ${currentExitCount}, æ–°é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                
                // è®°å½•é€€å‡ºä¿¡æ¯ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºé€€å‡ºå¼€å§‹å’Œç»“æŸæ—¶é—´ï¼‰
                const now = Date.now();
                const exitRecord = {
                    timestamp: new Date().toISOString(),
                    duration: 1, // é¡µé¢å¯¼èˆªé€€å‡ºå›ºå®šä¸º1ç§’
                    exitNumber: newExitCount,
                    exitStartTime: new Date(now - 1000).toISOString(), // 1ç§’å‰
                    exitEndTime: new Date().toISOString(),
                    reason: 'page_navigation'
                };
                
                // ä¿å­˜é€€å‡ºè®°å½•
                let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                exitHistory.push(exitRecord);
                localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                localStorage.setItem('exitCount', newExitCount.toString());
                
                console.log(`ğŸ“± é¡µé¢å¯¼èˆªç›´æ¥è®°å½•é€€å‡ºï¼Œæ€»é€€å‡ºæ¬¡æ•°: ${newExitCount}`);
                console.log('ğŸ“± é¡µé¢å¯¼èˆªé€€å‡ºè®°å½•è¯¦æƒ…:', exitRecord);
                console.log('ğŸ“± localStorageå†™å…¥åéªŒè¯:', {
                    exitCount: localStorage.getItem('exitCount'),
                    exitHistoryLength: JSON.parse(localStorage.getItem('exitHistory') || '[]').length
                });
                
                return true; // æˆåŠŸè®°å½•
            } else {
                console.log('ğŸ“± é¡µé¢å¯¼èˆªæ—¶æœªåœ¨è·Ÿè¸ªé€€å‡ºçŠ¶æ€æˆ–ä»åœ¨åˆå§‹åŠ è½½ä¸­');
                console.log('ğŸ“± è¯¦ç»†çŠ¶æ€æ£€æŸ¥:', {
                    stateå­˜åœ¨: !!state,
                    isTrackingExit: state ? state.isTrackingExit : 'N/A',
                    exitStartTimeå­˜åœ¨: !!(state && state.exitStartTime),
                    isInitialLoad: state ? state.isInitialLoad : 'N/A'
                });
            }
            return false; // æœªè®°å½•
        }
        
        // æ›´æ–°recordingå¼¹çª—ä¸­çš„é˜…è¯»æ—¶é—´
        function updateRecordingReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            // æ›´æ–°statsModalä¸­çš„æ—¶é—´æ˜¾ç¤º
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const hoursElement = statsModal.querySelector('#readingHours');
                const minutesElement = statsModal.querySelector('#readingMinutes');
                if (hoursElement) hoursElement.textContent = hours;
                if (minutesElement) minutesElement.textContent = minutes;
            }
            
            // æ›´æ–°simpleRecordingModalä¸­çš„æ—¶é—´æ˜¾ç¤º
            const simpleModal = document.getElementById('simpleRecordingModal');
            if (simpleModal && simpleModal.style.display === 'block') {
                const simpleHoursElement = simpleModal.querySelector('#simpleReadingHours');
                const simpleMinutesElement = simpleModal.querySelector('#simpleReadingMinutes');
                if (simpleHoursElement) simpleHoursElement.textContent = hours;
                if (simpleMinutesElement) simpleMinutesElement.textContent = minutes;
            }
        }

        function showRecording() {
            console.log('ğŸ“Š æ˜¾ç¤ºrecordingç»Ÿè®¡å¼¹çª—');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¼¹çª—
            const existingModal = document.getElementById('statsModal');
            if (existingModal) {
                console.log('ğŸ“Š recordingå¼¹çª—å·²å­˜åœ¨ï¼Œä¸é‡å¤åˆ›å»º');
                return;
            }
            
            // è®¾ç½®åˆ›å»ºæ ‡è®°
            window.isCreatingModal = true;
            
            // åˆ›å»ºç»Ÿè®¡å¼¹çª—
            const modal = document.createElement('div');
            modal.id = 'statsModal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 350px;
                height: 400px;
                background: white;
                border-radius: 20px;
                z-index: 10000;
                display: block;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 20px;">é˜…è¯»ç»Ÿè®¡</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">é˜…è¯»æ—¶é•¿</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${Math.floor(readingTime / 60)}å°æ—¶${readingTime % 60}åˆ†é’Ÿ</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">é€€å‡ºæ¬¡æ•°</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${exitCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">åˆ’çº¿æ¬¡æ•°</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${totalStrokes}</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeRecording()" style="background: #A88DCB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ¸…é™¤åˆ›å»ºæ ‡è®°
            setTimeout(() => {
                window.isCreatingModal = false;
            }, 100);
            
            console.log('ğŸ“Š recordingç»Ÿè®¡å¼¹çª—å·²æ˜¾ç¤º');
        }
        
        // å…³é—­recordingç»Ÿè®¡å¼¹çª— - è¿”å›åˆ°ç°è‰²é®ç½©
        function closeRecording() {
            console.log('ğŸ“Š å…³é—­recordingç»Ÿè®¡å¼¹çª—ï¼Œè¿”å›åˆ°ç°è‰²é®ç½©');
            
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                console.log('âœ… recordingå¼¹çª—å·²å…³é—­ï¼Œä¿æŒåœ¨overlayæ¨¡å¼');
            }
        }
        
        // æ›´æ–°recordingé¡µé¢çš„strokesè®¡æ•°
        function updateRecordingStrokes() {
            // æ›´æ–°totalStrokeså˜é‡
            totalStrokes = highlightedElements.length;
            
            // å¦‚æœrecordingå¼¹çª—å·²æ‰“å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display !== 'none') {
                const strokesElement = statsModal.querySelector('.stats-value:last-child');
                if (strokesElement) {
                    strokesElement.textContent = totalStrokes;
                }
            }
            
            console.log('ğŸ“Š å·²æ›´æ–°recordingé¡µé¢çš„strokesè®¡æ•°:', totalStrokes);
        }
        
        
        
        
        // è¿›å…¥æ–‡æœ¬é€‰æ‹©æ¨¡å¼
        function enterTextSelectionMode() {
            console.log('ğŸ“ æ˜¾ç¤ºç¬”è®°é¡µé¢');
            
            // å…³é—­ç°è‰²é®ç½©
            closeOverlay();
            
            // æ˜¾ç¤ºç¬”è®°æ¨¡æ€æ¡†
            showNotesModal();
        }
        
        // æ˜¾ç¤ºç¬”è®°æ¨¡æ€æ¡†
        function showNotesModal() {
            console.log('ğŸ“ æ˜¾ç¤ºç¬”è®°æ¨¡æ€æ¡†');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨æ¨¡æ€æ¡†
            const existingModal = document.getElementById('notesModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // è·å–ç¬”è®°æ•°æ®
            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
            console.log('ğŸ“ å½“å‰ç¬”è®°æ•°é‡:', notes.length);
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'notesModal';
            modal.className = 'notes-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // åˆ›å»ºæ¨¡æ€æ¡†å†…å®¹
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                width: 428px;
                height: 690px;
                background: white;
                border-radius: 20px;
                padding: 20px;
                position: relative;
                overflow: hidden;
            `;
            
            // åˆ›å»ºæ ‡é¢˜æ 
            const titleBar = document.createElement('div');
            titleBar.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            `;
            
            const title = document.createElement('h2');
            title.textContent = 'æˆ‘çš„ç¬”è®°';
            title.style.cssText = `
                margin: 0;
                font-size: 18px;
                color: #333;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = 'Ã—';
            closeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => {
                modal.remove();
            };
            
            titleBar.appendChild(title);
            titleBar.appendChild(closeBtn);
            
            // åˆ›å»ºç¬”è®°åˆ—è¡¨å®¹å™¨
            const notesList = document.createElement('div');
            notesList.style.cssText = `
                height: 580px;
                overflow-y: auto;
                padding-right: 10px;
            `;
            
            if (notes.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.style.cssText = `
                    text-align: center;
                    color: #999;
                    margin-top: 100px;
                    font-size: 16px;
                `;
                emptyState.innerHTML = `
                    <div>æš‚æ— ç¬”è®°</div>
                    <div style="font-size: 14px; margin-top: 10px;">é•¿æŒ‰æ–‡å­—æ®µè½å¯ä»¥æ·»åŠ ç¬”è®°</div>
                `;
                notesList.appendChild(emptyState);
            } else {
                notes.forEach((note, index) => {
                    const noteItem = document.createElement('div');
                    noteItem.style.cssText = `
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        border-left: 4px solid #A88DCB;
                    `;
                    
                    const noteText = document.createElement('div');
                    noteText.textContent = note.text;
                    noteText.style.cssText = `
                        font-size: 14px;
                        line-height: 1.5;
                        color: #333;
                        margin-bottom: 8px;
                    `;
                    
                    const noteTime = document.createElement('div');
                    noteTime.textContent = note.timestamp;
                    noteTime.style.cssText = `
                        font-size: 12px;
                        color: #666;
                    `;
                    
                    noteItem.appendChild(noteText);
                    noteItem.appendChild(noteTime);
                    notesList.appendChild(noteItem);
                });
            }
            
            modalContent.appendChild(titleBar);
            modalContent.appendChild(notesList);
            modal.appendChild(modalContent);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            document.body.appendChild(modal);
            
            console.log('ğŸ“ ç¬”è®°æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        }
        
        // é¡µé¢è·³è½¬åŠŸèƒ½
        function goBack() {
            // è®°å½•é¡µé¢å¯¼èˆªé€€å‡º
            recordPageNavigationExit();
            // è¿”å›Detailsé¡µé¢
            window.location.href = 'details.html';
        }
        
        
        
        
        
        
        
        
        // ä»é€‰æ‹©åˆ›å»ºåˆ’çº¿ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å…¼å®¹æ€§ï¼‰
        
        // å–æ¶ˆé€‰æ‹©
        
        // é¡µé¢è·³è½¬åŠŸèƒ½
        function goBack() {
            // è®°å½•é¡µé¢å¯¼èˆªé€€å‡º
            recordPageNavigationExit();
            // è¿”å›Detailsé¡µé¢
            window.location.href = 'details.html';
        }

        // å¤„ç†æ–‡å­—åŒºåŸŸç‚¹å‡»
        function handleTextClick(event) {
            // å¦‚æœæ­£åœ¨é€‰æ‹©æ–‡æœ¬ï¼Œä¸å¤„ç†ç‚¹å‡»äº‹ä»¶
            if (isSelectingText) {
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯é€‰æ‹©æ¡†ã€æ‰‹æŸ„æˆ–é€‰æ‹©èœå•ï¼Œä¸å¤„ç†
            if (event && (event.target.classList.contains('text-selection-box') || 
                event.target.classList.contains('selection-handle') ||
                event.target.closest('#native-selection-menu'))) {
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ’çº¿éƒ¨åˆ†ï¼Œæ˜¾ç¤ºåˆ é™¤é€‰é¡¹
            if (event && event.target.classList.contains('highlighted')) {
                showDeleteConfirmation(event.target);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¼¹çª—æˆ–é®ç½©æ‰“å¼€
            const hasRecordingModal = document.getElementById('statsModal') && document.getElementById('statsModal').style.display === 'block';
            const hasSimpleRecordingModal = document.getElementById('simpleRecordingModal') && document.getElementById('simpleRecordingModal').style.display === 'block';
            const hasNotebookModal = document.getElementById('notebookModal') && document.getElementById('notebookModal').classList.contains('show');
            const hasOverlay = document.querySelector('.overlay-background');
            const hasSelectionMenu = document.getElementById('native-selection-menu');
            
            if (hasRecordingModal || hasSimpleRecordingModal || hasNotebookModal || hasOverlay || hasSelectionMenu) {
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯æ–‡å­—æ®µè½ï¼Œä¸”ä¸æ˜¯åˆ’çº¿éƒ¨åˆ†ï¼Œæ˜¾ç¤ºç°è‰²é®ç½©
            if (event && event.target.tagName === 'P' && !event.target.classList.contains('highlighted')) {
                createOverlay();
            } else {
                // å¦‚æœæ²¡æœ‰eventå‚æ•°ï¼Œç›´æ¥æ˜¾ç¤ºé®ç½©
                createOverlay();
            }
        }

        // æ‰“å¼€overlayé®ç½©
        function openOverlay() {
            console.log('ğŸ“– å°è¯•æ‰“å¼€overlayé®ç½©');
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰recordingå¼¹çª—æ‰“å¼€
            if (document.querySelector('.stats-modal.show')) {
                console.log('âš ï¸ recordingå¼¹çª—å·²æ‰“å¼€ï¼Œè¯·å…ˆå…³é—­recording');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰overlayé®ç½©
            if (document.querySelector('.overlay-background')) {
                console.log('âš ï¸ overlayé®ç½©å·²å­˜åœ¨');
                return;
            }
            
            console.log('âœ… å¯ä»¥æ‰“å¼€overlayé®ç½©');
            createOverlay();
        }

        // æ˜¾ç¤ºrecordingå¼¹çª—
        function showRecording() {
            // è®¾ç½®åˆ›å»ºæ ‡è®°
            window.isCreatingModal = true;
            
            // åˆ é™¤ç°æœ‰çš„å¼¹çª—
            const existingModal = document.getElementById('simpleRecordingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // åˆ›å»ºå…¨æ–°çš„å¼¹çª—å…ƒç´ 
            const newModal = document.createElement('div');
            newModal.id = 'simpleRecordingModal';
            newModal.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 20px;">Recording</h3>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Reading Time</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingHours">0</div>
                            <div style="font-size: 13px;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingMinutes">0</div>
                            <div style="font-size: 13px;">Min</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of Exits</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleExitCount">0</div>
                            <div style="font-size: 13px;">Times</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of strokes</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleHighlightCount">0</div>
                            <div style="font-size: 13px;">Items</div>
                        </div>
                    </div>
                </div>
            `;
            
            // è®¾ç½®æ ·å¼ - ç›´æ¥è®¾ç½®ï¼Œä¸ä½¿ç”¨CSSç±»
            newModal.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 240px !important;
                height: 320px !important;
                background: white !important;
                color: black !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                z-index: 10002 !important;
                padding: 20px !important;
                border-radius: 15px !important;
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3) !important;
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(newModal);
            
            // æ›´æ–°æ•°æ®
            try {
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                document.getElementById('simpleReadingHours').textContent = Math.floor(readingTime / 60);
                document.getElementById('simpleReadingMinutes').textContent = readingTime % 60;
                document.getElementById('simpleExitCount').textContent = currentExitCount;
                document.getElementById('simpleHighlightCount').textContent = totalStrokes;
                console.log('âœ… æ•°æ®å·²æ›´æ–°ï¼Œé€€å‡ºæ¬¡æ•°:', currentExitCount);
            } catch (error) {
                console.error('âŒ æ›´æ–°æ•°æ®æ—¶å‡ºé”™:', error);
            }
            
            // å»¶è¿Ÿæ¸…é™¤åˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿å¼¹çª—å®Œå…¨åˆ›å»º
            setTimeout(() => {
                window.isCreatingModal = false;
                console.log('âœ… åˆ›å»ºæ ‡è®°å·²æ¸…é™¤');
            }, 100);
            
            console.log('âœ… æ–°recordingå¼¹çª—å·²åˆ›å»ºå¹¶æ˜¾ç¤º');
        }




        // æ˜¾ç¤ºrecordingç»Ÿè®¡å¼¹çª— - åˆ›å»ºæ–°å¼¹çª—ç‰ˆæœ¬
        function showRecording() {
            console.log('ğŸ“Š æ˜¾ç¤ºrecordingç»Ÿè®¡å¼¹çª—');
            
            // è®¾ç½®åˆ›å»ºæ ‡è®°
            window.isCreatingModal = true;
            
            // åˆ é™¤ç°æœ‰çš„å¼¹çª—
            const existingModal = document.getElementById('statsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // åˆ›å»ºå…¨æ–°çš„recordingå¼¹çª—
            const newModal = document.createElement('div');
            newModal.id = 'statsModal';
            newModal.innerHTML = `
                <div style="position: absolute; top: 7px; left: 50%; transform: translateX(-50%); width: 94px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; line-height: 1.5em; color: #000000;">Recording</div>
                
                <div style="position: absolute; top: 57px; left: 15px; width: 184px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Reading Time</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="readingHours">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="readingMinutes">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Min</div>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; top: 148px; left: 15px; width: 104px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Number of Exits</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="exitCount">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Times</div>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; top: 239px; left: 15px; width: 121px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Number of strokes</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="highlightCount">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Items</div>
                        </div>
                    </div>
                </div>
            `;
            
            // è®¾ç½®æ ·å¼ - ç›´æ¥è®¾ç½®ï¼Œä¸ä½¿ç”¨CSSç±»
            newModal.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 240px !important;
                height: 320px !important;
                background: #FFFFFF !important;
                border-radius: 15px !important;
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3) !important;
                z-index: 10001 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                padding: 0 !important;
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(newModal);
            
            // æ›´æ–°å¼¹çª—ä¸­çš„æ•°å€¼
            try {
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                document.getElementById('readingHours').textContent = Math.floor(readingTime / 60);
                document.getElementById('readingMinutes').textContent = readingTime % 60;
                document.getElementById('exitCount').textContent = currentExitCount;
                document.getElementById('highlightCount').textContent = totalStrokes;
                console.log('âœ… ç»Ÿè®¡æ•°æ®å·²æ›´æ–°ï¼Œé€€å‡ºæ¬¡æ•°:', currentExitCount);
            } catch (error) {
                console.error('âŒ æ›´æ–°ç»Ÿè®¡æ•°æ®æ—¶å‡ºé”™:', error);
            }
            
            // å»¶è¿Ÿæ¸…é™¤åˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿å¼¹çª—å®Œå…¨åˆ›å»º
            setTimeout(() => {
                window.isCreatingModal = false;
                console.log('âœ… åˆ›å»ºæ ‡è®°å·²æ¸…é™¤');
            }, 100);
            
            console.log('âœ… æ–°recordingå¼¹çª—å·²åˆ›å»ºå¹¶æ˜¾ç¤º');
        }

        // å…³é—­recordingç»Ÿè®¡å¼¹çª— - è¿”å›åˆ°ç°è‰²é®ç½©
        function closeRecording() {
            console.log('ğŸ“Š å…³é—­recordingç»Ÿè®¡å¼¹çª—ï¼Œè¿”å›åˆ°ç°è‰²é®ç½©');
            
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                console.log('âœ… recordingå¼¹çª—å·²å…³é—­ï¼Œä¿æŒåœ¨overlayæ¨¡å¼');
            }
        }

        // æ˜¾ç¤ºç¬”è®°æœ¬å¼¹çª—
        function showNotebook() {
            console.log('ğŸ““ æ˜¾ç¤ºç¬”è®°æœ¬å¼¹çª—');
            window.isCreatingNotebookModal = true; // è®¾ç½®åˆ›å»ºæ ‡è®°
            
            const modal = document.getElementById('notebookModal');
            const content = document.getElementById('notebookContent');
            
            if (!modal) {
                console.error('âŒ æœªæ‰¾åˆ°notebookModalå…ƒç´ ï¼');
                return;
            }
            
            // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentPage = 0;
            
            // æ˜¾ç¤ºç¬”è®°å†…å®¹
            displayNotes();
            
            modal.classList.add('show');
            
            // æ˜¾ç¤ºåº•éƒ¨æ ‡ç­¾æ 
            const bottomBar = document.getElementById('notebookBottomBar');
            if (bottomBar) {
                bottomBar.classList.add('show');
            }
            
            console.log('âœ… ç¬”è®°æœ¬å¼¹çª—å·²æ˜¾ç¤ºï¼ŒåŒ…å«', highlightedElements.length, 'æ¡ç¬”è®°');
            
            // æ¸…é™¤åˆ›å»ºæ ‡è®°
            setTimeout(() => {
                window.isCreatingNotebookModal = false;
                console.log('âœ… ç¬”è®°æœ¬åˆ›å»ºæ ‡è®°å·²æ¸…é™¤');
            }, 100);
        }

        // æ˜¾ç¤ºç¬”è®°å†…å®¹ï¼ˆåˆ†é¡µåŠŸèƒ½ï¼‰
        function displayNotes() {
            const content = document.getElementById('notebookContent');
            content.innerHTML = '';
            
            // ç”Ÿæˆç¤ºä¾‹ç¬”è®°å†…å®¹
            const sampleNotes = [
                "Stradlater spends the evening on a date with Jane Gallagher, a girl whom Holden used to date and whom he still admires. This passage reveals Holden's complex feelings about Jane and his protective instincts towards her.",
                "The catcher in the rye represents Holden's desire to protect children from the harsh realities of adulthood. He imagines himself standing in a field of rye, catching children who are about to fall off a cliff.",
                "Holden's red hunting hat symbolizes his individuality and his desire to stand out from the crowd. He wears it when he wants to feel different or when he's feeling particularly alienated.",
                "Phoebe is Holden's younger sister and represents innocence and purity in his life. She serves as a contrast to the phoniness he sees in the adult world around him.",
                "The museum represents stability and permanence in Holden's chaotic world. He finds comfort in the fact that the exhibits never change, unlike the people in his life who seem to constantly disappoint him.",
                "Holden's relationship with his parents is strained, particularly with his father who wants him to attend an elite prep school. This tension reflects Holden's rejection of the adult world's values and expectations.",
                "The ducks in Central Park symbolize Holden's own feelings of displacement and uncertainty about where he belongs in the world. He repeatedly asks cab drivers about where the ducks go in winter.",
                "Allie's death has a profound impact on Holden, representing the loss of innocence and the harsh reality of mortality. Holden keeps Allie's baseball mitt as a connection to his lost brother."
            ];
            
            // åˆå¹¶å®é™…åˆ’çº¿å’Œç¤ºä¾‹ç¬”è®°
            let allNotes = [...highlightedElements];
            if (allNotes.length < 8) {
                const remainingNotes = 8 - allNotes.length;
                for (let i = 0; i < remainingNotes; i++) {
                    allNotes.push({
                        text: sampleNotes[i],
                        timestamp: `ç¤ºä¾‹ç¬”è®° ${i + 1}`
                    });
                }
            }
            
            // è®¡ç®—å½“å‰é¡µçš„ç¬”è®°èŒƒå›´
            const startIndex = currentPage * notesPerPage;
            const endIndex = Math.min(startIndex + notesPerPage, allNotes.length);
            const currentPageNotes = allNotes.slice(startIndex, endIndex);
            
            // æ˜¾ç¤ºå½“å‰é¡µçš„ç¬”è®°
            currentPageNotes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'notebook-item';
                noteItem.innerHTML = `
                    <div class="text">${note.text}</div>
                    <div class="timestamp">${note.timestamp}</div>
                `;
                content.appendChild(noteItem);
            });
            
            // æ›´æ–°æŒ‡ç¤ºå™¨
            updateIndicators(allNotes.length);
        }

        // æ›´æ–°åº•éƒ¨æŒ‡ç¤ºå™¨
        function updateIndicators(totalNotes) {
            const indicators = document.querySelectorAll('.indicator');
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            indicators.forEach((indicator, index) => {
                if (index < totalPages) {
                    indicator.style.display = 'block';
                    indicator.classList.toggle('active', index === currentPage);
                } else {
                    indicator.style.display = 'none';
                }
            });
        }

        // ç¿»é¡µåŠŸèƒ½
        function nextPage() {
            const totalNotes = Math.max(highlightedElements.length, 8);
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            if (currentPage < totalPages - 1) {
                currentPage++;
                displayNotes();
                console.log('ğŸ“„ ç¿»åˆ°ç¬¬', currentPage + 1, 'é¡µ');
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                displayNotes();
                console.log('ğŸ“„ ç¿»åˆ°ç¬¬', currentPage + 1, 'é¡µ');
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(pageIndex) {
            const totalNotes = Math.max(highlightedElements.length, 8);
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            if (pageIndex >= 0 && pageIndex < totalPages) {
                currentPage = pageIndex;
                displayNotes();
                console.log('ğŸ“„ è·³è½¬åˆ°ç¬¬', currentPage + 1, 'é¡µ');
            }
        }

        // æ›´æ–°recordingé¡µé¢çš„strokesè®¡æ•°
        function updateRecordingStrokes() {
            // æ›´æ–°totalStrokeså˜é‡
            totalStrokes = highlightedElements.length;
            
            // å¦‚æœrecordingå¼¹çª—å·²æ‰“å¼€ï¼Œæ›´æ–°æ˜¾ç¤º
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const strokesElement = statsModal.querySelector('.stats-value');
                if (strokesElement) {
                    strokesElement.textContent = totalStrokes;
                }
            }
            
            console.log('ğŸ“Š å·²æ›´æ–°recordingé¡µé¢çš„strokesè®¡æ•°:', totalStrokes);
        }

        // å…³é—­ç¬”è®°æœ¬å¼¹çª—ï¼Œè¿”å›åˆ°ç°è‰²é®ç½©
        function closeNotebook() {
            const modal = document.getElementById('notebookModal');
            modal.classList.remove('show');
            
            // éšè—åº•éƒ¨æ ‡ç­¾æ 
            const bottomBar = document.getElementById('notebookBottomBar');
            if (bottomBar) {
                bottomBar.classList.remove('show');
            }
            
            // ç§»é™¤æ‰€æœ‰iconçš„activeçŠ¶æ€ï¼Œè¿”å›åˆ°ç°è‰²é®ç½©çŠ¶æ€
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            console.log('âœ… ç¬”è®°æœ¬å¼¹çª—å·²å…³é—­ï¼Œè¿”å›åˆ°ç°è‰²é®ç½©');
        }

        // åˆ é™¤æ‰€æœ‰ç¬”è®°
        function deleteAllNotes() {
            // æ˜¾ç¤ºé€‰æ‹©åˆ é™¤ç•Œé¢
            showDeleteSelection();
        }

        // æ˜¾ç¤ºåˆ é™¤é€‰æ‹©ç•Œé¢
        function showDeleteSelection() {
            const content = document.getElementById('notebookContent');
            const allNotes = [...highlightedElements];
            
            // ç”Ÿæˆç¤ºä¾‹ç¬”è®°å†…å®¹
            const sampleNotes = [
                "Stradlater spends the evening on a date with Jane Gallagher, a girl whom Holden used to date and whom he still admires. This passage reveals Holden's complex feelings about Jane and his protective instincts towards her.",
                "The catcher in the rye represents Holden's desire to protect children from the harsh realities of adulthood. He imagines himself standing in a field of rye, catching children who are about to fall off a cliff.",
                "Holden's red hunting hat symbolizes his individuality and his desire to stand out from the crowd. He wears it when he wants to feel different or when he's feeling particularly alienated.",
                "Phoebe is Holden's younger sister and represents innocence and purity in his life. She serves as a contrast to the phoniness he sees in the adult world around him.",
                "The museum represents stability and permanence in Holden's chaotic world. He finds comfort in the fact that the exhibits never change, unlike the people in his life who seem to constantly disappoint him.",
                "Holden's relationship with his parents is strained, particularly with his father who wants him to attend an elite prep school. This tension reflects Holden's rejection of the adult world's values and expectations.",
                "The ducks in Central Park symbolize Holden's own feelings of displacement and uncertainty about where he belongs in the world. He repeatedly asks cab drivers about where the ducks go in winter.",
                "Allie's death has a profound impact on Holden, representing the loss of innocence and the harsh reality of mortality. Holden keeps Allie's baseball mitt as a connection to his lost brother."
            ];
            
            // åˆå¹¶å®é™…åˆ’çº¿å’Œç¤ºä¾‹ç¬”è®°
            if (allNotes.length < 8) {
                const remainingNotes = 8 - allNotes.length;
                for (let i = 0; i < remainingNotes; i++) {
                    allNotes.push({
                        text: sampleNotes[i],
                        timestamp: `ç¤ºä¾‹ç¬”è®° ${i + 1}`,
                        isSample: true
                    });
                }
            }
            
            // æ¸…ç©ºå†…å®¹å¹¶æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
            content.innerHTML = '';
            
            // æ·»åŠ æ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.className = 'delete-title';
            titleDiv.innerHTML = '<h3>é€‰æ‹©è¦åˆ é™¤çš„ç¬”è®°</h3>';
            content.appendChild(titleDiv);
            
            // æ˜¾ç¤ºæ‰€æœ‰ç¬”è®°ä¾›é€‰æ‹©
            allNotes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'notebook-item selectable';
                noteItem.innerHTML = `
                    <div class="note-checkbox">
                        <input type="checkbox" id="note-${index}" class="note-select" data-index="${index}">
                        <label for="note-${index}"></label>
                    </div>
                    <div class="text">${note.text}</div>
                    <div class="timestamp">${note.timestamp}</div>
                `;
                content.appendChild(noteItem);
            });
            
            // æ·»åŠ æ“ä½œæŒ‰é’®
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'delete-buttons';
            buttonDiv.innerHTML = `
                <button class="cancel-delete-btn" onclick="cancelDelete()">å–æ¶ˆ</button>
                <button class="confirm-delete-btn" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            `;
            content.appendChild(buttonDiv);
        }

        // å–æ¶ˆåˆ é™¤
        function cancelDelete() {
            displayNotes();
        }

        // ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ç¬”è®°
        function confirmDelete() {
            const selectedCheckboxes = document.querySelectorAll('.note-select:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
            
            if (selectedIndices.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„ç¬”è®°');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIndices.length} æ¡ç¬”è®°å—ï¼Ÿ`)) {
                // åˆ é™¤é€‰ä¸­çš„ç¬”è®°ï¼ˆåªåˆ é™¤å®é™…åˆ’çº¿ï¼Œä¸åˆ é™¤ç¤ºä¾‹ç¬”è®°ï¼‰
                let deletedCount = 0;
                const deletedHighlights = [];
                
                selectedIndices.forEach(index => {
                    if (index < highlightedElements.length) {
                        deletedHighlights.push(highlightedElements[index]);
                        highlightedElements.splice(index, 1);
                        deletedCount++;
                    }
                });
                
                // ä¿å­˜æ‰¹é‡åˆ é™¤æ“ä½œåˆ°æ•°æ®åº“
                saveToDatabase('batch_delete_highlights', {
                    deletedCount: deletedCount,
                    deletedHighlights: deletedHighlights,
                    totalStrokes: highlightedElements.length
                });
                
                // æ›´æ–°strokesè®¡æ•°
                totalStrokes = highlightedElements.length;
                updateRecordingStrokes();
                
                // é‡æ–°æ˜¾ç¤ºç¬”è®°ï¼ˆåœç•™åœ¨marké¡µé¢ï¼‰
                displayNotes();
                console.log('âœ… å·²åˆ é™¤é€‰ä¸­çš„ç¬”è®°ï¼Œstrokesè®¡æ•°å·²æ›´æ–°ï¼Œåœç•™åœ¨marké¡µé¢ï¼Œåˆ é™¤æ“ä½œå·²è®°å½•åˆ°æ•°æ®åº“');
            }
        }

        // åˆ‡æ¢åˆ°ç¬”è®°æœ¬æ¨¡å¼
        function switchToNotebook(element) {
            console.log('ğŸ““ åˆ‡æ¢åˆ°ç¬”è®°æœ¬æ¨¡å¼');
            
            // éšè—è¿›åº¦å¼¹çª—ï¼ˆå¦‚æœæ­£åœ¨æ˜¾ç¤ºï¼‰
            hideProgressModal();
            
            // ç§»é™¤æ‰€æœ‰iconçš„activeçŠ¶æ€
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            // æ·»åŠ å½“å‰iconçš„activeçŠ¶æ€
            element.classList.add('active');
            
            // æ˜¾ç¤ºç¬”è®°æœ¬å¼¹çª—
            showNotebook();
        }

        // åˆ‡æ¢åˆ°è¿›åº¦æ¨¡å¼
        function switchToProcessing(element) {
            console.log('ğŸ“Š åˆ‡æ¢åˆ°è¿›åº¦æ¨¡å¼');
            
            // æ£€æŸ¥è¿›åº¦å¼¹çª—æ˜¯å¦å·²ç»æ˜¾ç¤º
            const progressModal = document.getElementById('progressModal');
            const isProgressModalVisible = progressModal && progressModal.style.visibility === 'visible';
            
            // ç§»é™¤æ‰€æœ‰iconçš„activeçŠ¶æ€
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            if (isProgressModalVisible) {
                // å¦‚æœè¿›åº¦å¼¹çª—å·²ç»æ˜¾ç¤ºï¼Œåˆ™éšè—å®ƒ
                console.log('ğŸ“Š è¿›åº¦å¼¹çª—å·²æ˜¾ç¤ºï¼Œéšè—å¼¹çª—');
                hideProgressModal();
                // ä¸æ·»åŠ activeçŠ¶æ€ï¼Œä¿æŒç°è‰²é®ç½©çŠ¶æ€
            } else {
                // å¦‚æœè¿›åº¦å¼¹çª—æœªæ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤ºå®ƒ
                console.log('ğŸ“Š æ˜¾ç¤ºè¿›åº¦å¼¹çª—');
                // æ·»åŠ å½“å‰iconçš„activeçŠ¶æ€
                element.classList.add('active');
                // æ˜¾ç¤ºè¿›åº¦å¼¹çª—
                showProgressModal();
            }
        }

        // åˆ‡æ¢åˆ°äº®åº¦æ¨¡å¼
        function switchToLight(element) {
            console.log('ğŸ’¡ åˆ‡æ¢åˆ°äº®åº¦æ¨¡å¼');
            
            // éšè—è¿›åº¦å¼¹çª—ï¼ˆå¦‚æœæ­£åœ¨æ˜¾ç¤ºï¼‰
            hideProgressModal();
            
            // ç§»é™¤æ‰€æœ‰iconçš„activeçŠ¶æ€
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            // æ·»åŠ å½“å‰iconçš„activeçŠ¶æ€
            element.classList.add('active');
            
            // æ˜¾ç¤ºäº®åº¦è°ƒèŠ‚åŠŸèƒ½ï¼ˆæš‚æ—¶ä¸å®ç°å…·ä½“åŠŸèƒ½ï¼‰
            console.log('æ˜¾ç¤ºäº®åº¦è°ƒèŠ‚åŠŸèƒ½');
        }

        // åˆ›å»ºoverlayé®ç½©
        function createOverlay() {
            // åˆ›å»ºoverlayèƒŒæ™¯
            const overlayBackground = document.createElement('div');
            overlayBackground.className = 'overlay-background';
            overlayBackground.onclick = closeOverlay;
            
            // åˆ›å»ºoverlayå®¹å™¨
            const overlayContainer = document.createElement('div');
            overlayContainer.className = 'overlay-container';
            overlayContainer.innerHTML = `
                <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
                <div class="top-tab-bar">
                    <div class="top-nav-content">
                        <div class="back-button" onclick="closeOverlay()">
                            <img src="../images/Vector.svg" width="19" height="16" alt="è¿”å›">
                        </div>
                        <div class="book-info">
                            <div class="book-title">Oliver Twist</div>
                            <div class="book-author">Charles Dickens</div>
                        </div>
                        <div class="menu-button">
                            <div class="menu-dot"></div>
                            <div class="menu-dot"></div>
                            <div class="menu-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´åŠé€æ˜å†…å®¹åŒºåŸŸ -->
                <div class="content-overlay" onclick="closeOverlay()">
                    <!-- è¿™é‡Œå¯ä»¥æ”¾ç½®å…·ä½“çš„å†…å®¹ -->
                </div>

                                        <!-- åº•éƒ¨å›¾æ ‡æ  -->
                        <div class="bottom-label-bar">
                            <div class="bottom-icons">
                                <!-- ç¬”è®°æœ¬å›¾æ ‡ -->
                                <div class="icon-item" onclick="switchToNotebook(this)">
                                    <img src="../images/notebook.svg" width="30" height="30" alt="notebook">
                                </div>

                                <!-- è¿›åº¦å›¾æ ‡ -->
                                <div class="icon-item" onclick="switchToProcessing(this)">
                                    <img src="../images/processing.svg" width="30" height="30" alt="processing">
                                </div>

                                <!-- äº®åº¦å›¾æ ‡ -->
                                <div class="icon-item" onclick="switchToLight(this)">
                                    <img src="../images/light.svg" width="30" height="30" alt="light">
                                </div>
                            </div>
                        </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlayBackground);
            document.body.appendChild(overlayContainer);
            
            // ç¬é—´å±•å¼€overlayï¼ˆinstantï¼‰
            overlayContainer.style.transform = 'scale(1) translateY(0)';
            overlayContainer.style.opacity = '1';
            
            // æ·»åŠ bottom barå¼¹å‡ºåŠ¨ç”»
            setTimeout(() => {
                const bottomBar = overlayContainer.querySelector('.bottom-label-bar');
                if (bottomBar) {
                    bottomBar.classList.add('show');
                }
            }, 50);
        }

        // å…³é—­overlayé®ç½©
        function closeOverlay() {
            const overlayBackground = document.querySelector('.overlay-background');
            const overlayContainer = document.querySelector('.overlay-container');
            
            if (overlayContainer) {
                // ç¬é—´å…³é—­overlayï¼ˆinstantï¼‰
                overlayContainer.style.transform = 'scale(0.8) translateY(50px)';
                overlayContainer.style.opacity = '0';
                
                // ç«‹å³ç§»é™¤å…ƒç´ 
                if (overlayBackground) overlayBackground.remove();
                if (overlayContainer) overlayContainer.remove();
            }
        }

        // åˆ‡æ¢å›¾æ ‡æ¿€æ´»çŠ¶æ€
        function switchIcon(clickedIcon, iconType) {
            // ç§»é™¤æ‰€æœ‰å›¾æ ‡çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.icon-item').forEach(icon => {
                icon.classList.remove('active');
            });
            
            // æ¿€æ´»è¢«ç‚¹å‡»çš„å›¾æ ‡
            clickedIcon.classList.add('active');
            
            console.log('åˆ‡æ¢åˆ°å›¾æ ‡:', iconType);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åŠŸèƒ½é€»è¾‘
            switch(iconType) {
                case 'notebook':
                    console.log('æ˜¾ç¤ºç¬”è®°æœ¬åŠŸèƒ½');
                    break;
                case 'processing':
                    console.log('æ˜¾ç¤ºè¿›åº¦åŠŸèƒ½');
                    break;
                case 'light':
                    console.log('æ˜¾ç¤ºäº®åº¦è°ƒèŠ‚åŠŸèƒ½');
                    break;
            }
        }

        // é¡¶éƒ¨å¯¼èˆªæ æ»šåŠ¨æ§åˆ¶
        let lastScrollTop = 0;
        let scrollThreshold = 50; // æ»šåŠ¨é˜ˆå€¼
        let isScrolling = false;
        let scrollTimer;

        function handleScroll() {
            const readingContent = document.getElementById('readingContent');
            const topBar = document.getElementById('topBar');
            
            if (!readingContent || !topBar) return;

            const scrollTop = readingContent.scrollTop;
            const scrollDelta = scrollTop - lastScrollTop;

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            clearTimeout(scrollTimer);

            // å‘ä¸Šæ»šåŠ¨æ—¶æ˜¾ç¤ºé¡¶éƒ¨æ 
            if (scrollDelta < -scrollThreshold) {
                topBar.classList.remove('hidden');
                topBar.classList.add('visible');
            }
            // å‘ä¸‹æ»šåŠ¨æ—¶éšè—é¡¶éƒ¨æ 
            else if (scrollDelta > scrollThreshold) {
                topBar.classList.remove('visible');
                topBar.classList.add('hidden');
            }

            lastScrollTop = scrollTop;

            // è®¾ç½®å®šæ—¶å™¨ï¼Œåœæ­¢æ»šåŠ¨åæ˜¾ç¤ºé¡¶éƒ¨æ 
            scrollTimer = setTimeout(() => {
                topBar.classList.remove('hidden');
                topBar.classList.add('visible');
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Book Normalé¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) {
                console.warn('æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
                window.location.href = 'number.html';
                return;
            }
            
            console.log('å½“å‰ç”¨æˆ·ID:', currentUserId);
            
            // åˆå§‹åŒ–ç•Œé¢åœç•™æ—¶é—´è®°å½•
            initPageStayTime();
            
            const readingContent = document.getElementById('readingContent');
            if (readingContent) {
                readingContent.addEventListener('scroll', handleScroll);
            }
            
            // å¯ç”¨ç½‘é¡µç«¯è‡ªå¸¦æ–‡æœ¬é€‰æ‹©åŠŸèƒ½
            enableNativeTextSelection();
            
            // åˆå§‹åŒ–ä¸€å‘¨é˜…è¯»æ•°æ®
            initWeeklyReadingData();
            
            // ç›‘å¬æ–‡æœ¬æ»šåŠ¨äº‹ä»¶ï¼Œæ›´æ–°é˜…è¯»ä½ç½®
            const textContent = document.getElementById('textContent');
            if (textContent) {
                textContent.addEventListener('scroll', updateCurrentReadingPosition);
            }
            
            // æ·»åŠ è¿›åº¦å¼¹çª—ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
            document.addEventListener('click', function(e) {
                const progressModal = document.getElementById('progressModal');
                if (progressModal && progressModal.style.display === 'block') {
                    if (!progressModal.contains(e.target)) {
                        hideProgressModal();
                    }
                }
            });

            // é¡µé¢åŠ è½½åŠ¨ç”»
            const container = document.querySelector('.container');
            container.classList.add('fade-in');

            // åŠ è½½ç¤ºä¾‹æ–‡æœ¬
            loadSampleText();
            
            // æ·»åŠ æ™ºèƒ½ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
            addSmartClickHandler();

            // å¯åŠ¨é˜…è¯»æ—¶é—´è®¡æ—¶å™¨
            setInterval(updateReadingTime, 1000);

            // æ·»åŠ é¡µé¢é€€å‡ºç»Ÿè®¡
            window.addEventListener('beforeunload', function() {
                if (readingTime > 5) { // åªæœ‰é˜…è¯»æ—¶é—´è¶…è¿‡5åˆ†é’Ÿæ‰è®°å½•é€€å‡º
                    exitCount++;
                    console.log('ğŸ“Š é¡µé¢é€€å‡ºï¼Œé˜…è¯»æ—¶é—´:', readingTime, 'åˆ†é’Ÿï¼Œé€€å‡ºæ¬¡æ•°:', exitCount);
                }
            });

            // é‡æ–°è®¾è®¡æ–‡æœ¬é«˜äº®ç³»ç»Ÿ
            let isCreatingModal = false;
            let isCreatingNotebookModal = false;

            // æ·»åŠ å¼¹çª—å…³é—­åŠŸèƒ½ - ä¿®å¤é€»è¾‘é—®é¢˜
            document.addEventListener('click', function(e) {
                // å¦‚æœæ­£åœ¨åˆ›å»ºå¼¹çª—ï¼Œå¿½ç•¥è¿™æ¬¡ç‚¹å‡»
                if (window.isCreatingModal || window.isCreatingNotebookModal) {
                    console.log('ğŸ” æ­£åœ¨åˆ›å»ºå¼¹çª—ï¼Œå¿½ç•¥ç‚¹å‡»äº‹ä»¶');
                    return;
                }
                
                const statsModal = document.getElementById('statsModal');
                const simpleRecordingModal = document.getElementById('simpleRecordingModal');
                const notebookModal = document.getElementById('notebookModal');
                
                // æ£€æŸ¥ç®€å•recordingå¼¹çª—
                if (simpleRecordingModal && simpleRecordingModal.style.display === 'block') {
                    console.log('ğŸ” ç®€å•recordingå¼¹çª—å·²æ‰“å¼€ï¼Œæ£€æŸ¥ç‚¹å‡»ä½ç½®');
                    if (!simpleRecordingModal.contains(e.target)) {
                        console.log('ğŸ” ç‚¹å‡»åœ¨ç®€å•recordingå¼¹çª—å¤–éƒ¨ï¼Œå…³é—­å¼¹çª—');
                        simpleRecordingModal.style.display = 'none';
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘overlay
                        e.stopPropagation();
                        return;
                    }
                }
                
                // æ£€æŸ¥recordingå¼¹çª—
                if (statsModal && statsModal.style.display === 'block') {
                    console.log('ğŸ” recordingå¼¹çª—å·²æ‰“å¼€ï¼Œæ£€æŸ¥ç‚¹å‡»ä½ç½®');
                    if (!statsModal.contains(e.target)) {
                        console.log('ğŸ” ç‚¹å‡»åœ¨recordingå¼¹çª—å¤–éƒ¨ï¼Œå…³é—­å¼¹çª—');
                        closeRecording();
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘overlay
                        e.stopPropagation();
                        return;
                    }
                }
                
                // æ£€æŸ¥ç¬”è®°æœ¬å¼¹çª—
                if (notebookModal && notebookModal.classList.contains('show')) {
                    console.log('ğŸ” ç¬”è®°æœ¬å¼¹çª—å·²æ‰“å¼€ï¼Œæ£€æŸ¥ç‚¹å‡»ä½ç½®');
                    if (!notebookModal.contains(e.target)) {
                        console.log('ğŸ” ç‚¹å‡»åœ¨ç¬”è®°æœ¬å¼¹çª—å¤–éƒ¨ï¼Œå…³é—­å¼¹çª—');
                        closeNotebook();
                    }
                }
            });
        });

        // æ›´æ–°é˜…è¯»æ—¶é—´
        function updateReadingTime() {
            const currentTime = Date.now();
            readingTime = Math.floor((currentTime - startTime) / 1000 / 60); // è½¬æ¢ä¸ºåˆ†é’Ÿ
        }

        // åŠ è½½ç¤ºä¾‹æ–‡æœ¬
        function loadSampleText() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;

            // è¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…çš„Oliver Twistæ–‡æœ¬
            const sampleText = `
                <div class="chapter">
                    <h2>Chapter 1: Treats of the Place Where Oliver Twist was Born and of the Circumstances Attending His Birth</h2>
                    
                    <p>Among other public buildings in a certain town, which for many reasons it will be prudent to refrain from mentioning, and to which I will assign no fictitious name, there is one anciently common to most towns, great or small: to wit, a workhouse; and in this workhouse was born; on a day and date which I need not trouble myself to repeat, inasmuch as it can be of no possible consequence to the reader, in this stage of the business at all events; the item of mortality whose name is prefixed to the head of this chapter.</p>
                    
                    <p>For a long time after it was ushered into this world of sorrow and trouble, by the parish surgeon, it remained a matter of considerable doubt whether the child would survive to bear any name at all; in which case it is somewhat more than probable that these memoirs would never have appeared; or, if they had, that being comprised within a couple of pages, they would have possessed the inestimable merit of being the most concise and faithful specimen of biography, extant in the literature of any age or country.</p>
                    
                    <p>Although I am not disposed to maintain that the being born in a workhouse, is in itself the most fortunate and enviable circumstance that can possibly befall a human being, I do mean to say that in this particular instance, it was the best thing for Oliver Twist that could by possibility have occurred. The fact is, that there was considerable difficulty in inducing Oliver to take upon himself the office of respiration,â€”a troublesome practice, but one which custom has rendered necessary to our easy existence; and for some time he lay gasping on a little flock mattress, rather unequally poised between this world and the next: the balance was decidedly in favour of the latter.</p>
                </div>
                
                <div class="chapter">
                    <h2>Chapter 2: Treats of Oliver Twist's Growth, Education, and Board</h2>
                    
                    <p>For the next eight or ten months, Oliver was the victim of a systematic course of treachery and deception. He was brought up by hand. The hungry and destitute situation of the infant orphan was duly reported by the workhouse authorities to the parish authorities. The parish authorities inquired with dignity of the workhouse authorities, whether there was not female then domiciled in 'the house' who was in a situation to impart to Oliver Twist, the consolation and nourishment of which he stood in need. The workhouse authorities replied with humility, that there was not. Upon this, the parish authorities magnanimously and humanely resolved, that Oliver should be 'farmed,' or, in other words, that he should be dispatched to a branch-workhouse some three miles off, where twenty or thirty other juvenile offenders against the poor-laws, rolled about the floor all day, without the inconvenience of too much food or too much clothing, under the parental superintendence of an elderly female who received the culprits at and for the consideration of sevenpence-halfpenny per small head per week.</p>
                    
                    <p>Sevenpence-halfpenny's worth per week is a good round diet for a child; a great deal may be got for sevenpence-halfpenny: quite enough to overload its stomach, and make it uncomfortable. The elderly female was a woman of wisdom and experience; she knew what was good for children; and she had a very accurate perception of what was good for herself. So, she appropriated the greater part of the weekly stipend to her own use, and consigned the rising parochial generation to even a shorter allowance than was originally provided for them. Thereby finding in the lowest depth a deeper still; and proving herself a very great experimental philosopher.</p>
                </div>
                
                <div class="chapter">
                    <h2>Chapter 3: Relates How Oliver Twist was Very Near Getting a Place, Which Would Not Have Been a Sinecure</h2>
                    
                    <p>For a week after the commission of the impious and profane offence of asking for more, Oliver remained a close prisoner in the dark and solitary room to which he had been consigned by the wisdom and mercy of the board. It appears, at first sight, not unreasonable to suppose, that, if he had entertained a becoming feeling of respect for the prediction of the gentleman in the white waistcoat, he would have established that sage individual's prophetic character, once and for ever, by tying one end of his pocket-handkerchief to a hook in the wall, and attaching the other end to his neck. But to perform the act, he would have been obliged to climb upon a chair; and the chair was very rickety; and the wall was very high; and the handkerchief was very thin; and the hook was very rusty; and the board was very wise; and the gentleman in the white waistcoat was very dignified; and Oliver was very young; and Oliver was very much afraid of the board; and Oliver was very much afraid of the gentleman in the white waistcoat; and Oliver was very much afraid of the workhouse; and Oliver was very much afraid of the parish; and Oliver was very much afraid of the beadle; and Oliver was very much afraid of the master; and Oliver was very much afraid of the mistress; and Oliver was very much afraid of the matron; and Oliver was very much afraid of the cook; and Oliver was very much afraid of the nurse; and Oliver was very much afraid of the doctor; and Oliver was very much afraid of the apothecary; and Oliver was very much afraid of the undertaker; and Oliver was very much afraid of the sexton; and Oliver was very much afraid of the clergyman; and Oliver was very much afraid of the churchwarden; and Oliver was very much afraid of the overseer; and Oliver was very much afraid of the guardian; and Oliver was very much afraid of the committee; and Oliver was very much afraid of the board; and Oliver was very much afraid of the gentleman in the white waistcoat.</p>
                </div>
            `;

            textContent.innerHTML = sampleText;
        }
        
        // æ·»åŠ æ™ºèƒ½ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
        function addSmartClickHandler() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            let clickTimer = null;
            let isLongPress = false;
            
            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            textContent.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    isLongPress = false;
                    clickTimer = setTimeout(() => {
                        isLongPress = true;
                        console.log('ğŸ“ æ£€æµ‹åˆ°é•¿æŒ‰ï¼Œå¯åŠ¨æ–‡æœ¬é€‰æ‹©');
                        // è°ƒç”¨startHighlightTimerå¤„ç†é•¿æŒ‰é€»è¾‘
                        startHighlightTimer(e);
                    }, 500);
                }
            });
            
            // é¼ æ ‡æŠ¬èµ·äº‹ä»¶
            textContent.addEventListener('mouseup', function(e) {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                }
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é€‰æ‹©èœå•
                if (e.target.closest('#native-selection-menu')) {
                    return;
                }
                
                if (!isLongPress && e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    setTimeout(() => {
                        if (!isSelectingText) {
                            handleTextClick(e);
                        }
                    }, 10);
                }
                
                isLongPress = false;
            });
            
            // è§¦æ‘¸äº‹ä»¶
            textContent.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    isLongPress = false;
                    clickTimer = setTimeout(() => {
                        isLongPress = true;
                        // è°ƒç”¨startHighlightTimerå¤„ç†é•¿æŒ‰é€»è¾‘
                        startHighlightTimer(e);
                    }, 500);
                }
            });
            
            textContent.addEventListener('touchend', function(e) {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                }
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é€‰æ‹©èœå•
                if (e.target.closest('#native-selection-menu')) {
                    return;
                }
                
                if (!isLongPress && e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    setTimeout(() => {
                        if (!isSelectingText) {
                            handleTextClick(e);
                        }
                    }, 10);
                }
                
                isLongPress = false;
            });
        }
    </script>
    
</body>
</html>

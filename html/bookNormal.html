<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Normal - Oliver Twist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFFFF;
            overflow: hidden;
            width: 428px;
            height: 926px;
            margin: 0 auto;
            position: relative;
        }

        /* ‰∏ªÂÆπÂô® */
        .container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #FFFFFF;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .top-button-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 127px;
            background: #FFFFFF;
            z-index: 100;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 20px 20px;
        }

        .top-button-bar.hidden {
            transform: translateX(-50%) translateY(-100%);
        }

        .top-button-bar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .top-nav-content {
            position: absolute;
            top: 50px;
            left: 53.5px;
            width: 320.41px;
            height: 51px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            width: 19px;
            height: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        .back-button img {
            width: 19px;
            height: 16px;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .book-title {
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #19191B;
            text-align: center;
        }

        .book-author {
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #9D9D9D;
            text-align: center;
        }

        .menu-button {
            width: 4px;
            height: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dot {
            width: 4px;
            height: 4px;
            background: #19191B;
            border-radius: 50%;
        }

        /* ÈòÖËØªÂÜÖÂÆπÂå∫Âüü */
        .reading-content {
            position: absolute;
            top: 128px;
            left: 0;
            width: 428px;
            height: 798px;
            padding: 10px 24px;
            overflow-y: auto;
            overflow-x: hidden;
            background: #FFFFFF;
        }

        .text-content {
            width: 380px;
            min-height: 725px;
            margin-bottom: 63px;
            font-weight: 300;
            font-size: 16px;
            line-height: 2.25em;
            color: #9D9D9D;
            text-align: left;
            cursor: pointer;
            background: #FFFFFF;
        }

        .chapter {
            margin-bottom: 40px;
        }

        .chapter h2 {
            font-weight: 600;
            font-size: 20px;
            color: #19191B;
            margin-bottom: 20px;
            text-align: center;
        }

        .chapter p {
            margin-bottom: 20px;
            text-align: justify;
        }

        /* È´ò‰∫ÆÊñáÊú¨Ê†∑Âºè */
        .highlighted {
            background: linear-gradient(120deg, #A88DCB 0%, #C4A8E8 100%);
            color: #FFFFFF;
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .highlighted:hover {
            background: linear-gradient(120deg, #9B7BB8 0%, #B395D4 100%);
            transform: scale(1.02);
        }

        .highlighted.selected {
            background: linear-gradient(120deg, #8A6FA8 0%, #A88DCB 100%);
            box-shadow: 0 0 10px rgba(168, 141, 203, 0.5);
        }

        /* ÂèñÊ∂àÈ´ò‰∫ÆÊåâÈíÆ */
        .unhighlight-btn {
            position: absolute;
            top: -20px;
            right: -20px;
            width: 20px;
            height: 20px;
            background: #FF4757;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }

        .highlighted:hover .unhighlight-btn {
            display: flex;
        }

        /* È°µÈù¢Âä†ËΩΩÂä®Áîª */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .reading-content::-webkit-scrollbar {
            display: none;
        }

        .reading-content {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* OverlayÈÅÆÁΩ©Ê†∑Âºè */
        .overlay-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(234, 234, 234, 0.2);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            pointer-events: none;
        }

        .top-tab-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 428px;
            height: 127px;
            background: #FFFFFF;
            z-index: 1002;
            pointer-events: auto;
            left: 50%;
            transform: translateX(-50%);
        }

        .top-nav-content {
            position: absolute;
            top: 51px;
            left: 53.5px;
            width: 320.41px;
            height: 51px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-button {
            width: 19px;
            height: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        .back-button img {
            width: 19px;
            height: 16px;
        }

        .book-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .book-title {
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #19191B;
            text-align: center;
        }

        .book-author {
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #9D9D9D;
            text-align: center;
        }

        .menu-button {
            width: 4px;
            height: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dot {
            width: 4px;
            height: 4px;
            background: #19191B;
            border-radius: 50%;
        }

        .content-overlay {
            position: absolute;
            top: 127px;
            left: 0;
            width: 428px;
            height: 741px;
            background: rgba(234, 234, 234, 0.2);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            z-index: 1002;
            pointer-events: auto;
            left: 50%;
            transform: translateX(-50%);
        }

        .bottom-label-bar {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 428px;
            height: 88px;
            background: #FFFFFF;
            border-radius: 30px 30px 0px 0px;
            box-shadow: 0px -2px 12px 3px rgba(0, 0, 0, 0.25);
            z-index: 1002;
            pointer-events: auto;
            transition: transform 0.3s ease-out;
        }

        .bottom-label-bar.show {
            transform: translateX(-50%) translateY(0);
        }

        .bottom-icons {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 100px;
        }

        .icon-item {
            width: 30px;
            height: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-item.active {
            transform: scale(1.1);
        }

        .icon-item svg {
            width: 30px;
            height: 30px;
            transition: all 0.3s ease;
        }

        .icon-item.active img {
            filter: brightness(0) saturate(100%) invert(67%) sepia(15%) saturate(1234%) hue-rotate(240deg) brightness(95%) contrast(90%);
        }

        .icon-item:not(.active) img {
            filter: brightness(0) saturate(100%) invert(55%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(89%) contrast(86%);
        }

        /* OverlayÂä®Áîª - ‰ªé‰∏≠Èó¥ÂºπÂá∫ */
        @keyframes centerSlideIn {
            from {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes centerSlideOut {
            from {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            to {
                transform: scale(0.8) translateY(50px);
                opacity: 0;
            }
        }

        /* RecordingÁªüËÆ°ÂºπÁ™óÊ†∑Âºè - Ê†πÊçÆFigmaËÆæËÆ° */
        .stats-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 240px;
            height: 320px;
            background: #FFFFFF;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            visibility: hidden;
            opacity: 0;
            padding: 0;
        }

        .stats-modal.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .stats-header {
            position: absolute;
            top: 7px;
            left: 50%;
            transform: translateX(-50%);
            width: 94px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            line-height: 1.5em;
            color: #000000;
        }

        .stats-section {
            position: absolute;
            width: 184px;
            height: 71px;
        }

        .stats-section.reading-time {
            top: 57px;
            left: 15px;
        }

        .stats-section.exit-count {
            top: 148px;
            left: 15px;
            width: 104px;
        }

        .stats-section.stroke-count {
            top: 239px;
            left: 15px;
            width: 121px;
        }

        .stats-label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            background: #EAEAEA;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 12px;
            line-height: 1.5em;
            color: #000000;
        }

        .stats-value {
            position: absolute;
            top: 43px;
            left: 15px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .stats-value > div {
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }

        .stats-display {
            width: 42px;
            height: 28px;
            border: 1px solid #A88DCB;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            color: #19191B;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
        }

        .stats-unit {
            font-weight: 300;
            font-size: 13px;
            line-height: 1.5em;
            color: #000000;
        }

        /* Á¨îËÆ∞Êú¨ÂºπÁ™óÊ†∑Âºè */
        .notebook-modal {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 690px;
            background: #FFFFFF;
            border-radius: 30px 30px 0 0;
            display: none;
            flex-direction: column;
            z-index: 10000;
            box-shadow: 0px -2px 12px 3px rgba(0, 0, 0, 0.25);
        }

        .notebook-modal.show {
            display: flex !important;
        }

        .notebook-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .notebook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            width: 100%;
        }

        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-icon {
            width: 19px;
            height: 16px;
            object-fit: contain;
        }

        .notebook-title-bg {
            background: #A88DCB;
            border-radius: 10px;
            padding: 5px 10px;
            flex: 1;
            display: flex;
            justify-content: center;
            margin: 0 20px;
        }

        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .notebook-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 16px;
            line-height: 1.5em;
            color: #FFFFFF;
            text-align: center;
        }


        .notebook-content {
            width: 380px;
            height: 440px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            padding-right: 10px;
            margin: 0 auto;
        }

        .notebook-item {
            background: #FFFFFF;
            border: 1px solid #757575;
            border-radius: 20px;
            padding: 10px;
            position: relative;
        }

        .notebook-item .text {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            font-size: 16px;
            line-height: 1.5em;
            color: #000000;
            text-align: left;
            word-wrap: break-word;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            line-clamp: 6;
            -webkit-box-orient: vertical;
        }

        .notebook-item .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .no-notes {
            text-align: center;
            color: #9D9D9D;
            font-style: italic;
            padding: 40px 20px;
        }

        .notebook-indicators {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 24px;
        }

        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #D9D9D9;
        }

        .indicator.active {
            background: #A88DCB;
        }

        .notebook-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 428px;
            height: 88px;
            background: #FFFFFF;
            border-radius: 30px 30px 0 0;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 100px;
            z-index: 10001;
        }

        .notebook-bottom-bar.show {
            display: flex;
        }

        .notebook-tab {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .notebook-tab.active .tab-icon {
            filter: brightness(0) saturate(100%) invert(67%) sepia(15%) saturate(1200%) hue-rotate(240deg) brightness(0.8) contrast(0.8);
        }

        .tab-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        /* Âà†Èô§ÈÄâÊã©ÁïåÈù¢Ê†∑Âºè */
        .delete-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .delete-title h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 18px;
            color: #000000;
            margin: 0;
        }

        .notebook-item.selectable {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .note-checkbox {
            margin-top: 5px;
        }

        .note-checkbox input[type="checkbox"] {
            display: none;
        }

        .note-checkbox label {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #757575;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .note-checkbox input[type="checkbox"]:checked + label {
            background: #A88DCB;
            border-color: #A88DCB;
        }

        .note-checkbox input[type="checkbox"]:checked + label::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .delete-buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }

        .cancel-delete-btn, .confirm-delete-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-delete-btn {
            background: #f5f5f5;
            color: #666;
        }

        .cancel-delete-btn:hover {
            background: #e0e0e0;
        }

        .confirm-delete-btn {
            background: #ff4444;
            color: white;
        }

        .confirm-delete-btn:hover {
            background: #cc3333;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
        <div class="top-button-bar" id="topBar">
            <div class="top-nav-content">
                <div class="back-button" onclick="goBack()">
                    <img src="../images/Vector.svg" width="19" height="16" alt="ËøîÂõû">
                </div>
                <div class="book-info">
                    <div class="book-title">Oliver Twist</div>
                    <div class="book-author">Charles Dickens</div>
                </div>
                <div class="menu-button" onclick="showRecording()">
                    <div class="menu-dot"></div>
                    <div class="menu-dot"></div>
                    <div class="menu-dot"></div>
                </div>
            </div>
        </div>

        <!-- ÈòÖËØªÂÜÖÂÆπÂå∫Âüü -->
        <div class="reading-content" id="readingContent">
            <div class="text-content" id="textContent">
                <!-- ËøôÈáåÂ∞ÜÊèíÂÖ•ÈïøÊñáÊú¨ÂÜÖÂÆπ -->
            </div>
            
            
            <!-- ÂØºÂá∫Êï∞ÊçÆÊåâÈíÆ -->
            <div style="position: fixed; top: 300px; left: 20px; z-index: 9999; background: #4ECDC4; color: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="exportUserData()">
                ÂØºÂá∫Êï∞ÊçÆ
            </div>
            
            
            <!-- ËøõÂ∫¶ÂºπÁ™ó -->
            <div id="progressModal" style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%); width: 428px; height: 200px; background: white; border-radius: 30px 30px 0 0; z-index: 10002; visibility: hidden; opacity: 0; box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;">
                <!-- ËøõÂ∫¶ÂºπÁ™óÂÜÖÂÆπ -->
                <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                    <!-- È°∂ÈÉ®Âå∫ÂüüÔºöÈòÖËØªÊó∂Èó¥ÂíåËøõÂ∫¶ -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <!-- ÈòÖËØªÊó∂Èó¥ -->
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div id="readingHours" style="font-size: 20px; font-weight: 600; color: #000000;">0</div>
                            <div style="font-size: 12px; font-weight: 400; color: #9D9D9D;">Hour</div>
                            <div id="readingMinutes" style="font-size: 20px; font-weight: 600; color: #000000;">0</div>
                            <div style="font-size: 12px; font-weight: 400; color: #9D9D9D;">min</div>
                        </div>
                        
                        <!-- ÂàÜÈöîÁ∫ø -->
                        <div style="width: 1px; height: 30px; background: #E0E0E0;"></div>
                        
                        <!-- ÈòÖËØªËøõÂ∫¶ -->
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <div id="readingProgress" style="font-size: 20px; font-weight: 600; color: #333333;">0</div>
                            <div style="font-size: 14px; font-weight: 400; color: #9D9D9D;">%</div>
                        </div>
                        
                        <!-- ÂàÜÈöîÁ∫ø -->
                        <div style="width: 1px; height: 30px; background: #E0E0E0;"></div>
                        
                        <!-- ‰∏ÄÂë®ÈòÖËØªÈ¢ëÊ¨°Ôºà7‰∏™Êü±Áä∂ÂõæÔºâ -->
                        <div id="weeklyBars" style="display: flex; align-items: flex-end; gap: 6px;">
                            <div style="width: 3px; height: 8px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 12px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 6px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 14px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 18px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 10px; background: #19191B; border-radius: 2px;"></div>
                            <div style="width: 3px; height: 16px; background: #19191B; border-radius: 2px;"></div>
                        </div>
                    </div>
                    
                    <!-- ‰∏≠Èó¥ËøõÂ∫¶Êù° -->
                    <div style="position: relative; width: 100%; height: 20px; margin-bottom: 15px;">
                        <!-- ËøõÂ∫¶Êù°ËÉåÊôØ -->
                        <div style="width: 100%; height: 20px; background: #EEEEEE; border-radius: 32px; position: relative;">
                            <!-- ËøõÂ∫¶Êù°Â°´ÂÖÖ -->
                            <div id="progressFill" style="width: 0%; height: 20px; background: #D9D9D9; border-radius: 32px; position: absolute; top: 0; left: 0;"></div>
                            <!-- ËøõÂ∫¶Êù°ÊãñÊãΩÁÇπ -->
                            <div id="progressHandle" style="width: 28px; height: 28px; background: white; border-radius: 50%; position: absolute; top: -4px; left: -14px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); cursor: pointer; border: 3px solid #D9D9D9;"></div>
                        </div>
                    </div>
                    
                    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 100px; padding-top: 10px; border-top: 1px solid #F0F0F0;">
                        <!-- Á¨îËÆ∞Êú¨ÂõæÊ†á -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToNotebook(this)">
                            <img src="../images/notebook.svg" width="30" height="30" alt="notebook" style="filter: grayscale(1);">
                        </div>
                        
                        <!-- ËøõÂ∫¶ÂõæÊ†á -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToProcessing(this)">
                            <img src="../images/processing.svg" width="30" height="30" alt="processing" style="filter: hue-rotate(240deg) saturate(2);">
                        </div>
                        
                        <!-- ‰∫ÆÂ∫¶ÂõæÊ†á -->
                        <div style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="switchToLight(this)">
                            <img src="../images/light.svg" width="30" height="30" alt="light" style="filter: grayscale(1);">
                        </div>
                    </div>
                </div>
            </div>
             
            <div id="simpleRecordingModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 240px; height: 320px; background: white; color: black; display: none; visibility: hidden; opacity: 0; z-index: 10002; padding: 20px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);">
                <h3 style="text-align: center; margin-bottom: 20px;">Recording</h3>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Reading Time</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingHours">0</div>
                            <div style="font-size: 13px;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingMinutes">0</div>
                            <div style="font-size: 13px;">Min</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of Exits</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleExitCount">0</div>
                            <div style="font-size: 13px;">Times</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of strokes</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleHighlightCount">0</div>
                            <div style="font-size: 13px;">Items</div>
                        </div>
                    </div>
                </div>
            </div>
            
           

        <!-- RecordingÁªüËÆ°ÂºπÁ™ó - Ê†πÊçÆFigmaËÆæËÆ° -->
        <div class="stats-modal" id="statsModal">
            <div class="stats-header">Recording</div>
            
            <div class="stats-section reading-time">
                <div class="stats-label">Reading Time</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="readingHours">0</div>
                        <div class="stats-unit">Hour</div>
                    </div>
                    <div>
                        <div class="stats-display" id="readingMinutes">0</div>
                        <div class="stats-unit">Min</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section exit-count">
                <div class="stats-label">Number of Exits</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="exitCount">0</div>
                        <div class="stats-unit">Times</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section stroke-count">
                <div class="stats-label">Number of strokes</div>
                <div class="stats-value">
                    <div>
                        <div class="stats-display" id="highlightCount">0</div>
                        <div class="stats-unit">Items</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á¨îËÆ∞Êú¨ÂºπÁ™ó -->
        <div class="notebook-modal" id="notebookModal">
            <div class="notebook-container">
                <!-- È°∂ÈÉ®Ê†áÈ¢òÊ†è -->
                <div class="notebook-header">
                    <button class="back-btn" onclick="closeNotebook()">
                        <img src="../images/Vector.svg" alt="ËøîÂõû" class="back-icon">
                    </button>
                    <div class="notebook-title-bg">
                        <span class="notebook-title">My Notes</span>
                    </div>
                    <button class="delete-btn" onclick="deleteAllNotes()">
                        <img src="../images/delete.png" alt="Âà†Èô§" class="delete-icon">
                    </button>
                </div>
                
                <!-- Á¨îËÆ∞ÂÜÖÂÆπÂå∫Âüü -->
                <div class="notebook-content" id="notebookContent">
                    <!-- Á¨îËÆ∞ÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>
                
                <!-- Â∫ïÈÉ®ÊåáÁ§∫Âô® -->
                <div class="notebook-indicators">
                    <div class="indicator active" onclick="goToPage(0)"></div>
                    <div class="indicator" onclick="goToPage(1)"></div>
                    <div class="indicator" onclick="goToPage(2)"></div>
                </div>
            </div>
        </div>
        
        <!-- Â∫ïÈÉ®Ê†áÁ≠æÊ†è - Ë¶ÜÁõñÂú®ÂºπÁ™ó‰∏äÈù¢ -->
        <div class="notebook-bottom-bar" id="notebookBottomBar">
            <div class="notebook-tab active">
                <img src="../images/notebook.svg" alt="Á¨îËÆ∞Êú¨" class="tab-icon">
            </div>
            <div class="notebook-tab">
                <img src="../images/processing.svg" alt="ËøõÂ∫¶" class="tab-icon">
            </div>
            <div class="notebook-tab">
                <img src="../images/light.svg" alt="‰∫ÆÂ∫¶" class="tab-icon">
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáèÂÆö‰πâ
        let readingTime = 0;
        let exitCount = 0;
        let totalStrokes = 0;
        let startTime = Date.now();
        let highlightedElements = []; // Â≠òÂÇ®ÊâÄÊúâÂàíÁ∫øÂÖÉÁ¥†ÁöÑ‰ø°ÊÅØ
        let currentPage = 0; // ÂΩìÂâçÈ°µÁ†Å
        let notesPerPage = 3; // ÊØèÈ°µÊòæÁ§∫ÁöÑÁ¨îËÆ∞Êï∞Èáè
        
        // ÊñáÊú¨ÈÄâÊã©Áõ∏ÂÖ≥ÂèòÈáè
        let isSelectingText = false;
        let selectionStartElement = null;
        let selectionEndElement = null;
        let highlightTimer = null;
        let isLongPressing = false;
        
        // ÂèñÊ∂àÈïøÊåâËÆ°Êó∂
        function cancelHighlightTimer() {
            if (highlightTimer) {
                clearTimeout(highlightTimer);
                highlightTimer = null;
            }
            isLongPressing = false;
        }
        
        // ÈïøÊåâÂºÄÂßãËÆ°Êó∂ - ÊîØÊåÅËß¶Êë∏ÂíåÈº†Ê†á
        function startHighlightTimer(e) {
            // ÈïøÊåâÂäüËÉΩÂ∑≤Âà†Èô§Ôºå‰ΩøÁî®ÁΩëÈ°µÁ´ØËá™Â∏¶ÁöÑÈïøÊåâÈÄâ‰∏≠
        }
        
        // ÂêØÁî®ÁΩëÈ°µÁ´ØËá™Â∏¶ÊñáÊú¨ÈÄâÊã©ÂäüËÉΩ
        function enableNativeTextSelection() {
            // ÁõëÂê¨ÊñáÊú¨ÈÄâÊã©‰∫ã‰ª∂
            document.addEventListener('selectionchange', function() {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText && selectedText.length > 0) {
                    showSelectionMenu(selection);
                } else {
                    hideSelectionMenu();
                }
            });
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨ÔºåÈò≤Ê≠¢ÈÄâÊã©ËèúÂçïÁÇπÂáªÊó∂Ëß¶ÂèëÁÅ∞Ëâ≤ÈÅÆÁΩ©
            document.addEventListener('click', function(e) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÈÄâÊã©ËèúÂçïÔºåÈòªÊ≠¢‰∫ã‰ª∂‰º†Êí≠
                if (e.target.closest('#native-selection-menu')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true); // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµ
        }
        
        // ÊòæÁ§∫ÈÄâÊã©ËèúÂçï
        function showSelectionMenu(selection) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑËèúÂçï
            hideSelectionMenu();
            
            // Ëé∑ÂèñÈÄâÊã©ËåÉÂõ¥
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            // ÂàõÂª∫Êìç‰ΩúËèúÂçï
            const actionMenu = document.createElement('div');
            actionMenu.id = 'native-selection-menu';
            actionMenu.style.cssText = `
                position: fixed;
                top: ${rect.top - 50}px;
                left: ${rect.left + rect.width / 2}px;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.9);
                border-radius: 8px;
                padding: 8px 0;
                z-index: 10003;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                min-width: 120px;
            `;
            
            actionMenu.innerHTML = `
                <div class="menu-item" style="
                    padding: 8px 16px;
                    color: white;
                    cursor: pointer;
                    font-size: 14px;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    transition: background-color 0.2s ease;
                " data-action="add-to-notes">Ê∑ªÂä†Âà∞Á¨îËÆ∞</div>
                <div class="menu-item" style="
                    padding: 8px 16px;
                    color: white;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background-color 0.2s ease;
                " data-action="cancel">ÂèñÊ∂à</div>
            `;
            
            // Ê∑ªÂä†ËèúÂçïÈ°πÊÇ¨ÂÅúÊïàÊûú
            const menuItems = actionMenu.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                });
            });
            
            // ËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
            actionMenu.addEventListener('click', function(e) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂçïÂáª‰∫ã‰ª∂
                e.preventDefault();
                e.stopPropagation();
                
                const action = e.target.getAttribute('data-action');
                const selectedText = window.getSelection().toString().trim();
                
                if (action === 'add-to-notes' && selectedText) {
                    addToNotesFromSelection(selectedText, selection);
                    hideSelectionMenu();
                } else if (action === 'cancel') {
                    hideSelectionMenu();
                }
            });
            
            document.body.appendChild(actionMenu);
        }
        
        // ÈöêËóèÈÄâÊã©ËèúÂçï
        function hideSelectionMenu() {
            const existingMenu = document.getElementById('native-selection-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
        }
        
        // ‰ªéÈÄâÊã©Ê∑ªÂä†Âà∞Á¨îËÆ∞
        function addToNotesFromSelection(selectedText, selection) {
            // ÂÖà‰øùÂ≠òÂà∞Á¨îËÆ∞Êï∞ÊçÆÂ∫ì
            saveToNotesDatabase(selectedText);
            
            // ÂàõÂª∫È´ò‰∫ÆÊïàÊûú
            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = 'highlighted';
            span.style.cssText = `
                background-color: #FFEB3B;
                padding: 2px 4px;
                border-radius: 3px;
                cursor: pointer;
                display: inline-block;
                margin: 2px 0;
            `;
            
            // ËÆæÁΩÆÈ´ò‰∫ÆÊñáÊú¨ÂÜÖÂÆπ
            span.textContent = selectedText;
            
            try {
                // Â∞ùËØï‰ΩøÁî®surroundContents
                range.surroundContents(span);
            } catch (error) {
                try {
                    // Â§áÈÄâÊñπÊ°àÔºö‰ΩøÁî®extractContentsÂíåinsertNode
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                } catch (error2) {
                    // ÊúÄÂêéÁöÑÂ§áÈÄâÊñπÊ°àÔºöÁõ¥Êé•ÊõøÊç¢ÊñáÊú¨ÂÜÖÂÆπ
                    const parentElement = range.commonAncestorContainer.parentElement || range.commonAncestorContainer;
                    if (parentElement && parentElement.textContent) {
                        const originalText = parentElement.textContent;
                        const newText = originalText.replace(selectedText, span.outerHTML);
                        parentElement.innerHTML = newText;
                    }
                }
            }
            
            // Ê∏ÖÈô§ÈÄâÊã©
            selection.removeAllRanges();
            
            // Á°Æ‰øùËèúÂçïË¢´ÈöêËóè
            hideSelectionMenu();
            
        }
        
        
        // ÂèñÊ∂àÈÄâÊã©ÔºàÂ∑≤Âà†Èô§Ëá™ÂÆö‰πâÈÄâÊã©ÂäüËÉΩÔºâ
        function cancelSelection() {
            // ÂèñÊ∂àÈÄâÊã©ÂäüËÉΩÂ∑≤Âà†Èô§
        }
        
        // ‰øùÂ≠òÂà∞Á¨îËÆ∞Êï∞ÊçÆÂ∫ì
        function saveToNotesDatabase(text) {
            // ÂàõÂª∫Á¨îËÆ∞ËÆ∞ÂΩï
            const noteRecord = {
                id: Date.now(),
                text: text,
                timestamp: new Date().toLocaleString(),
                page: 'bookNormal',
                type: 'highlight'
            };
            
            // Ëé∑ÂèñÁé∞ÊúâÁ¨îËÆ∞
            let notes = JSON.parse(localStorage.getItem('notes') || '[]');
            
            // Ê∑ªÂä†Êñ∞Á¨îËÆ∞
            notes.push(noteRecord);
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('notes', JSON.stringify(notes));
            
            // Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑÂàíÁ∫øËÆ°Êï∞
            updateRecordingStrokes();
        }
        
        // Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑÂàíÁ∫øËÆ°Êï∞
        function updateRecordingStrokes() {
            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
            const strokesCount = notes.length;
            
            // Êõ¥Êñ∞recordingÈ°µÈù¢ÊòæÁ§∫
            const strokesElement = document.querySelector('.recording-strokes .recording-number');
            if (strokesElement) {
                strokesElement.textContent = strokesCount;
            }
        }
        
        // ÂÆåÊï¥Êï∞ÊçÆÂ∫ìÁ≥ªÁªü
        class UserBehaviorDatabase {
            constructor() {
                this.dbName = 'ebookReadingDatabase';
                this.version = '1.0';
                this.initDatabase();
            }
            
            initDatabase() {
                // ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ìÁªìÊûÑ
                if (!localStorage.getItem(this.dbName)) {
                    const initialData = {
                        version: this.version,
                        users: {},
                        sessions: {},
                        highlights: {},
                        statistics: {},
                        exports: []
                    };
                    localStorage.setItem(this.dbName, JSON.stringify(initialData));
                    console.log('üíæ Êï∞ÊçÆÂ∫ìÂ∑≤ÂàùÂßãÂåñ');
                }
            }
            
            getCurrentUser() {
                return localStorage.getItem('currentUserId') || 'anonymous';
            }
            
            getCurrentSession() {
                return localStorage.getItem('userSessionStart') || new Date().toISOString();
            }
            
            // ‰øùÂ≠òÁî®Êà∑Ë°å‰∏∫ËÆ∞ÂΩï
            saveBehavior(action, data) {
                try {
                    const userId = this.getCurrentUser();
                    const sessionId = this.getCurrentSession();
                    const timestamp = new Date().toISOString();
                    
                    const record = {
                        id: this.generateId(),
                        userId: userId,
                        sessionId: sessionId,
                        action: action,
                        data: data,
                        timestamp: timestamp,
                        page: 'book_normal'
                    };
                    
                    // Ëé∑ÂèñÊï∞ÊçÆÂ∫ì
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    // ÂàùÂßãÂåñÁî®Êà∑ËÆ∞ÂΩï
                    if (!db.users[userId]) {
                        db.users[userId] = {
                            userId: userId,
                            totalSessions: 0,
                            totalHighlights: 0,
                            totalReadingTime: 0,
                            totalExits: 0,
                            createdAt: timestamp,
                            lastActive: timestamp
                        };
                    }
                    
                    // ÂàùÂßãÂåñ‰ºöËØùËÆ∞ÂΩï
                    if (!db.sessions[sessionId]) {
                        db.sessions[sessionId] = {
                            sessionId: sessionId,
                            userId: userId,
                            startTime: sessionId,
                            endTime: null,
                            highlights: [],
                            readingTime: 0,
                            exits: 0,
                            strokes: 0
                        };
                        db.users[userId].totalSessions++;
                    }
                    
                    // Ê†πÊçÆË°å‰∏∫Á±ªÂûãÂ§ÑÁêÜÊï∞ÊçÆ
                    switch (action) {
                        case 'highlight':
                            this.saveHighlight(db, record);
                            break;
                        case 'delete_highlight':
                            this.deleteHighlight(db, record);
                            break;
                        case 'batch_delete_highlights':
                            this.batchDeleteHighlights(db, record);
                            break;
                        case 'reading_time_update':
                            this.updateReadingTime(db, record);
                            break;
                        case 'page_exit':
                            this.recordPageExit(db, record);
                            break;
                        default:
                            // ÈÄöÁî®ËÆ∞ÂΩï‰øùÂ≠ò
                            if (!db.statistics[userId]) {
                                db.statistics[userId] = [];
                            }
                            db.statistics[userId].push(record);
                    }
                    
                    // Êõ¥Êñ∞Áî®Êà∑ÊúÄÂêéÊ¥ªË∑ÉÊó∂Èó¥
                    db.users[userId].lastActive = timestamp;
                    
                    // ‰øùÂ≠òÊï∞ÊçÆÂ∫ì
                    localStorage.setItem(this.dbName, JSON.stringify(db));
                    
                    console.log('üíæ Â∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì:', action, data);
                    return record.id;
                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error);
                    return null;
                }
            }
            
            // ‰øùÂ≠òÂàíÁ∫øËÆ∞ÂΩï
            saveHighlight(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // ‰øùÂ≠òÂà∞highlightsË°®
                if (!db.highlights[userId]) {
                    db.highlights[userId] = [];
                }
                db.highlights[userId].push(record);
                
                // Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
                db.users[userId].totalHighlights++;
                
                // Êõ¥Êñ∞‰ºöËØùÁªüËÆ°
                db.sessions[sessionId].highlights.push(record.id);
                db.sessions[sessionId].strokes++;
            }
            
            // Âà†Èô§ÂàíÁ∫øËÆ∞ÂΩï
            deleteHighlight(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // ‰ªéhighlightsË°®‰∏≠ÁßªÈô§
                if (db.highlights[userId]) {
                    db.highlights[userId] = db.highlights[userId].filter(h => h.id !== record.data.originalId);
                }
                
                // Êõ¥Êñ∞‰ºöËØùÁªüËÆ°
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].strokes = Math.max(0, db.sessions[sessionId].strokes - 1);
                }
            }
            
            // ÊâπÈáèÂà†Èô§ÂàíÁ∫øËÆ∞ÂΩï
            batchDeleteHighlights(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                const deletedCount = record.data.deletedCount;
                
                // Êõ¥Êñ∞‰ºöËØùÁªüËÆ°
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].strokes = Math.max(0, db.sessions[sessionId].strokes - deletedCount);
                }
            }
            
            // Êõ¥Êñ∞ÈòÖËØªÊó∂Èó¥
            updateReadingTime(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // Êõ¥Êñ∞Áî®Êà∑ÊÄªÈòÖËØªÊó∂Èó¥
                db.users[userId].totalReadingTime = record.data.totalReadingTime;
                
                // Êõ¥Êñ∞‰ºöËØùÈòÖËØªÊó∂Èó¥
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].readingTime = record.data.sessionReadingTime;
                }
            }
            
            // ËÆ∞ÂΩïÈ°µÈù¢ÈÄÄÂá∫
            recordPageExit(db, record) {
                const userId = record.userId;
                const sessionId = record.sessionId;
                
                // Êõ¥Êñ∞Áî®Êà∑ÊÄªÈÄÄÂá∫Ê¨°Êï∞
                db.users[userId].totalExits++;
                
                // Êõ¥Êñ∞‰ºöËØùÈÄÄÂá∫Ê¨°Êï∞
                if (db.sessions[sessionId]) {
                    db.sessions[sessionId].exits++;
                }
            }
            
            // ÁîüÊàêÂîØ‰∏ÄID
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // ÂØºÂá∫Áî®Êà∑Êï∞ÊçÆ
            exportUserData(userId = null) {
                try {
                    const targetUserId = userId || this.getCurrentUser();
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    const exportData = {
                        exportId: this.generateId(),
                        exportTime: new Date().toISOString(),
                        userId: targetUserId,
                        userInfo: db.users[targetUserId] || {},
                        sessions: Object.values(db.sessions).filter(s => s.userId === targetUserId),
                        highlights: db.highlights[targetUserId] || [],
                        statistics: db.statistics[targetUserId] || []
                    };
                    
                    // ‰øùÂ≠òÂØºÂá∫ËÆ∞ÂΩï
                    db.exports.push(exportData);
                    localStorage.setItem(this.dbName, JSON.stringify(db));
                    
                    console.log('üì§ Áî®Êà∑Êï∞ÊçÆÂØºÂá∫ÂÆåÊàê:', exportData);
                    return exportData;
                } catch (error) {
                    console.error('‚ùå ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                    return null;
                }
            }
            
            // Ëé∑ÂèñÁî®Êà∑ÁªüËÆ°‰ø°ÊÅØ
            getUserStats(userId = null) {
                try {
                    const targetUserId = userId || this.getCurrentUser();
                    const db = JSON.parse(localStorage.getItem(this.dbName));
                    
                    return {
                        user: db.users[targetUserId] || {},
                        currentSession: db.sessions[this.getCurrentSession()] || {},
                        totalHighlights: db.highlights[targetUserId]?.length || 0,
                        totalExports: db.exports.filter(e => e.userId === targetUserId).length
                    };
                } catch (error) {
                    console.error('‚ùå Ëé∑ÂèñÁî®Êà∑ÁªüËÆ°Â§±Ë¥•:', error);
                    return null;
                }
            }
        }
        
        // ÂàõÂª∫Êï∞ÊçÆÂ∫ìÂÆû‰æã
        const userDB = new UserBehaviorDatabase();
        
        // ÂÖºÂÆπÊÄßÂáΩÊï∞
        function saveToDatabase(action, data) {
            return userDB.saveBehavior(action, data);
        }
        
        function loadFromDatabase() {
            return userDB.getUserStats();
        }
        
        
        // ÂØºÂá∫Áî®Êà∑Êï∞ÊçÆ
        function exportUserData() {
            console.log('üì§ ÂºÄÂßãÂØºÂá∫Áî®Êà∑Êï∞ÊçÆ');
            const exportData = userDB.exportUserData();
            if (exportData) {
                console.log('üì§ ÂØºÂá∫ÂÆåÊàêÔºåÊï∞ÊçÆ:', exportData);
                alert('Êï∞ÊçÆÂØºÂá∫ÂÆåÊàêÔºÅËØ∑Êü•ÁúãÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÁªÜÊï∞ÊçÆ„ÄÇ');
            } else {
                console.log('‚ùå ÂØºÂá∫Â§±Ë¥•');
                alert('Êï∞ÊçÆÂØºÂá∫Â§±Ë¥•ÔºÅ');
            }
        }
        
        // ÊòæÁ§∫ÁÅ∞Ëâ≤ÈÅÆÁΩ©ÔºàoverlayÔºâ
        function showOverlay() {
            console.log('üì± ÊòæÁ§∫ÁÅ∞Ëâ≤ÈÅÆÁΩ©');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÈÅÆÁΩ©
            const existingOverlay = document.querySelector('.overlay-mask');
            if (existingOverlay) {
                console.log('üì± ÈÅÆÁΩ©Â∑≤Â≠òÂú®Ôºå‰∏çÈáçÂ§çÂàõÂª∫');
                return;
            }
            
            // ÂàõÂª∫ÁÅ∞Ëâ≤ÈÅÆÁΩ©
            const overlay = document.createElement('div');
            overlay.className = 'overlay-mask';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(157, 157, 157, 0.3);
                z-index: 9998;
                -webkit-backdrop-filter: blur(2px);
                backdrop-filter: blur(2px);
            `;
            
            // ÂàõÂª∫Â∫ïÈÉ®ÂØºËà™Ê†è
            const bottomBar = document.createElement('div');
            bottomBar.className = 'overlay-bottom-bar';
            bottomBar.style.cssText = `
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 80px;
                background: rgba(255, 255, 255, 0.95);
                -webkit-backdrop-filter: blur(40%);
                backdrop-filter: blur(40%);
                border-radius: 30px 30px 0 0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                z-index: 9999;
            `;
            
            // Ê∑ªÂä†ÂØºËà™ÂõæÊ†á
            const icons = ['notebook', 'processing', 'light'];
            icons.forEach((icon, index) => {
                const iconDiv = document.createElement('div');
                iconDiv.className = `overlay-icon ${icon}`;
                iconDiv.style.cssText = `
                    width: 30px;
                    height: 30px;
                    background: #ccc;
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                `;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                iconDiv.onclick = () => {
                    console.log(`üì± ÁÇπÂáª‰∫Ü${icon}ÂõæÊ†á`);
                    if (icon === 'notebook') {
                        // ËøõÂÖ•ÊñáÊú¨ÈÄâÊã©Ê®°Âºè
                        enterTextSelectionMode();
                    } else if (icon === 'processing') {
                        showRecording();
                    } else if (icon === 'light') {
                        console.log('üì± ‰∫ÆÂ∫¶Ë∞ÉËäÇÂäüËÉΩ');
                    }
                };
                
                bottomBar.appendChild(iconDiv);
            });
            
            // Ê∑ªÂä†ÁÇπÂáªÂÖ≥Èó≠‰∫ã‰ª∂
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    console.log('üì± ÁÇπÂáªÈÅÆÁΩ©Â§ñÈÉ®ÔºåÂÖ≥Èó≠ÈÅÆÁΩ©');
                    closeOverlay();
                }
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(bottomBar);
            
            console.log('üì± ÁÅ∞Ëâ≤ÈÅÆÁΩ©Â∑≤ÊòæÁ§∫');
        }
        
        // ÂÖ≥Èó≠ÁÅ∞Ëâ≤ÈÅÆÁΩ©
        function closeOverlay() {
            console.log('üì± ÂÖ≥Èó≠ÁÅ∞Ëâ≤ÈÅÆÁΩ©');
            
            const overlay = document.querySelector('.overlay-mask');
            const bottomBar = document.querySelector('.overlay-bottom-bar');
            
            if (overlay) overlay.remove();
            if (bottomBar) bottomBar.remove();
            
            console.log('üì± ÁÅ∞Ëâ≤ÈÅÆÁΩ©Â∑≤ÂÖ≥Èó≠');
        }
        
        // ÊòæÁ§∫recordingÁªüËÆ°ÂºπÁ™ó
        
        // ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó
        function showProgressModal() {
            console.log('üìä ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó');
            
            // Ê£ÄÊü•ÊòØÂê¶Âú®overlayÊ®°Âºè‰∏ã
            const overlayContainer = document.querySelector('.overlay-container');
            if (!overlayContainer) {
                console.log('‚ö†Ô∏è ‰∏çÂú®overlayÊ®°ÂºèÔºåÂÖàÊâìÂºÄoverlay');
                createOverlay();
                // Á≠âÂæÖoverlayÂàõÂª∫ÂÆåÊàêÂêéÂÜçÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó
                setTimeout(() => {
                    showProgressModalInOverlay();
                }, 100);
                return;
            }
            
            showProgressModalInOverlay();
        }
        
        // Âú®overlay‰∏≠ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó
        function showProgressModalInOverlay() {
            const progressModal = document.getElementById('progressModal');
            if (progressModal) {
                // ÂÖàÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóß‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.removeEventListener('click', handleProgressModalClick);
                
                // ËÆæÁΩÆÊòæÁ§∫Áä∂ÊÄÅÔºå‰ªéÂ∫ïÈÉ®ÊªëÂÖ•ÔºàÊäòÂè†ÊïàÊûúÔºâ
                progressModal.style.visibility = 'visible';
                progressModal.style.opacity = '1';
                progressModal.style.zIndex = '10002'; // Âú®overlay‰πã‰∏ä
                progressModal.style.transform = 'translateX(-50%) translateY(0)';
                
                // Êõ¥Êñ∞ÈòÖËØªÊó∂Èó¥ÔºàÁúüÂÆûÊï∞ÊçÆÔºâ
                updateRealReadingTime();
                
                // Êõ¥Êñ∞ÈòÖËØªËøõÂ∫¶ÔºàÂÆûÊó∂Êï∞ÊçÆÔºâ
                updateRealReadingProgress();
                
                // Êõ¥Êñ∞‰∏ÄÂë®ÈòÖËØªÈ¢ëÊ¨°ÔºàÁî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÔºâ
                updateRealWeeklyReadingFrequency();
                
                // ÂàùÂßãÂåñËøõÂ∫¶Êù°ÊãñÊãΩÂäüËÉΩÔºàÈîöÂÆöÂéüÊñáÊú¨Ôºâ
                initProgressBarWithTextAnchor();
                
                // ÂàùÂßãÂåñËøõÂ∫¶Êù°‰ΩçÁΩÆ
                initProgressBarPosition();
                
                // Ê∑ªÂä†ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂäüËÉΩ
                setTimeout(() => {
                    document.addEventListener('click', handleProgressModalClick);
                }, 100);
            } else {
                console.error('‚ùå ËøõÂ∫¶ÂºπÁ™óÂÖÉÁ¥†Êú™ÊâæÂà∞');
            }
        }
        
        // Â§ÑÁêÜËøõÂ∫¶ÂºπÁ™óÁÇπÂáª‰∫ã‰ª∂
        function handleProgressModalClick(e) {
            const progressModal = document.getElementById('progressModal');
            if (progressModal && progressModal.style.visibility === 'visible') {
                // Ê£ÄÊü•ÁÇπÂáªÁöÑÁõÆÊ†á
                const target = e.target;
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂºπÁ™óÊú¨Ë∫´Ôºå‰∏çÂÖ≥Èó≠
                if (progressModal.contains(target)) {
                    return;
                }
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ∫ïÈÉ®ËèúÂçïÊ†èÔºå‰∏çÂÖ≥Èó≠
                const bottomBar = document.querySelector('.overlay-bottom-bar');
                if (bottomBar && bottomBar.contains(target)) {
                    return;
                }
                
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØoverlayÁöÑÂ∫ïÈÉ®ÂØºËà™Ê†èÔºå‰∏çÂÖ≥Èó≠
                const overlayBottomBar = document.querySelector('.bottom-label-bar');
                if (overlayBottomBar && overlayBottomBar.contains(target)) {
                    return;
                }
                
                // ÂÖ∂‰ªñÊÉÖÂÜµÂÖ≥Èó≠ÂºπÁ™ó
                console.log('üì± ÁÇπÂáªËøõÂ∫¶ÂºπÁ™óÂ§ñÈÉ®ÔºåÂÖ≥Èó≠ÂºπÁ™ó');
                hideProgressModal();
                // ÂÖ≥Èó≠overlayÔºåËøîÂõûbookNormalÈ°µÈù¢
                closeOverlay();
            }
        }
        
        // ÈöêËóèËøõÂ∫¶ÂºπÁ™ó
        function hideProgressModal() {
            const progressModal = document.getElementById('progressModal');
            if (progressModal) {
                progressModal.style.visibility = 'hidden';
                progressModal.style.opacity = '0';
                progressModal.style.transform = 'translateX(-50%) translateY(100%)';
                
                // ÁßªÈô§ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
                document.removeEventListener('click', handleProgressModalClick);
            }
        }
        
        // Êõ¥Êñ∞ÈòÖËØªÊó∂Èó¥
        function updateReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            const timeElements = document.querySelectorAll('#progressModal div[style*="font-size: 24px"]');
            if (timeElements.length >= 2) {
                timeElements[0].textContent = hours;
                timeElements[1].textContent = minutes;
            }
        }
        
        // Êõ¥Êñ∞ÈòÖËØªËøõÂ∫¶
        function updateReadingProgress() {
            const totalTextLength = document.getElementById('textContent').textContent.length;
            const currentPosition = localStorage.getItem('currentReadingPosition') || 0;
            const progress = Math.round((currentPosition / totalTextLength) * 100);
            
            // Êõ¥Êñ∞ÁôæÂàÜÊØîÊòæÁ§∫
            const progressElement = document.querySelector('#progressModal div[style*="font-size: 24px"][style*="color: #333333"]');
            if (progressElement) {
                progressElement.textContent = progress;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            if (progressFill && progressHandle) {
                const percentage = Math.min(100, Math.max(0, progress));
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 15px)`;
            }
        }
        
        // Êõ¥Êñ∞‰∏ÄÂë®ÈòÖËØªÈ¢ëÊ¨°
        function updateWeeklyReadingFrequency() {
            const weeklyData = JSON.parse(localStorage.getItem('weeklyReadingData') || '[]');
            const bars = document.querySelectorAll('#progressModal div[style*="width: 3px"][style*="background: #19191B"]');
            
            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
            if (weeklyData.length === 0) {
                const defaultHeights = [20, 5, 12, 1, 16, 12, 22];
                bars.forEach((bar, index) => {
                    if (index < defaultHeights.length) {
                        bar.style.height = defaultHeights[index] + 'px';
                    }
                });
                return;
            }
            
            // Ê†πÊçÆÂÆûÈôÖÊï∞ÊçÆËÆæÁΩÆÈ´òÂ∫¶
            bars.forEach((bar, index) => {
                if (index < weeklyData.length) {
                    const readingTime = weeklyData[index]; // ÂàÜÈíü
                    let height;
                    if (readingTime >= 60) {
                        height = 20; // Ë∂ÖËøá1Â∞èÊó∂
                    } else if (readingTime >= 10) {
                        height = 12; // 10-60ÂàÜÈíü
                    } else {
                        height = 6; // Â∞è‰∫é10ÂàÜÈíü
                    }
                    bar.style.height = height + 'px';
                }
            });
        }
        
        // ÂàùÂßãÂåñËøõÂ∫¶Êù°ÊãñÊãΩÂäüËÉΩ
        function initProgressBar() {
            const progressHandle = document.getElementById('progressHandle');
            const progressFill = document.getElementById('progressFill');
            const progressContainer = progressHandle.parentElement;
            
            if (!progressHandle || !progressFill || !progressContainer) return;
            
            let isDragging = false;
            
            // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
            progressHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });
            
            // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const containerRect = progressContainer.getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 15px)`;
                
                // Êõ¥Êñ∞ÁôæÂàÜÊØîÊòæÁ§∫
                const progressElement = document.querySelector('#progressModal div[style*="font-size: 24px"][style*="color: #333333"]');
                if (progressElement) {
                    progressElement.textContent = Math.round(percentage);
                }
                
                // ÂÆö‰ΩçÂà∞ÂØπÂ∫îÊñáÊú¨‰ΩçÁΩÆ
                scrollToTextPosition(percentage);
            });
            
            // Èº†Ê†áÊä¨Ëµ∑‰∫ã‰ª∂
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    // ‰øùÂ≠òÂΩìÂâç‰ΩçÁΩÆ
                    const percentage = parseFloat(progressFill.style.width);
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
        }
        
        // Ê†πÊçÆËøõÂ∫¶ÁôæÂàÜÊØîÊªöÂä®Âà∞ÂØπÂ∫îÊñáÊú¨‰ΩçÁΩÆ
        function scrollToTextPosition(percentage) {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            const scrollHeight = textContent.scrollHeight - textContent.clientHeight;
            const targetScrollTop = (scrollHeight * percentage) / 100;
            
            textContent.scrollTo({
                top: targetScrollTop,
                behavior: 'smooth'
            });
        }
        
        // ÂàùÂßãÂåñ‰∏ÄÂë®ÈòÖËØªÊï∞ÊçÆÔºàÁ§∫‰æãÊï∞ÊçÆÔºâ
        function initWeeklyReadingData() {
            const weeklyData = localStorage.getItem('weeklyReadingData');
            if (!weeklyData) {
                // ËÆæÁΩÆÁ§∫‰æãÊï∞ÊçÆÔºö7Â§©ÁöÑÈòÖËØªÊó∂Èó¥ÔºàÂàÜÈíüÔºâ
                const sampleData = [120, 30, 75, 5, 90, 60, 135]; // ÂØπÂ∫îËÆæËÆ°Á®ø‰∏≠ÁöÑÈ´òÂ∫¶
                localStorage.setItem('weeklyReadingData', JSON.stringify(sampleData));
            }
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçÈòÖËØª‰ΩçÁΩÆ
        function updateCurrentReadingPosition() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            const scrollTop = textContent.scrollTop;
            const scrollHeight = textContent.scrollHeight - textContent.clientHeight;
            const percentage = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            
            localStorage.setItem('currentReadingPosition', percentage);
        }
        
        // Êõ¥Êñ∞ÁúüÂÆûÈòÖËØªÊó∂Èó¥
        function updateRealReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            const hoursElement = document.getElementById('readingHours');
            const minutesElement = document.getElementById('readingMinutes');
            
            if (hoursElement) hoursElement.textContent = hours;
            if (minutesElement) minutesElement.textContent = minutes;
        }
        
        // Êõ¥Êñ∞ÁúüÂÆûÈòÖËØªËøõÂ∫¶
        function updateRealReadingProgress() {
            const readingContent = document.getElementById('readingContent');
            if (!readingContent) return;
            
            const scrollTop = readingContent.scrollTop;
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const percentage = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
            
            const progressElement = document.getElementById('readingProgress');
            if (progressElement) {
                progressElement.textContent = percentage;
            }
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            if (progressFill && progressHandle) {
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
            }
            
            // ‰øùÂ≠òÂΩìÂâçËøõÂ∫¶Âà∞localStorage
            localStorage.setItem('currentReadingPosition', percentage);
        }
        
        // Êõ¥Êñ∞ÁúüÂÆû‰∏ÄÂë®ÈòÖËØªÈ¢ëÊ¨°
        function updateRealWeeklyReadingFrequency() {
            // Ëé∑ÂèñËøáÂéª7Â§©ÁöÑÈòÖËØªÊï∞ÊçÆ
            const weeklyData = JSON.parse(localStorage.getItem('weeklyReadingData') || '[]');
            const bars = document.querySelectorAll('#weeklyBars div');
            
            // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ
            if (weeklyData.length === 0) {
                const defaultHeights = [8, 12, 6, 14, 18, 10, 16];
                bars.forEach((bar, index) => {
                    if (index < defaultHeights.length) {
                        bar.style.height = defaultHeights[index] + 'px';
                    }
                });
                return;
            }
            
            // Ê†πÊçÆÂÆûÈôÖÊï∞ÊçÆËÆæÁΩÆÈ´òÂ∫¶
            bars.forEach((bar, index) => {
                if (index < weeklyData.length) {
                    const readingTime = weeklyData[index]; // ÂàÜÈíü
                    let height;
                    if (readingTime >= 60) {
                        height = 18; // Ë∂ÖËøá1Â∞èÊó∂
                    } else if (readingTime >= 10) {
                        height = 12; // 10-60ÂàÜÈíü
                    } else {
                        height = 6; // Â∞è‰∫é10ÂàÜÈíü
                    }
                    bar.style.height = height + 'px';
                }
            });
        }
        
        // ÂàùÂßãÂåñËøõÂ∫¶Êù°ÊãñÊãΩÂäüËÉΩÔºàÈîöÂÆöÂéüÊñáÊú¨Ôºâ
        function initProgressBarWithTextAnchor() {
            const progressHandle = document.getElementById('progressHandle');
            const progressFill = document.getElementById('progressFill');
            const progressContainer = progressHandle.parentElement;
            
            if (!progressHandle || !progressFill || !progressContainer) return;
            
            let isDragging = false;
            
            // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
            progressHandle.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });
            
            // Èº†Ê†áÁßªÂä®‰∫ã‰ª∂
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const containerRect = progressContainer.getBoundingClientRect();
                const x = e.clientX - containerRect.left;
                const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
                
                // Êõ¥Êñ∞ÁôæÂàÜÊØîÊòæÁ§∫
                const progressElement = document.getElementById('readingProgress');
                if (progressElement) {
                    progressElement.textContent = Math.round(percentage);
                }
                
                // ÈîöÂÆöÂà∞ÂéüÊñáÊú¨‰ΩçÁΩÆ
                anchorToTextPosition(percentage);
            });
            
            // Èº†Ê†áÊä¨Ëµ∑‰∫ã‰ª∂
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    // ‰øùÂ≠òÂΩìÂâç‰ΩçÁΩÆ
                    const percentage = parseFloat(progressFill.style.width);
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
            
            // ÁÇπÂáªËøõÂ∫¶Êù°ËΩ®ÈÅì‰πüÂèØ‰ª•Ë∑≥ËΩ¨
            progressContainer.addEventListener('click', function(e) {
                if (e.target === progressContainer || e.target === progressFill) {
                    const containerRect = progressContainer.getBoundingClientRect();
                    const x = e.clientX - containerRect.left;
                    const percentage = Math.max(0, Math.min(100, (x / containerRect.width) * 100));
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                    progressFill.style.width = percentage + '%';
                    progressHandle.style.left = `calc(${percentage}% - 14px)`;
                    
                    // Êõ¥Êñ∞ÁôæÂàÜÊØîÊòæÁ§∫
                    const progressElement = document.getElementById('readingProgress');
                    if (progressElement) {
                        progressElement.textContent = Math.round(percentage);
                    }
                    
                    // ÈîöÂÆöÂà∞ÂéüÊñáÊú¨‰ΩçÁΩÆ
                    anchorToTextPosition(percentage);
                    
                    // ‰øùÂ≠òÂΩìÂâç‰ΩçÁΩÆ
                    localStorage.setItem('currentReadingPosition', percentage);
                }
            });
        }
        
        // ÈîöÂÆöÂà∞ÊñáÊú¨‰ΩçÁΩÆ
        function anchorToTextPosition(percentage) {
            // ‰ΩøÁî®readingContent‰Ωú‰∏∫‰∏ªË¶ÅÊªöÂä®ÂÆπÂô®
            const readingContent = document.getElementById('readingContent');
            
            if (!readingContent) {
                console.warn('Êú™ÊâæÂà∞readingContentÂÆπÂô®');
                return;
            }
            
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const targetScrollTop = (scrollHeight * percentage) / 100;
            
            console.log(`üìñ Ë∑≥ËΩ¨Âà∞ÊñáÊú¨‰ΩçÁΩÆ: ${percentage}% (${targetScrollTop}px)`);
            console.log(`üìñ ÂÆπÂô®‰ø°ÊÅØ: scrollHeight=${readingContent.scrollHeight}, clientHeight=${readingContent.clientHeight}, ÂèØÊªöÂä®È´òÂ∫¶=${scrollHeight}`);
            
            readingContent.scrollTo({
                top: targetScrollTop,
                behavior: 'smooth'
            });
        }
        
        // ÂàùÂßãÂåñËøõÂ∫¶Êù°‰ΩçÁΩÆ
        function initProgressBarPosition() {
            // ‰ΩøÁî®readingContent‰Ωú‰∏∫‰∏ªË¶ÅÊªöÂä®ÂÆπÂô®
            const readingContent = document.getElementById('readingContent');
            
            if (!readingContent) {
                console.warn('Êú™ÊâæÂà∞readingContentÂÆπÂô®ÔºåÊó†Ê≥ïÂàùÂßãÂåñËøõÂ∫¶Êù°‰ΩçÁΩÆ');
                return;
            }
            
            const scrollTop = readingContent.scrollTop;
            const scrollHeight = readingContent.scrollHeight - readingContent.clientHeight;
            const percentage = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
            
            console.log(`üìä ÂàùÂßãÂåñËøõÂ∫¶Êù°‰ΩçÁΩÆ: ${percentage}%`);
            console.log(`üìä ÂÆπÂô®‰ø°ÊÅØ: scrollTop=${scrollTop}, scrollHeight=${readingContent.scrollHeight}, clientHeight=${readingContent.clientHeight}, ÂèØÊªöÂä®È´òÂ∫¶=${scrollHeight}`);
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÊòæÁ§∫
            const progressFill = document.getElementById('progressFill');
            const progressHandle = document.getElementById('progressHandle');
            const progressElement = document.getElementById('readingProgress');
            
            if (progressFill && progressHandle) {
                progressFill.style.width = percentage + '%';
                progressHandle.style.left = `calc(${percentage}% - 14px)`;
            }
            
            if (progressElement) {
                progressElement.textContent = percentage;
            }
        }
        
        // ÂàùÂßãÂåñÁïåÈù¢ÂÅúÁïôÊó∂Èó¥ËÆ∞ÂΩï
        function initPageStayTime() {
            // ËÆ∞ÂΩïÈ°µÈù¢ËøõÂÖ•Êó∂Èó¥
            const pageEnterTime = Date.now();
            localStorage.setItem('pageEnterTime', pageEnterTime);
            
            console.log('‚è∞ ÂºÄÂßãËÆ∞ÂΩïÁïåÈù¢ÂÅúÁïôÊó∂Èó¥ÔºåÈ°µÈù¢ËøõÂÖ•Êó∂Èó¥:', new Date(pageEnterTime).toLocaleTimeString());
            
            // ÂàùÂßãÂåñÈÄÄÂá∫ËÆ∞ÂΩïÂäüËÉΩ
            initExitTracking();
            
            // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÂÅúÁïôÊó∂Èó¥
            const timeInterval = setInterval(() => {
                const currentTime = Date.now();
                const stayTime = Math.floor((currentTime - pageEnterTime) / 1000); // Áßí
                
                // Êõ¥Êñ∞reading time
                localStorage.setItem('readingTime', stayTime);
                
                // Êõ¥Êñ∞processingÂºπÁ™ó‰∏≠ÁöÑÊó∂Èó¥ÊòæÁ§∫
                updateRealReadingTime();
                
                // Êõ¥Êñ∞recordingÂºπÁ™ó‰∏≠ÁöÑÊó∂Èó¥ÊòæÁ§∫
                updateRecordingReadingTime();
                
            }, 1000);
            
            // È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÊúÄÁªàÊó∂Èó¥
            window.addEventListener('beforeunload', function() {
                const finalTime = Math.floor((Date.now() - pageEnterTime) / 1000);
                localStorage.setItem('readingTime', finalTime);
                clearInterval(timeInterval);
            });
        }
        
        // ÂàùÂßãÂåñÈÄÄÂá∫Ë∑üË∏™ÂäüËÉΩ
        function initExitTracking() {
            let isPageVisible = true;
            let exitStartTime = null;
            let exitCount = parseInt(localStorage.getItem('exitCount') || '0');
            let isTrackingExit = false; // Èò≤Ê≠¢ÈáçÂ§çËÆ°Êï∞
            let isInitialLoad = true; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÂàùÂßãÂä†ËΩΩ
            
            console.log('üì± ÂàùÂßãÂåñÈ°µÈù¢ÈÄÄÂá∫Ë∑üË∏™ÂäüËÉΩÔºåÂΩìÂâçÈÄÄÂá∫Ê¨°Êï∞:', exitCount);
            
            // Â∞ÜÂèòÈáè‰øùÂ≠òÂà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºåÁ°Æ‰øùÂú®beforeunload‰∫ã‰ª∂‰∏≠ËÉΩËÆøÈóÆ
            window.exitTrackingState = {
                isPageVisible,
                exitStartTime,
                exitCount,
                isTrackingExit,
                isInitialLoad
            };
            
            // Âª∂ËøüÂêØÂä®ÈÄÄÂá∫Ë∑üË∏™ÔºåÈÅøÂÖçÈ°µÈù¢Âä†ËΩΩÊó∂ÁöÑËØØËß¶Âèë
            setTimeout(() => {
                isInitialLoad = false;
                window.exitTrackingState.isInitialLoad = false; // ÂêåÊ≠•Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                console.log('üì± ÈÄÄÂá∫Ë∑üË∏™Â∑≤ÊøÄÊ¥ªÔºåÂºÄÂßãÁõëÂê¨È°µÈù¢Áä∂ÊÄÅ');
            }, 1000); // 1ÁßíÂêéÊøÄÊ¥ª
            
            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ‰∫ã‰ª∂
            document.addEventListener('visibilitychange', function() {
                console.log('üì± È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ:', document.visibilityState);
                console.log('üì± ÂΩìÂâçÁä∂ÊÄÅ:', { isPageVisible, isTrackingExit, isInitialLoad, exitStartTime: exitStartTime ? new Date(exitStartTime).toLocaleTimeString() : null });
                
                if (document.hidden) {
                    // È°µÈù¢Ë¢´ÈöêËóèÔºàÁî®Êà∑ÂàáÊç¢Âà∞ÂÖ∂‰ªñÂ∫îÁî®ÊàñÈ°µÈù¢ÂØºËà™Ôºâ
                    if (isPageVisible && !isTrackingExit && !isInitialLoad) {
                        isPageVisible = false;
                        isTrackingExit = true;
                        exitStartTime = Date.now();
                        console.log('üì± È°µÈù¢Â§±ÂéªÁÑ¶ÁÇπÔºåÂºÄÂßãËÆ∞ÂΩïÈÄÄÂá∫Êó∂Èó¥ÔºåÊó∂Èó¥Êà≥:', new Date(exitStartTime).toLocaleTimeString());
                        
                        // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                        window.exitTrackingState.isPageVisible = isPageVisible;
                        window.exitTrackingState.isTrackingExit = isTrackingExit;
                        window.exitTrackingState.exitStartTime = exitStartTime;
                    } else {
                        console.log('üì± ‰∏çÊª°Ë∂≥Â§±ÂéªÁÑ¶ÁÇπËÆ∞ÂΩïÊù°‰ª∂:', { isPageVisible, isTrackingExit, isInitialLoad });
                    }
                } else {
                    // È°µÈù¢ÈáçÊñ∞ÂèØËßÅ
                    if (!isPageVisible && exitStartTime && isTrackingExit) {
                        isPageVisible = true;
                        isTrackingExit = false;
                        const exitDuration = Math.floor((Date.now() - exitStartTime) / 1000);
                        
                        console.log(`üì± È°µÈù¢ÈáçÊñ∞Ëé∑ÂæóÁÑ¶ÁÇπÔºåÈÄÄÂá∫Êó∂Èïø: ${exitDuration}Áßí`);
                        
                        // Âè™ÊúâÈÄÄÂá∫Êó∂ÈïøÂ§ß‰∫é1ÁßíÊâçËÆ∞ÂΩïÔºàÈÅøÂÖçËØØËß¶ÂèëÔºâ
                        if (exitDuration >= 1) {
                            exitCount++;
                            
                            // ËÆ∞ÂΩïÈÄÄÂá∫‰ø°ÊÅØ
                            const exitRecord = {
                                timestamp: new Date().toISOString(),
                                duration: exitDuration,
                                exitNumber: exitCount,
                                exitStartTime: new Date(exitStartTime).toISOString(),
                                exitEndTime: new Date().toISOString()
                            };
                            
                            // ‰øùÂ≠òÈÄÄÂá∫ËÆ∞ÂΩï
                            let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                            exitHistory.push(exitRecord);
                            localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                            localStorage.setItem('exitCount', exitCount.toString());
                            
                            console.log(`üì± ËÆ∞ÂΩïÈÄÄÂá∫ÔºåÊÄªÈÄÄÂá∫Ê¨°Êï∞: ${exitCount}`);
                            console.log('üì± ÈÄÄÂá∫ËÆ∞ÂΩïËØ¶ÊÉÖ:', exitRecord);
                            
                            // Êõ¥Êñ∞recordingÂºπÁ™ó‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞ÊòæÁ§∫
                            updateRecordingExitCount();
                        } else {
                            console.log(`üì± ÈÄÄÂá∫Êó∂ÈïøËøáÁü≠(${exitDuration}Áßí)Ôºå‰∏çËÆ∞ÂΩïÈÄÄÂá∫`);
                        }
                        
                        exitStartTime = null;
                        
                        // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                        window.exitTrackingState.isPageVisible = isPageVisible;
                        window.exitTrackingState.isTrackingExit = isTrackingExit;
                        window.exitTrackingState.exitStartTime = exitStartTime;
                        window.exitTrackingState.exitCount = exitCount;
                    } else {
                        console.log('üì± ‰∏çÊª°Ë∂≥ÈáçÊñ∞Ëé∑ÂæóÁÑ¶ÁÇπËÆ∞ÂΩïÊù°‰ª∂:', { isPageVisible, exitStartTime: exitStartTime ? new Date(exitStartTime).toLocaleTimeString() : null, isTrackingExit });
                    }
                }
            });
            
            // È°µÈù¢Âç∏ËΩΩ‰∫ã‰ª∂ÔºàÊ£ÄÊµãÈ°µÈù¢ÂØºËà™Ôºâ
            window.addEventListener('beforeunload', function() {
                const state = window.exitTrackingState;
                console.log('üì± È°µÈù¢Âç≥Â∞ÜÂç∏ËΩΩÔºåÊ£ÄÊü•ÈÄÄÂá∫Áä∂ÊÄÅ:', { 
                    isTrackingExit: state.isTrackingExit, 
                    exitStartTime: state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : null,
                    isInitialLoad: state.isInitialLoad
                });
                
                if (state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                    const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                    console.log(`üì± È°µÈù¢Âç∏ËΩΩÔºåÈÄÄÂá∫Êó∂Èïø: ${exitDuration}Áßí`);
                    
                    if (exitDuration >= 1) {
                        const newExitCount = state.exitCount + 1;
                        
                        // ËÆ∞ÂΩïÈÄÄÂá∫‰ø°ÊÅØ
                        const exitRecord = {
                            timestamp: new Date().toISOString(),
                            duration: exitDuration,
                            exitNumber: newExitCount,
                            exitStartTime: new Date(state.exitStartTime).toISOString(),
                            exitEndTime: new Date().toISOString(),
                            reason: 'page_unload'
                        };
                        
                        // ‰øùÂ≠òÈÄÄÂá∫ËÆ∞ÂΩï
                        let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                        exitHistory.push(exitRecord);
                        localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                        localStorage.setItem('exitCount', newExitCount.toString());
                        
                        console.log(`üì± È°µÈù¢Âç∏ËΩΩËÆ∞ÂΩïÈÄÄÂá∫ÔºåÊÄªÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                        console.log('üì± È°µÈù¢Âç∏ËΩΩÈÄÄÂá∫ËÆ∞ÂΩïËØ¶ÊÉÖ:', exitRecord);
                    } else {
                        console.log(`üì± È°µÈù¢Âç∏ËΩΩÈÄÄÂá∫Êó∂ÈïøËøáÁü≠(${exitDuration}Áßí)Ôºå‰∏çËÆ∞ÂΩïÈÄÄÂá∫`);
                    }
                } else {
                    console.log('üì± È°µÈù¢Âç∏ËΩΩÊó∂Êú™Âú®Ë∑üË∏™ÈÄÄÂá∫Áä∂ÊÄÅÊàñ‰ªçÂú®ÂàùÂßãÂä†ËΩΩ‰∏≠');
                }
            });
            
            
            // È°µÈù¢ÈöêËóè‰∫ã‰ª∂ÔºàÊ£ÄÊµãÈ°µÈù¢ÂØºËà™ÁöÑÂ§áÁî®ÊñπÊ°àÔºâ
            window.addEventListener('pagehide', function() {
                const state = window.exitTrackingState;
                console.log('üì± È°µÈù¢ÈöêËóèÔºåÊ£ÄÊü•ÈÄÄÂá∫Áä∂ÊÄÅ:', { 
                    isTrackingExit: state.isTrackingExit, 
                    exitStartTime: state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : null,
                    isInitialLoad: state.isInitialLoad
                });
                
                if (state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                    const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                    console.log(`üì± È°µÈù¢ÈöêËóèÔºåÈÄÄÂá∫Êó∂Èïø: ${exitDuration}Áßí`);
                    
                    if (exitDuration >= 1) {
                        const newExitCount = state.exitCount + 1;
                        
                        // ËÆ∞ÂΩïÈÄÄÂá∫‰ø°ÊÅØ
                        const exitRecord = {
                            timestamp: new Date().toISOString(),
                            duration: exitDuration,
                            exitNumber: newExitCount,
                            exitStartTime: new Date(state.exitStartTime).toISOString(),
                            exitEndTime: new Date().toISOString(),
                            reason: 'page_hide'
                        };
                        
                        // ‰øùÂ≠òÈÄÄÂá∫ËÆ∞ÂΩï
                        let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                        exitHistory.push(exitRecord);
                        localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                        localStorage.setItem('exitCount', newExitCount.toString());
                        
                        console.log(`üì± È°µÈù¢ÈöêËóèËÆ∞ÂΩïÈÄÄÂá∫ÔºåÊÄªÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                        console.log('üì± È°µÈù¢ÈöêËóèÈÄÄÂá∫ËÆ∞ÂΩïËØ¶ÊÉÖ:', exitRecord);
                    } else {
                        console.log(`üì± È°µÈù¢ÈöêËóèÈÄÄÂá∫Êó∂ÈïøËøáÁü≠(${exitDuration}Áßí)Ôºå‰∏çËÆ∞ÂΩïÈÄÄÂá∫`);
                    }
                } else {
                    console.log('üì± È°µÈù¢ÈöêËóèÊó∂Êú™Âú®Ë∑üË∏™ÈÄÄÂá∫Áä∂ÊÄÅÊàñ‰ªçÂú®ÂàùÂßãÂä†ËΩΩ‰∏≠');
                }
            });
        }
        
        // Êõ¥Êñ∞recordingÂºπÁ™ó‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞ÊòæÁ§∫
        function updateRecordingExitCount() {
            const exitCount = parseInt(localStorage.getItem('exitCount') || '0');
            
            console.log(`üìä Êõ¥Êñ∞ÈÄÄÂá∫Ê¨°Êï∞ÊòæÁ§∫: ${exitCount}`);
            
            // Êõ¥Êñ∞statsModal‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞ÊòæÁ§∫
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const exitElement = statsModal.querySelector('#exitCount');
                if (exitElement) {
                    exitElement.textContent = exitCount;
                    console.log('‚úÖ Â∑≤Êõ¥Êñ∞statsModal‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞');
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞statsModal‰∏≠ÁöÑ#exitCountÂÖÉÁ¥†');
                }
            }
            
            // Êõ¥Êñ∞simpleRecordingModal‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞ÊòæÁ§∫
            const simpleModal = document.getElementById('simpleRecordingModal');
            if (simpleModal && simpleModal.style.display === 'block') {
                const simpleExitElement = simpleModal.querySelector('#exitCount');
                if (simpleExitElement) {
                    simpleExitElement.textContent = exitCount;
                    console.log('‚úÖ Â∑≤Êõ¥Êñ∞simpleRecordingModal‰∏≠ÁöÑÈÄÄÂá∫Ê¨°Êï∞');
                } else {
                    console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞simpleRecordingModal‰∏≠ÁöÑ#exitCountÂÖÉÁ¥†');
                }
            }
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
            window.exitCount = exitCount;
        }
        
        
        // ÈáçÁΩÆÈÄÄÂá∫Êï∞ÊçÆ
        
        
        
        // È°µÈù¢ÂØºËà™ÈÄÄÂá∫ËÆ∞ÂΩïÂáΩÊï∞ÔºàÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
        function recordPageNavigationExit() {
            const state = window.exitTrackingState;
            console.log('üì± È°µÈù¢ÂØºËà™ÈÄÄÂá∫ËÆ∞ÂΩïÔºåÊ£ÄÊü•Áä∂ÊÄÅ:', { 
                isTrackingExit: state ? state.isTrackingExit : 'state‰∏çÂ≠òÂú®', 
                exitStartTime: state && state.exitStartTime ? new Date(state.exitStartTime).toLocaleTimeString() : 'Êó†ÂºÄÂßãÊó∂Èó¥',
                isInitialLoad: state ? state.isInitialLoad : 'state‰∏çÂ≠òÂú®',
                state: state
            });
            
            // Â¶ÇÊûúÈÄÄÂá∫Ë∑üË∏™Â∑≤ÁªèÊøÄÊ¥ªÔºå‰ΩøÁî®Áé∞ÊúâÁöÑÈÄÄÂá∫Êó∂Èïø
            if (state && state.isTrackingExit && state.exitStartTime && !state.isInitialLoad) {
                const exitDuration = Math.floor((Date.now() - state.exitStartTime) / 1000);
                console.log(`üì± È°µÈù¢ÂØºËà™ÔºåÈÄÄÂá∫Êó∂Èïø: ${exitDuration}Áßí`);
                
                if (exitDuration >= 1) {
                    // Áõ¥Êé•‰ªélocalStorageËØªÂèñÂΩìÂâçÈÄÄÂá∫Ê¨°Êï∞
                    const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                    const newExitCount = currentExitCount + 1;
                    
                    console.log(`üì± ÂΩìÂâçÈÄÄÂá∫Ê¨°Êï∞: ${currentExitCount}, Êñ∞ÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                    
                    // ËÆ∞ÂΩïÈÄÄÂá∫‰ø°ÊÅØ
                    const exitRecord = {
                        timestamp: new Date().toISOString(),
                        duration: exitDuration,
                        exitNumber: newExitCount,
                        exitStartTime: new Date(state.exitStartTime).toISOString(),
                        exitEndTime: new Date().toISOString(),
                        reason: 'page_navigation'
                    };
                    
                    // ‰øùÂ≠òÈÄÄÂá∫ËÆ∞ÂΩï
                    let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                    exitHistory.push(exitRecord);
                    localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                    localStorage.setItem('exitCount', newExitCount.toString());
                    
                    console.log(`üì± È°µÈù¢ÂØºËà™ËÆ∞ÂΩïÈÄÄÂá∫ÔºåÊÄªÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                    console.log('üì± È°µÈù¢ÂØºËà™ÈÄÄÂá∫ËÆ∞ÂΩïËØ¶ÊÉÖ:', exitRecord);
                    console.log('üì± localStorageÂÜôÂÖ•ÂêéÈ™åËØÅ:', {
                        exitCount: localStorage.getItem('exitCount'),
                        exitHistoryLength: JSON.parse(localStorage.getItem('exitHistory') || '[]').length
                    });
                    
                    return true; // ÊàêÂäüËÆ∞ÂΩï
                } else {
                    console.log(`üì± È°µÈù¢ÂØºËà™ÈÄÄÂá∫Êó∂ÈïøËøáÁü≠(${exitDuration}Áßí)Ôºå‰∏çËÆ∞ÂΩïÈÄÄÂá∫`);
                }
            } 
            // Â¶ÇÊûúÈÄÄÂá∫Ë∑üË∏™Ê≤°ÊúâÊøÄÊ¥ªÔºå‰ΩÜÈ°µÈù¢Â∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÂàôÁõ¥Êé•ËÆ∞ÂΩïÈ°µÈù¢ÂØºËà™ÈÄÄÂá∫
            else if (state && !state.isInitialLoad) {
                console.log('üì± È°µÈù¢ÂØºËà™Êó∂ÈÄÄÂá∫Ë∑üË∏™Êú™ÊøÄÊ¥ªÔºåÁõ¥Êé•ËÆ∞ÂΩïÈ°µÈù¢ÂØºËà™ÈÄÄÂá∫');
                
                // Áõ¥Êé•‰ªélocalStorageËØªÂèñÂΩìÂâçÈÄÄÂá∫Ê¨°Êï∞
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                const newExitCount = currentExitCount + 1;
                
                console.log(`üì± ÂΩìÂâçÈÄÄÂá∫Ê¨°Êï∞: ${currentExitCount}, Êñ∞ÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                
                // ËÆ∞ÂΩïÈÄÄÂá∫‰ø°ÊÅØÔºà‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥‰Ωú‰∏∫ÈÄÄÂá∫ÂºÄÂßãÂíåÁªìÊùüÊó∂Èó¥Ôºâ
                const now = Date.now();
                const exitRecord = {
                    timestamp: new Date().toISOString(),
                    duration: 1, // È°µÈù¢ÂØºËà™ÈÄÄÂá∫Âõ∫ÂÆö‰∏∫1Áßí
                    exitNumber: newExitCount,
                    exitStartTime: new Date(now - 1000).toISOString(), // 1ÁßíÂâç
                    exitEndTime: new Date().toISOString(),
                    reason: 'page_navigation'
                };
                
                // ‰øùÂ≠òÈÄÄÂá∫ËÆ∞ÂΩï
                let exitHistory = JSON.parse(localStorage.getItem('exitHistory') || '[]');
                exitHistory.push(exitRecord);
                localStorage.setItem('exitHistory', JSON.stringify(exitHistory));
                localStorage.setItem('exitCount', newExitCount.toString());
                
                console.log(`üì± È°µÈù¢ÂØºËà™Áõ¥Êé•ËÆ∞ÂΩïÈÄÄÂá∫ÔºåÊÄªÈÄÄÂá∫Ê¨°Êï∞: ${newExitCount}`);
                console.log('üì± È°µÈù¢ÂØºËà™ÈÄÄÂá∫ËÆ∞ÂΩïËØ¶ÊÉÖ:', exitRecord);
                console.log('üì± localStorageÂÜôÂÖ•ÂêéÈ™åËØÅ:', {
                    exitCount: localStorage.getItem('exitCount'),
                    exitHistoryLength: JSON.parse(localStorage.getItem('exitHistory') || '[]').length
                });
                
                return true; // ÊàêÂäüËÆ∞ÂΩï
            } else {
                console.log('üì± È°µÈù¢ÂØºËà™Êó∂Êú™Âú®Ë∑üË∏™ÈÄÄÂá∫Áä∂ÊÄÅÊàñ‰ªçÂú®ÂàùÂßãÂä†ËΩΩ‰∏≠');
                console.log('üì± ËØ¶ÁªÜÁä∂ÊÄÅÊ£ÄÊü•:', {
                    stateÂ≠òÂú®: !!state,
                    isTrackingExit: state ? state.isTrackingExit : 'N/A',
                    exitStartTimeÂ≠òÂú®: !!(state && state.exitStartTime),
                    isInitialLoad: state ? state.isInitialLoad : 'N/A'
                });
            }
            return false; // Êú™ËÆ∞ÂΩï
        }
        
        // Êõ¥Êñ∞recordingÂºπÁ™ó‰∏≠ÁöÑÈòÖËØªÊó∂Èó¥
        function updateRecordingReadingTime() {
            const readingTime = localStorage.getItem('readingTime') || 0;
            const hours = Math.floor(readingTime / 3600);
            const minutes = Math.floor((readingTime % 3600) / 60);
            
            // Êõ¥Êñ∞statsModal‰∏≠ÁöÑÊó∂Èó¥ÊòæÁ§∫
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const hoursElement = statsModal.querySelector('#readingHours');
                const minutesElement = statsModal.querySelector('#readingMinutes');
                if (hoursElement) hoursElement.textContent = hours;
                if (minutesElement) minutesElement.textContent = minutes;
            }
            
            // Êõ¥Êñ∞simpleRecordingModal‰∏≠ÁöÑÊó∂Èó¥ÊòæÁ§∫
            const simpleModal = document.getElementById('simpleRecordingModal');
            if (simpleModal && simpleModal.style.display === 'block') {
                const simpleHoursElement = simpleModal.querySelector('#simpleReadingHours');
                const simpleMinutesElement = simpleModal.querySelector('#simpleReadingMinutes');
                if (simpleHoursElement) simpleHoursElement.textContent = hours;
                if (simpleMinutesElement) simpleMinutesElement.textContent = minutes;
            }
        }

        function showRecording() {
            console.log('üìä ÊòæÁ§∫recordingÁªüËÆ°ÂºπÁ™ó');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâÂºπÁ™ó
            const existingModal = document.getElementById('statsModal');
            if (existingModal) {
                console.log('üìä recordingÂºπÁ™óÂ∑≤Â≠òÂú®Ôºå‰∏çÈáçÂ§çÂàõÂª∫');
                return;
            }
            
            // ËÆæÁΩÆÂàõÂª∫Ê†áËÆ∞
            window.isCreatingModal = true;
            
            // ÂàõÂª∫ÁªüËÆ°ÂºπÁ™ó
            const modal = document.createElement('div');
            modal.id = 'statsModal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 350px;
                height: 400px;
                background: white;
                border-radius: 20px;
                z-index: 10000;
                display: block;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 20px;">ÈòÖËØªÁªüËÆ°</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">ÈòÖËØªÊó∂Èïø</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${Math.floor(readingTime / 60)}Â∞èÊó∂${readingTime % 60}ÂàÜÈíü</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">ÈÄÄÂá∫Ê¨°Êï∞</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${exitCount}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                        <span style="color: #666;">ÂàíÁ∫øÊ¨°Êï∞</span>
                        <span class="stats-value" style="color: #333; font-weight: bold;">${totalStrokes}</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeRecording()" style="background: #A88DCB; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ÂÖ≥Èó≠</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ê∏ÖÈô§ÂàõÂª∫Ê†áËÆ∞
            setTimeout(() => {
                window.isCreatingModal = false;
            }, 100);
            
            console.log('üìä recordingÁªüËÆ°ÂºπÁ™óÂ∑≤ÊòæÁ§∫');
        }
        
        // ÂÖ≥Èó≠recordingÁªüËÆ°ÂºπÁ™ó - ËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©
        function closeRecording() {
            console.log('üìä ÂÖ≥Èó≠recordingÁªüËÆ°ÂºπÁ™óÔºåËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©');
            
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                console.log('‚úÖ recordingÂºπÁ™óÂ∑≤ÂÖ≥Èó≠Ôºå‰øùÊåÅÂú®overlayÊ®°Âºè');
            }
        }
        
        // Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑstrokesËÆ°Êï∞
        function updateRecordingStrokes() {
            // Êõ¥Êñ∞totalStrokesÂèòÈáè
            totalStrokes = highlightedElements.length;
            
            // Â¶ÇÊûúrecordingÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåÊõ¥Êñ∞ÊòæÁ§∫
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display !== 'none') {
                const strokesElement = statsModal.querySelector('.stats-value:last-child');
                if (strokesElement) {
                    strokesElement.textContent = totalStrokes;
                }
            }
            
            console.log('üìä Â∑≤Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑstrokesËÆ°Êï∞:', totalStrokes);
        }
        
        
        
        
        // ËøõÂÖ•ÊñáÊú¨ÈÄâÊã©Ê®°Âºè
        function enterTextSelectionMode() {
            console.log('üìù ÊòæÁ§∫Á¨îËÆ∞È°µÈù¢');
            
            // ÂÖ≥Èó≠ÁÅ∞Ëâ≤ÈÅÆÁΩ©
            closeOverlay();
            
            // ÊòæÁ§∫Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü
            showNotesModal();
        }
        
        // ÊòæÁ§∫Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü
        function showNotesModal() {
            console.log('üìù ÊòæÁ§∫Á¨îËÆ∞Ê®°ÊÄÅÊ°Ü');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®Ê®°ÊÄÅÊ°Ü
            const existingModal = document.getElementById('notesModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Ëé∑ÂèñÁ¨îËÆ∞Êï∞ÊçÆ
            const notes = JSON.parse(localStorage.getItem('notes') || '[]');
            console.log('üìù ÂΩìÂâçÁ¨îËÆ∞Êï∞Èáè:', notes.length);
            
            // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
            const modal = document.createElement('div');
            modal.id = 'notesModal';
            modal.className = 'notes-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                width: 428px;
                height: 690px;
                background: white;
                border-radius: 20px;
                padding: 20px;
                position: relative;
                overflow: hidden;
            `;
            
            // ÂàõÂª∫Ê†áÈ¢òÊ†è
            const titleBar = document.createElement('div');
            titleBar.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #eee;
            `;
            
            const title = document.createElement('h2');
            title.textContent = 'ÊàëÁöÑÁ¨îËÆ∞';
            title.style.cssText = `
                margin: 0;
                font-size: 18px;
                color: #333;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '√ó';
            closeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => {
                modal.remove();
            };
            
            titleBar.appendChild(title);
            titleBar.appendChild(closeBtn);
            
            // ÂàõÂª∫Á¨îËÆ∞ÂàóË°®ÂÆπÂô®
            const notesList = document.createElement('div');
            notesList.style.cssText = `
                height: 580px;
                overflow-y: auto;
                padding-right: 10px;
            `;
            
            if (notes.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.style.cssText = `
                    text-align: center;
                    color: #999;
                    margin-top: 100px;
                    font-size: 16px;
                `;
                emptyState.innerHTML = `
                    <div>ÊöÇÊó†Á¨îËÆ∞</div>
                    <div style="font-size: 14px; margin-top: 10px;">ÈïøÊåâÊñáÂ≠óÊÆµËêΩÂèØ‰ª•Ê∑ªÂä†Á¨îËÆ∞</div>
                `;
                notesList.appendChild(emptyState);
            } else {
                notes.forEach((note, index) => {
                    const noteItem = document.createElement('div');
                    noteItem.style.cssText = `
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                        border-left: 4px solid #A88DCB;
                    `;
                    
                    const noteText = document.createElement('div');
                    noteText.textContent = note.text;
                    noteText.style.cssText = `
                        font-size: 14px;
                        line-height: 1.5;
                        color: #333;
                        margin-bottom: 8px;
                    `;
                    
                    const noteTime = document.createElement('div');
                    noteTime.textContent = note.timestamp;
                    noteTime.style.cssText = `
                        font-size: 12px;
                        color: #666;
                    `;
                    
                    noteItem.appendChild(noteText);
                    noteItem.appendChild(noteTime);
                    notesList.appendChild(noteItem);
                });
            }
            
            modalContent.appendChild(titleBar);
            modalContent.appendChild(notesList);
            modal.appendChild(modalContent);
            
            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            document.body.appendChild(modal);
            
            console.log('üìù Á¨îËÆ∞Ê®°ÊÄÅÊ°ÜÂ∑≤ÊòæÁ§∫');
        }
        
        // È°µÈù¢Ë∑≥ËΩ¨ÂäüËÉΩ
        function goBack() {
            // ËÆ∞ÂΩïÈ°µÈù¢ÂØºËà™ÈÄÄÂá∫
            recordPageNavigationExit();
            // ËøîÂõûDetailsÈ°µÈù¢
            window.location.href = 'details.html';
        }
        
        
        
        
        
        
        
        
        // ‰ªéÈÄâÊã©ÂàõÂª∫ÂàíÁ∫øÔºà‰øùÁïôÂéüÂáΩÊï∞‰ª•ÂÖºÂÆπÊÄßÔºâ
        
        // ÂèñÊ∂àÈÄâÊã©
        
        // È°µÈù¢Ë∑≥ËΩ¨ÂäüËÉΩ
        function goBack() {
            // ËÆ∞ÂΩïÈ°µÈù¢ÂØºËà™ÈÄÄÂá∫
            recordPageNavigationExit();
            // ËøîÂõûDetailsÈ°µÈù¢
            window.location.href = 'details.html';
        }

        // Â§ÑÁêÜÊñáÂ≠óÂå∫ÂüüÁÇπÂáª
        function handleTextClick(event) {
            // Â¶ÇÊûúÊ≠£Âú®ÈÄâÊã©ÊñáÊú¨Ôºå‰∏çÂ§ÑÁêÜÁÇπÂáª‰∫ã‰ª∂
            if (isSelectingText) {
                return;
            }
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÈÄâÊã©Ê°Ü„ÄÅÊâãÊüÑÊàñÈÄâÊã©ËèúÂçïÔºå‰∏çÂ§ÑÁêÜ
            if (event && (event.target.classList.contains('text-selection-box') || 
                event.target.classList.contains('selection-handle') ||
                event.target.closest('#native-selection-menu'))) {
                return;
            }
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂàíÁ∫øÈÉ®ÂàÜÔºåÊòæÁ§∫Âà†Èô§ÈÄâÈ°π
            if (event && event.target.classList.contains('highlighted')) {
                showDeleteConfirmation(event.target);
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïÂºπÁ™óÊàñÈÅÆÁΩ©ÊâìÂºÄ
            const hasRecordingModal = document.getElementById('statsModal') && document.getElementById('statsModal').style.display === 'block';
            const hasSimpleRecordingModal = document.getElementById('simpleRecordingModal') && document.getElementById('simpleRecordingModal').style.display === 'block';
            const hasNotebookModal = document.getElementById('notebookModal') && document.getElementById('notebookModal').classList.contains('show');
            const hasOverlay = document.querySelector('.overlay-background');
            const hasSelectionMenu = document.getElementById('native-selection-menu');
            
            if (hasRecordingModal || hasSimpleRecordingModal || hasNotebookModal || hasOverlay || hasSelectionMenu) {
                return;
            }
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊñáÂ≠óÊÆµËêΩÔºå‰∏î‰∏çÊòØÂàíÁ∫øÈÉ®ÂàÜÔºåÊòæÁ§∫ÁÅ∞Ëâ≤ÈÅÆÁΩ©
            if (event && event.target.tagName === 'P' && !event.target.classList.contains('highlighted')) {
                createOverlay();
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâeventÂèÇÊï∞ÔºåÁõ¥Êé•ÊòæÁ§∫ÈÅÆÁΩ©
                createOverlay();
            }
        }

        // ÊâìÂºÄoverlayÈÅÆÁΩ©
        function openOverlay() {
            console.log('üìñ Â∞ùËØïÊâìÂºÄoverlayÈÅÆÁΩ©');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúârecordingÂºπÁ™óÊâìÂºÄ
            if (document.querySelector('.stats-modal.show')) {
                console.log('‚ö†Ô∏è recordingÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåËØ∑ÂÖàÂÖ≥Èó≠recording');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâoverlayÈÅÆÁΩ©
            if (document.querySelector('.overlay-background')) {
                console.log('‚ö†Ô∏è overlayÈÅÆÁΩ©Â∑≤Â≠òÂú®');
                return;
            }
            
            console.log('‚úÖ ÂèØ‰ª•ÊâìÂºÄoverlayÈÅÆÁΩ©');
            createOverlay();
        }

        // ÊòæÁ§∫recordingÂºπÁ™ó
        function showRecording() {
            // ËÆæÁΩÆÂàõÂª∫Ê†áËÆ∞
            window.isCreatingModal = true;
            
            // Âà†Èô§Áé∞ÊúâÁöÑÂºπÁ™ó
            const existingModal = document.getElementById('simpleRecordingModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÂàõÂª∫ÂÖ®Êñ∞ÁöÑÂºπÁ™óÂÖÉÁ¥†
            const newModal = document.createElement('div');
            newModal.id = 'simpleRecordingModal';
            newModal.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 20px;">Recording</h3>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Reading Time</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingHours">0</div>
                            <div style="font-size: 13px;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleReadingMinutes">0</div>
                            <div style="font-size: 13px;">Min</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of Exits</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleExitCount">0</div>
                            <div style="font-size: 13px;">Times</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="background: #EAEAEA; padding: 5px 15px; border-radius: 15px; text-align: center; margin-bottom: 10px; font-size: 12px;">Number of strokes</div>
                    <div style="display: flex; justify-content: center;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px;" id="simpleHighlightCount">0</div>
                            <div style="font-size: 13px;">Items</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ËÆæÁΩÆÊ†∑Âºè - Áõ¥Êé•ËÆæÁΩÆÔºå‰∏ç‰ΩøÁî®CSSÁ±ª
            newModal.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 240px !important;
                height: 320px !important;
                background: white !important;
                color: black !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                z-index: 10002 !important;
                padding: 20px !important;
                border-radius: 15px !important;
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3) !important;
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(newModal);
            
            // Êõ¥Êñ∞Êï∞ÊçÆ
            try {
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                document.getElementById('simpleReadingHours').textContent = Math.floor(readingTime / 60);
                document.getElementById('simpleReadingMinutes').textContent = readingTime % 60;
                document.getElementById('simpleExitCount').textContent = currentExitCount;
                document.getElementById('simpleHighlightCount').textContent = totalStrokes;
                console.log('‚úÖ Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞ÔºåÈÄÄÂá∫Ê¨°Êï∞:', currentExitCount);
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞Êï∞ÊçÆÊó∂Âá∫Èîô:', error);
            }
            
            // Âª∂ËøüÊ∏ÖÈô§ÂàõÂª∫Ê†áËÆ∞ÔºåÁ°Æ‰øùÂºπÁ™óÂÆåÂÖ®ÂàõÂª∫
            setTimeout(() => {
                window.isCreatingModal = false;
                console.log('‚úÖ ÂàõÂª∫Ê†áËÆ∞Â∑≤Ê∏ÖÈô§');
            }, 100);
            
            console.log('‚úÖ Êñ∞recordingÂºπÁ™óÂ∑≤ÂàõÂª∫Âπ∂ÊòæÁ§∫');
        }




        // ÊòæÁ§∫recordingÁªüËÆ°ÂºπÁ™ó - ÂàõÂª∫Êñ∞ÂºπÁ™óÁâàÊú¨
        function showRecording() {
            console.log('üìä ÊòæÁ§∫recordingÁªüËÆ°ÂºπÁ™ó');
            
            // ËÆæÁΩÆÂàõÂª∫Ê†áËÆ∞
            window.isCreatingModal = true;
            
            // Âà†Èô§Áé∞ÊúâÁöÑÂºπÁ™ó
            const existingModal = document.getElementById('statsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ÂàõÂª∫ÂÖ®Êñ∞ÁöÑrecordingÂºπÁ™ó
            const newModal = document.createElement('div');
            newModal.id = 'statsModal';
            newModal.innerHTML = `
                <div style="position: absolute; top: 7px; left: 50%; transform: translateX(-50%); width: 94px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px; line-height: 1.5em; color: #000000;">Recording</div>
                
                <div style="position: absolute; top: 57px; left: 15px; width: 184px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Reading Time</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="readingHours">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Hour</div>
                        </div>
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="readingMinutes">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Min</div>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; top: 148px; left: 15px; width: 104px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Number of Exits</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="exitCount">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Times</div>
                        </div>
                    </div>
                </div>
                
                <div style="position: absolute; top: 239px; left: 15px; width: 121px; height: 71px;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 28px; background: #EAEAEA; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 12px; line-height: 1.5em; color: #000000;">Number of strokes</div>
                    <div style="position: absolute; top: 43px; left: 15px; display: flex; align-items: flex-end; gap: 20px;">
                        <div style="display: flex; align-items: flex-end; gap: 5px;">
                            <div style="width: 42px; height: 28px; border: 1px solid #A88DCB; border-radius: 10px; text-align: center; font-size: 14px; color: #19191B; display: flex; align-items: center; justify-content: center; background: #FFFFFF;" id="highlightCount">0</div>
                            <div style="font-weight: 300; font-size: 13px; line-height: 1.5em; color: #000000;">Items</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ËÆæÁΩÆÊ†∑Âºè - Áõ¥Êé•ËÆæÁΩÆÔºå‰∏ç‰ΩøÁî®CSSÁ±ª
            newModal.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 240px !important;
                height: 320px !important;
                background: #FFFFFF !important;
                border-radius: 15px !important;
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3) !important;
                z-index: 10001 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                padding: 0 !important;
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(newModal);
            
            // Êõ¥Êñ∞ÂºπÁ™ó‰∏≠ÁöÑÊï∞ÂÄº
            try {
                const currentExitCount = parseInt(localStorage.getItem('exitCount') || '0');
                document.getElementById('readingHours').textContent = Math.floor(readingTime / 60);
                document.getElementById('readingMinutes').textContent = readingTime % 60;
                document.getElementById('exitCount').textContent = currentExitCount;
                document.getElementById('highlightCount').textContent = totalStrokes;
                console.log('‚úÖ ÁªüËÆ°Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞ÔºåÈÄÄÂá∫Ê¨°Êï∞:', currentExitCount);
            } catch (error) {
                console.error('‚ùå Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÊó∂Âá∫Èîô:', error);
            }
            
            // Âª∂ËøüÊ∏ÖÈô§ÂàõÂª∫Ê†áËÆ∞ÔºåÁ°Æ‰øùÂºπÁ™óÂÆåÂÖ®ÂàõÂª∫
            setTimeout(() => {
                window.isCreatingModal = false;
                console.log('‚úÖ ÂàõÂª∫Ê†áËÆ∞Â∑≤Ê∏ÖÈô§');
            }, 100);
            
            console.log('‚úÖ Êñ∞recordingÂºπÁ™óÂ∑≤ÂàõÂª∫Âπ∂ÊòæÁ§∫');
        }

        // ÂÖ≥Èó≠recordingÁªüËÆ°ÂºπÁ™ó - ËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©
        function closeRecording() {
            console.log('üìä ÂÖ≥Èó≠recordingÁªüËÆ°ÂºπÁ™óÔºåËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©');
            
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                console.log('‚úÖ recordingÂºπÁ™óÂ∑≤ÂÖ≥Èó≠Ôºå‰øùÊåÅÂú®overlayÊ®°Âºè');
            }
        }

        // ÊòæÁ§∫Á¨îËÆ∞Êú¨ÂºπÁ™ó
        function showNotebook() {
            console.log('üìì ÊòæÁ§∫Á¨îËÆ∞Êú¨ÂºπÁ™ó');
            window.isCreatingNotebookModal = true; // ËÆæÁΩÆÂàõÂª∫Ê†áËÆ∞
            
            const modal = document.getElementById('notebookModal');
            const content = document.getElementById('notebookContent');
            
            if (!modal) {
                console.error('‚ùå Êú™ÊâæÂà∞notebookModalÂÖÉÁ¥†ÔºÅ');
                return;
            }
            
            // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
            currentPage = 0;
            
            // ÊòæÁ§∫Á¨îËÆ∞ÂÜÖÂÆπ
            displayNotes();
            
            modal.classList.add('show');
            
            // ÊòæÁ§∫Â∫ïÈÉ®Ê†áÁ≠æÊ†è
            const bottomBar = document.getElementById('notebookBottomBar');
            if (bottomBar) {
                bottomBar.classList.add('show');
            }
            
            console.log('‚úÖ Á¨îËÆ∞Êú¨ÂºπÁ™óÂ∑≤ÊòæÁ§∫ÔºåÂåÖÂê´', highlightedElements.length, 'Êù°Á¨îËÆ∞');
            
            // Ê∏ÖÈô§ÂàõÂª∫Ê†áËÆ∞
            setTimeout(() => {
                window.isCreatingNotebookModal = false;
                console.log('‚úÖ Á¨îËÆ∞Êú¨ÂàõÂª∫Ê†áËÆ∞Â∑≤Ê∏ÖÈô§');
            }, 100);
        }

        // ÊòæÁ§∫Á¨îËÆ∞ÂÜÖÂÆπÔºàÂàÜÈ°µÂäüËÉΩÔºâ
        function displayNotes() {
            const content = document.getElementById('notebookContent');
            content.innerHTML = '';
            
            // ÁîüÊàêÁ§∫‰æãÁ¨îËÆ∞ÂÜÖÂÆπ
            const sampleNotes = [
                "Stradlater spends the evening on a date with Jane Gallagher, a girl whom Holden used to date and whom he still admires. This passage reveals Holden's complex feelings about Jane and his protective instincts towards her.",
                "The catcher in the rye represents Holden's desire to protect children from the harsh realities of adulthood. He imagines himself standing in a field of rye, catching children who are about to fall off a cliff.",
                "Holden's red hunting hat symbolizes his individuality and his desire to stand out from the crowd. He wears it when he wants to feel different or when he's feeling particularly alienated.",
                "Phoebe is Holden's younger sister and represents innocence and purity in his life. She serves as a contrast to the phoniness he sees in the adult world around him.",
                "The museum represents stability and permanence in Holden's chaotic world. He finds comfort in the fact that the exhibits never change, unlike the people in his life who seem to constantly disappoint him.",
                "Holden's relationship with his parents is strained, particularly with his father who wants him to attend an elite prep school. This tension reflects Holden's rejection of the adult world's values and expectations.",
                "The ducks in Central Park symbolize Holden's own feelings of displacement and uncertainty about where he belongs in the world. He repeatedly asks cab drivers about where the ducks go in winter.",
                "Allie's death has a profound impact on Holden, representing the loss of innocence and the harsh reality of mortality. Holden keeps Allie's baseball mitt as a connection to his lost brother."
            ];
            
            // ÂêàÂπ∂ÂÆûÈôÖÂàíÁ∫øÂíåÁ§∫‰æãÁ¨îËÆ∞
            let allNotes = [...highlightedElements];
            if (allNotes.length < 8) {
                const remainingNotes = 8 - allNotes.length;
                for (let i = 0; i < remainingNotes; i++) {
                    allNotes.push({
                        text: sampleNotes[i],
                        timestamp: `Á§∫‰æãÁ¨îËÆ∞ ${i + 1}`
                    });
                }
            }
            
            // ËÆ°ÁÆóÂΩìÂâçÈ°µÁöÑÁ¨îËÆ∞ËåÉÂõ¥
            const startIndex = currentPage * notesPerPage;
            const endIndex = Math.min(startIndex + notesPerPage, allNotes.length);
            const currentPageNotes = allNotes.slice(startIndex, endIndex);
            
            // ÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÁ¨îËÆ∞
            currentPageNotes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'notebook-item';
                noteItem.innerHTML = `
                    <div class="text">${note.text}</div>
                    <div class="timestamp">${note.timestamp}</div>
                `;
                content.appendChild(noteItem);
            });
            
            // Êõ¥Êñ∞ÊåáÁ§∫Âô®
            updateIndicators(allNotes.length);
        }

        // Êõ¥Êñ∞Â∫ïÈÉ®ÊåáÁ§∫Âô®
        function updateIndicators(totalNotes) {
            const indicators = document.querySelectorAll('.indicator');
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            indicators.forEach((indicator, index) => {
                if (index < totalPages) {
                    indicator.style.display = 'block';
                    indicator.classList.toggle('active', index === currentPage);
                } else {
                    indicator.style.display = 'none';
                }
            });
        }

        // ÁøªÈ°µÂäüËÉΩ
        function nextPage() {
            const totalNotes = Math.max(highlightedElements.length, 8);
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            if (currentPage < totalPages - 1) {
                currentPage++;
                displayNotes();
                console.log('üìÑ ÁøªÂà∞Á¨¨', currentPage + 1, 'È°µ');
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                displayNotes();
                console.log('üìÑ ÁøªÂà∞Á¨¨', currentPage + 1, 'È°µ');
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢
        function goToPage(pageIndex) {
            const totalNotes = Math.max(highlightedElements.length, 8);
            const totalPages = Math.ceil(totalNotes / notesPerPage);
            
            if (pageIndex >= 0 && pageIndex < totalPages) {
                currentPage = pageIndex;
                displayNotes();
                console.log('üìÑ Ë∑≥ËΩ¨Âà∞Á¨¨', currentPage + 1, 'È°µ');
            }
        }

        // Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑstrokesËÆ°Êï∞
        function updateRecordingStrokes() {
            // Êõ¥Êñ∞totalStrokesÂèòÈáè
            totalStrokes = highlightedElements.length;
            
            // Â¶ÇÊûúrecordingÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåÊõ¥Êñ∞ÊòæÁ§∫
            const statsModal = document.getElementById('statsModal');
            if (statsModal && statsModal.style.display === 'block') {
                const strokesElement = statsModal.querySelector('.stats-value');
                if (strokesElement) {
                    strokesElement.textContent = totalStrokes;
                }
            }
            
            console.log('üìä Â∑≤Êõ¥Êñ∞recordingÈ°µÈù¢ÁöÑstrokesËÆ°Êï∞:', totalStrokes);
        }

        // ÂÖ≥Èó≠Á¨îËÆ∞Êú¨ÂºπÁ™óÔºåËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©
        function closeNotebook() {
            const modal = document.getElementById('notebookModal');
            modal.classList.remove('show');
            
            // ÈöêËóèÂ∫ïÈÉ®Ê†áÁ≠æÊ†è
            const bottomBar = document.getElementById('notebookBottomBar');
            if (bottomBar) {
                bottomBar.classList.remove('show');
            }
            
            // ÁßªÈô§ÊâÄÊúâiconÁöÑactiveÁä∂ÊÄÅÔºåËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©Áä∂ÊÄÅ
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            console.log('‚úÖ Á¨îËÆ∞Êú¨ÂºπÁ™óÂ∑≤ÂÖ≥Èó≠ÔºåËøîÂõûÂà∞ÁÅ∞Ëâ≤ÈÅÆÁΩ©');
        }

        // Âà†Èô§ÊâÄÊúâÁ¨îËÆ∞
        function deleteAllNotes() {
            // ÊòæÁ§∫ÈÄâÊã©Âà†Èô§ÁïåÈù¢
            showDeleteSelection();
        }

        // ÊòæÁ§∫Âà†Èô§ÈÄâÊã©ÁïåÈù¢
        function showDeleteSelection() {
            const content = document.getElementById('notebookContent');
            const allNotes = [...highlightedElements];
            
            // ÁîüÊàêÁ§∫‰æãÁ¨îËÆ∞ÂÜÖÂÆπ
            const sampleNotes = [
                "Stradlater spends the evening on a date with Jane Gallagher, a girl whom Holden used to date and whom he still admires. This passage reveals Holden's complex feelings about Jane and his protective instincts towards her.",
                "The catcher in the rye represents Holden's desire to protect children from the harsh realities of adulthood. He imagines himself standing in a field of rye, catching children who are about to fall off a cliff.",
                "Holden's red hunting hat symbolizes his individuality and his desire to stand out from the crowd. He wears it when he wants to feel different or when he's feeling particularly alienated.",
                "Phoebe is Holden's younger sister and represents innocence and purity in his life. She serves as a contrast to the phoniness he sees in the adult world around him.",
                "The museum represents stability and permanence in Holden's chaotic world. He finds comfort in the fact that the exhibits never change, unlike the people in his life who seem to constantly disappoint him.",
                "Holden's relationship with his parents is strained, particularly with his father who wants him to attend an elite prep school. This tension reflects Holden's rejection of the adult world's values and expectations.",
                "The ducks in Central Park symbolize Holden's own feelings of displacement and uncertainty about where he belongs in the world. He repeatedly asks cab drivers about where the ducks go in winter.",
                "Allie's death has a profound impact on Holden, representing the loss of innocence and the harsh reality of mortality. Holden keeps Allie's baseball mitt as a connection to his lost brother."
            ];
            
            // ÂêàÂπ∂ÂÆûÈôÖÂàíÁ∫øÂíåÁ§∫‰æãÁ¨îËÆ∞
            if (allNotes.length < 8) {
                const remainingNotes = 8 - allNotes.length;
                for (let i = 0; i < remainingNotes; i++) {
                    allNotes.push({
                        text: sampleNotes[i],
                        timestamp: `Á§∫‰æãÁ¨îËÆ∞ ${i + 1}`,
                        isSample: true
                    });
                }
            }
            
            // Ê∏ÖÁ©∫ÂÜÖÂÆπÂπ∂ÊòæÁ§∫ÈÄâÊã©ÁïåÈù¢
            content.innerHTML = '';
            
            // Ê∑ªÂä†Ê†áÈ¢ò
            const titleDiv = document.createElement('div');
            titleDiv.className = 'delete-title';
            titleDiv.innerHTML = '<h3>ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÁ¨îËÆ∞</h3>';
            content.appendChild(titleDiv);
            
            // ÊòæÁ§∫ÊâÄÊúâÁ¨îËÆ∞‰æõÈÄâÊã©
            allNotes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'notebook-item selectable';
                noteItem.innerHTML = `
                    <div class="note-checkbox">
                        <input type="checkbox" id="note-${index}" class="note-select" data-index="${index}">
                        <label for="note-${index}"></label>
                    </div>
                    <div class="text">${note.text}</div>
                    <div class="timestamp">${note.timestamp}</div>
                `;
                content.appendChild(noteItem);
            });
            
            // Ê∑ªÂä†Êìç‰ΩúÊåâÈíÆ
            const buttonDiv = document.createElement('div');
            buttonDiv.className = 'delete-buttons';
            buttonDiv.innerHTML = `
                <button class="cancel-delete-btn" onclick="cancelDelete()">ÂèñÊ∂à</button>
                <button class="confirm-delete-btn" onclick="confirmDelete()">Á°ÆËÆ§Âà†Èô§</button>
            `;
            content.appendChild(buttonDiv);
        }

        // ÂèñÊ∂àÂà†Èô§
        function cancelDelete() {
            displayNotes();
        }

        // Á°ÆËÆ§Âà†Èô§ÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞
        function confirmDelete() {
            const selectedCheckboxes = document.querySelectorAll('.note-select:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
            
            if (selectedIndices.length === 0) {
                alert('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÁ¨îËÆ∞');
                return;
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedIndices.length} Êù°Á¨îËÆ∞ÂêóÔºü`)) {
                // Âà†Èô§ÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞ÔºàÂè™Âà†Èô§ÂÆûÈôÖÂàíÁ∫øÔºå‰∏çÂà†Èô§Á§∫‰æãÁ¨îËÆ∞Ôºâ
                let deletedCount = 0;
                const deletedHighlights = [];
                
                selectedIndices.forEach(index => {
                    if (index < highlightedElements.length) {
                        deletedHighlights.push(highlightedElements[index]);
                        highlightedElements.splice(index, 1);
                        deletedCount++;
                    }
                });
                
                // ‰øùÂ≠òÊâπÈáèÂà†Èô§Êìç‰ΩúÂà∞Êï∞ÊçÆÂ∫ì
                saveToDatabase('batch_delete_highlights', {
                    deletedCount: deletedCount,
                    deletedHighlights: deletedHighlights,
                    totalStrokes: highlightedElements.length
                });
                
                // Êõ¥Êñ∞strokesËÆ°Êï∞
                totalStrokes = highlightedElements.length;
                updateRecordingStrokes();
                
                // ÈáçÊñ∞ÊòæÁ§∫Á¨îËÆ∞ÔºàÂÅúÁïôÂú®markÈ°µÈù¢Ôºâ
                displayNotes();
                console.log('‚úÖ Â∑≤Âà†Èô§ÈÄâ‰∏≠ÁöÑÁ¨îËÆ∞ÔºåstrokesËÆ°Êï∞Â∑≤Êõ¥Êñ∞ÔºåÂÅúÁïôÂú®markÈ°µÈù¢ÔºåÂà†Èô§Êìç‰ΩúÂ∑≤ËÆ∞ÂΩïÂà∞Êï∞ÊçÆÂ∫ì');
            }
        }

        // ÂàáÊç¢Âà∞Á¨îËÆ∞Êú¨Ê®°Âºè
        function switchToNotebook(element) {
            console.log('üìì ÂàáÊç¢Âà∞Á¨îËÆ∞Êú¨Ê®°Âºè');
            
            // ÈöêËóèËøõÂ∫¶ÂºπÁ™óÔºàÂ¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫Ôºâ
            hideProgressModal();
            
            // ÁßªÈô§ÊâÄÊúâiconÁöÑactiveÁä∂ÊÄÅ
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            // Ê∑ªÂä†ÂΩìÂâçiconÁöÑactiveÁä∂ÊÄÅ
            element.classList.add('active');
            
            // ÊòæÁ§∫Á¨îËÆ∞Êú¨ÂºπÁ™ó
            showNotebook();
        }

        // ÂàáÊç¢Âà∞ËøõÂ∫¶Ê®°Âºè
        function switchToProcessing(element) {
            console.log('üìä ÂàáÊç¢Âà∞ËøõÂ∫¶Ê®°Âºè');
            
            // Ê£ÄÊü•ËøõÂ∫¶ÂºπÁ™óÊòØÂê¶Â∑≤ÁªèÊòæÁ§∫
            const progressModal = document.getElementById('progressModal');
            const isProgressModalVisible = progressModal && progressModal.style.visibility === 'visible';
            
            // ÁßªÈô§ÊâÄÊúâiconÁöÑactiveÁä∂ÊÄÅ
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            if (isProgressModalVisible) {
                // Â¶ÇÊûúËøõÂ∫¶ÂºπÁ™óÂ∑≤ÁªèÊòæÁ§∫ÔºåÂàôÈöêËóèÂÆÉ
                console.log('üìä ËøõÂ∫¶ÂºπÁ™óÂ∑≤ÊòæÁ§∫ÔºåÈöêËóèÂºπÁ™ó');
                hideProgressModal();
                // ‰∏çÊ∑ªÂä†activeÁä∂ÊÄÅÔºå‰øùÊåÅÁÅ∞Ëâ≤ÈÅÆÁΩ©Áä∂ÊÄÅ
            } else {
                // Â¶ÇÊûúËøõÂ∫¶ÂºπÁ™óÊú™ÊòæÁ§∫ÔºåÂàôÊòæÁ§∫ÂÆÉ
                console.log('üìä ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó');
                // Ê∑ªÂä†ÂΩìÂâçiconÁöÑactiveÁä∂ÊÄÅ
                element.classList.add('active');
                // ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™ó
                showProgressModal();
            }
        }

        // ÂàáÊç¢Âà∞‰∫ÆÂ∫¶Ê®°Âºè
        function switchToLight(element) {
            console.log('üí° ÂàáÊç¢Âà∞‰∫ÆÂ∫¶Ê®°Âºè');
            
            // ÈöêËóèËøõÂ∫¶ÂºπÁ™óÔºàÂ¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫Ôºâ
            hideProgressModal();
            
            // ÁßªÈô§ÊâÄÊúâiconÁöÑactiveÁä∂ÊÄÅ
            const allIcons = document.querySelectorAll('.icon-item');
            allIcons.forEach(icon => icon.classList.remove('active'));
            
            // Ê∑ªÂä†ÂΩìÂâçiconÁöÑactiveÁä∂ÊÄÅ
            element.classList.add('active');
            
            // ÊòæÁ§∫‰∫ÆÂ∫¶Ë∞ÉËäÇÂäüËÉΩÔºàÊöÇÊó∂‰∏çÂÆûÁé∞ÂÖ∑‰ΩìÂäüËÉΩÔºâ
            console.log('ÊòæÁ§∫‰∫ÆÂ∫¶Ë∞ÉËäÇÂäüËÉΩ');
        }

        // ÂàõÂª∫overlayÈÅÆÁΩ©
        function createOverlay() {
            // ÂàõÂª∫overlayËÉåÊôØ
            const overlayBackground = document.createElement('div');
            overlayBackground.className = 'overlay-background';
            overlayBackground.onclick = closeOverlay;
            
            // ÂàõÂª∫overlayÂÆπÂô®
            const overlayContainer = document.createElement('div');
            overlayContainer.className = 'overlay-container';
            overlayContainer.innerHTML = `
                <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
                <div class="top-tab-bar">
                    <div class="top-nav-content">
                        <div class="back-button" onclick="closeOverlay()">
                            <img src="../images/Vector.svg" width="19" height="16" alt="ËøîÂõû">
                        </div>
                        <div class="book-info">
                            <div class="book-title">Oliver Twist</div>
                            <div class="book-author">Charles Dickens</div>
                        </div>
                        <div class="menu-button">
                            <div class="menu-dot"></div>
                            <div class="menu-dot"></div>
                            <div class="menu-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏≠Èó¥ÂçäÈÄèÊòéÂÜÖÂÆπÂå∫Âüü -->
                <div class="content-overlay" onclick="closeOverlay()">
                    <!-- ËøôÈáåÂèØ‰ª•ÊîæÁΩÆÂÖ∑‰ΩìÁöÑÂÜÖÂÆπ -->
                </div>

                                        <!-- Â∫ïÈÉ®ÂõæÊ†áÊ†è -->
                        <div class="bottom-label-bar">
                            <div class="bottom-icons">
                                <!-- Á¨îËÆ∞Êú¨ÂõæÊ†á -->
                                <div class="icon-item" onclick="switchToNotebook(this)">
                                    <img src="../images/notebook.svg" width="30" height="30" alt="notebook">
                                </div>

                                <!-- ËøõÂ∫¶ÂõæÊ†á -->
                                <div class="icon-item" onclick="switchToProcessing(this)">
                                    <img src="../images/processing.svg" width="30" height="30" alt="processing">
                                </div>

                                <!-- ‰∫ÆÂ∫¶ÂõæÊ†á -->
                                <div class="icon-item" onclick="switchToLight(this)">
                                    <img src="../images/light.svg" width="30" height="30" alt="light">
                                </div>
                            </div>
                        </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(overlayBackground);
            document.body.appendChild(overlayContainer);
            
            // Áû¨Èó¥Â±ïÂºÄoverlayÔºàinstantÔºâ
            overlayContainer.style.transform = 'scale(1) translateY(0)';
            overlayContainer.style.opacity = '1';
            
            // Ê∑ªÂä†bottom barÂºπÂá∫Âä®Áîª
            setTimeout(() => {
                const bottomBar = overlayContainer.querySelector('.bottom-label-bar');
                if (bottomBar) {
                    bottomBar.classList.add('show');
                }
            }, 50);
        }

        // ÂÖ≥Èó≠overlayÈÅÆÁΩ©
        function closeOverlay() {
            const overlayBackground = document.querySelector('.overlay-background');
            const overlayContainer = document.querySelector('.overlay-container');
            
            if (overlayContainer) {
                // Áû¨Èó¥ÂÖ≥Èó≠overlayÔºàinstantÔºâ
                overlayContainer.style.transform = 'scale(0.8) translateY(50px)';
                overlayContainer.style.opacity = '0';
                
                // Á´ãÂç≥ÁßªÈô§ÂÖÉÁ¥†
                if (overlayBackground) overlayBackground.remove();
                if (overlayContainer) overlayContainer.remove();
            }
        }

        // ÂàáÊç¢ÂõæÊ†áÊøÄÊ¥ªÁä∂ÊÄÅ
        function switchIcon(clickedIcon, iconType) {
            // ÁßªÈô§ÊâÄÊúâÂõæÊ†áÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.icon-item').forEach(icon => {
                icon.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªË¢´ÁÇπÂáªÁöÑÂõæÊ†á
            clickedIcon.classList.add('active');
            
            console.log('ÂàáÊç¢Âà∞ÂõæÊ†á:', iconType);
            
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÖ∑‰ΩìÁöÑÂäüËÉΩÈÄªËæë
            switch(iconType) {
                case 'notebook':
                    console.log('ÊòæÁ§∫Á¨îËÆ∞Êú¨ÂäüËÉΩ');
                    break;
                case 'processing':
                    console.log('ÊòæÁ§∫ËøõÂ∫¶ÂäüËÉΩ');
                    break;
                case 'light':
                    console.log('ÊòæÁ§∫‰∫ÆÂ∫¶Ë∞ÉËäÇÂäüËÉΩ');
                    break;
            }
        }

        // È°∂ÈÉ®ÂØºËà™Ê†èÊªöÂä®ÊéßÂà∂
        let lastScrollTop = 0;
        let scrollThreshold = 50; // ÊªöÂä®ÈòàÂÄº
        let isScrolling = false;
        let scrollTimer;

        function handleScroll() {
            const readingContent = document.getElementById('readingContent');
            const topBar = document.getElementById('topBar');
            
            if (!readingContent || !topBar) return;

            const scrollTop = readingContent.scrollTop;
            const scrollDelta = scrollTop - lastScrollTop;

            // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
            clearTimeout(scrollTimer);

            // Âêë‰∏äÊªöÂä®Êó∂ÊòæÁ§∫È°∂ÈÉ®Ê†è
            if (scrollDelta < -scrollThreshold) {
                topBar.classList.remove('hidden');
                topBar.classList.add('visible');
            }
            // Âêë‰∏ãÊªöÂä®Êó∂ÈöêËóèÈ°∂ÈÉ®Ê†è
            else if (scrollDelta > scrollThreshold) {
                topBar.classList.remove('visible');
                topBar.classList.add('hidden');
            }

            lastScrollTop = scrollTop;

            // ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÂÅúÊ≠¢ÊªöÂä®ÂêéÊòæÁ§∫È°∂ÈÉ®Ê†è
            scrollTimer = setTimeout(() => {
                topBar.classList.remove('hidden');
                topBar.classList.add('visible');
            }, 1000);
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Book NormalÈ°µÈù¢Âä†ËΩΩÂÆåÊàê');
            
            // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
            const currentUserId = localStorage.getItem('currentUserId');
            if (!currentUserId) {
                console.warn('Êú™ÊâæÂà∞Áî®Êà∑IDÔºåÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢');
                window.location.href = 'number.html';
                return;
            }
            
            console.log('ÂΩìÂâçÁî®Êà∑ID:', currentUserId);
            
            // ÂàùÂßãÂåñÁïåÈù¢ÂÅúÁïôÊó∂Èó¥ËÆ∞ÂΩï
            initPageStayTime();
            
            const readingContent = document.getElementById('readingContent');
            if (readingContent) {
                readingContent.addEventListener('scroll', handleScroll);
            }
            
            // ÂêØÁî®ÁΩëÈ°µÁ´ØËá™Â∏¶ÊñáÊú¨ÈÄâÊã©ÂäüËÉΩ
            enableNativeTextSelection();
            
            // ÂàùÂßãÂåñ‰∏ÄÂë®ÈòÖËØªÊï∞ÊçÆ
            initWeeklyReadingData();
            
            // ÁõëÂê¨ÊñáÊú¨ÊªöÂä®‰∫ã‰ª∂ÔºåÊõ¥Êñ∞ÈòÖËØª‰ΩçÁΩÆ
            const textContent = document.getElementById('textContent');
            if (textContent) {
                textContent.addEventListener('scroll', updateCurrentReadingPosition);
            }
            
            // Ê∑ªÂä†ËøõÂ∫¶ÂºπÁ™óÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÂäüËÉΩ
            document.addEventListener('click', function(e) {
                const progressModal = document.getElementById('progressModal');
                if (progressModal && progressModal.style.display === 'block') {
                    if (!progressModal.contains(e.target)) {
                        hideProgressModal();
                    }
                }
            });

            // È°µÈù¢Âä†ËΩΩÂä®Áîª
            const container = document.querySelector('.container');
            container.classList.add('fade-in');

            // Âä†ËΩΩÁ§∫‰æãÊñáÊú¨
            loadSampleText();
            
            // Ê∑ªÂä†Êô∫ËÉΩÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÂô®
            addSmartClickHandler();

            // ÂêØÂä®ÈòÖËØªÊó∂Èó¥ËÆ°Êó∂Âô®
            setInterval(updateReadingTime, 1000);

            // Ê∑ªÂä†È°µÈù¢ÈÄÄÂá∫ÁªüËÆ°
            window.addEventListener('beforeunload', function() {
                if (readingTime > 5) { // Âè™ÊúâÈòÖËØªÊó∂Èó¥Ë∂ÖËøá5ÂàÜÈíüÊâçËÆ∞ÂΩïÈÄÄÂá∫
                    exitCount++;
                    console.log('üìä È°µÈù¢ÈÄÄÂá∫ÔºåÈòÖËØªÊó∂Èó¥:', readingTime, 'ÂàÜÈíüÔºåÈÄÄÂá∫Ê¨°Êï∞:', exitCount);
                }
            });

            // ÈáçÊñ∞ËÆæËÆ°ÊñáÊú¨È´ò‰∫ÆÁ≥ªÁªü
            let isCreatingModal = false;
            let isCreatingNotebookModal = false;

            // Ê∑ªÂä†ÂºπÁ™óÂÖ≥Èó≠ÂäüËÉΩ - ‰øÆÂ§çÈÄªËæëÈóÆÈ¢ò
            document.addEventListener('click', function(e) {
                // Â¶ÇÊûúÊ≠£Âú®ÂàõÂª∫ÂºπÁ™óÔºåÂøΩÁï•ËøôÊ¨°ÁÇπÂáª
                if (window.isCreatingModal || window.isCreatingNotebookModal) {
                    console.log('üîç Ê≠£Âú®ÂàõÂª∫ÂºπÁ™óÔºåÂøΩÁï•ÁÇπÂáª‰∫ã‰ª∂');
                    return;
                }
                
                const statsModal = document.getElementById('statsModal');
                const simpleRecordingModal = document.getElementById('simpleRecordingModal');
                const notebookModal = document.getElementById('notebookModal');
                
                // Ê£ÄÊü•ÁÆÄÂçïrecordingÂºπÁ™ó
                if (simpleRecordingModal && simpleRecordingModal.style.display === 'block') {
                    console.log('üîç ÁÆÄÂçïrecordingÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåÊ£ÄÊü•ÁÇπÂáª‰ΩçÁΩÆ');
                    if (!simpleRecordingModal.contains(e.target)) {
                        console.log('üîç ÁÇπÂáªÂú®ÁÆÄÂçïrecordingÂºπÁ™óÂ§ñÈÉ®ÔºåÂÖ≥Èó≠ÂºπÁ™ó');
                        simpleRecordingModal.style.display = 'none';
                        // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶Âèëoverlay
                        e.stopPropagation();
                        return;
                    }
                }
                
                // Ê£ÄÊü•recordingÂºπÁ™ó
                if (statsModal && statsModal.style.display === 'block') {
                    console.log('üîç recordingÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåÊ£ÄÊü•ÁÇπÂáª‰ΩçÁΩÆ');
                    if (!statsModal.contains(e.target)) {
                        console.log('üîç ÁÇπÂáªÂú®recordingÂºπÁ™óÂ§ñÈÉ®ÔºåÂÖ≥Èó≠ÂºπÁ™ó');
                        closeRecording();
                        // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶Âèëoverlay
                        e.stopPropagation();
                        return;
                    }
                }
                
                // Ê£ÄÊü•Á¨îËÆ∞Êú¨ÂºπÁ™ó
                if (notebookModal && notebookModal.classList.contains('show')) {
                    console.log('üîç Á¨îËÆ∞Êú¨ÂºπÁ™óÂ∑≤ÊâìÂºÄÔºåÊ£ÄÊü•ÁÇπÂáª‰ΩçÁΩÆ');
                    if (!notebookModal.contains(e.target)) {
                        console.log('üîç ÁÇπÂáªÂú®Á¨îËÆ∞Êú¨ÂºπÁ™óÂ§ñÈÉ®ÔºåÂÖ≥Èó≠ÂºπÁ™ó');
                        closeNotebook();
                    }
                }
            });
        });

        // Êõ¥Êñ∞ÈòÖËØªÊó∂Èó¥
        function updateReadingTime() {
            const currentTime = Date.now();
            readingTime = Math.floor((currentTime - startTime) / 1000 / 60); // ËΩ¨Êç¢‰∏∫ÂàÜÈíü
        }

        // Âä†ËΩΩÁ§∫‰æãÊñáÊú¨
        function loadSampleText() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;

            // ËøôÈáåÂèØ‰ª•ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑOliver TwistÊñáÊú¨
            const sampleText = `
                <div class="chapter">
                    <h2>Chapter 1: Treats of the Place Where Oliver Twist was Born and of the Circumstances Attending His Birth</h2>
                    
                    <p>Among other public buildings in a certain town, which for many reasons it will be prudent to refrain from mentioning, and to which I will assign no fictitious name, there is one anciently common to most towns, great or small: to wit, a workhouse; and in this workhouse was born; on a day and date which I need not trouble myself to repeat, inasmuch as it can be of no possible consequence to the reader, in this stage of the business at all events; the item of mortality whose name is prefixed to the head of this chapter.</p>
                    
                    <p>For a long time after it was ushered into this world of sorrow and trouble, by the parish surgeon, it remained a matter of considerable doubt whether the child would survive to bear any name at all; in which case it is somewhat more than probable that these memoirs would never have appeared; or, if they had, that being comprised within a couple of pages, they would have possessed the inestimable merit of being the most concise and faithful specimen of biography, extant in the literature of any age or country.</p>
                    
                    <p>Although I am not disposed to maintain that the being born in a workhouse, is in itself the most fortunate and enviable circumstance that can possibly befall a human being, I do mean to say that in this particular instance, it was the best thing for Oliver Twist that could by possibility have occurred. The fact is, that there was considerable difficulty in inducing Oliver to take upon himself the office of respiration,‚Äîa troublesome practice, but one which custom has rendered necessary to our easy existence; and for some time he lay gasping on a little flock mattress, rather unequally poised between this world and the next: the balance was decidedly in favour of the latter.</p>
                </div>
                
                <div class="chapter">
                    <h2>Chapter 2: Treats of Oliver Twist's Growth, Education, and Board</h2>
                    
                    <p>For the next eight or ten months, Oliver was the victim of a systematic course of treachery and deception. He was brought up by hand. The hungry and destitute situation of the infant orphan was duly reported by the workhouse authorities to the parish authorities. The parish authorities inquired with dignity of the workhouse authorities, whether there was not female then domiciled in 'the house' who was in a situation to impart to Oliver Twist, the consolation and nourishment of which he stood in need. The workhouse authorities replied with humility, that there was not. Upon this, the parish authorities magnanimously and humanely resolved, that Oliver should be 'farmed,' or, in other words, that he should be dispatched to a branch-workhouse some three miles off, where twenty or thirty other juvenile offenders against the poor-laws, rolled about the floor all day, without the inconvenience of too much food or too much clothing, under the parental superintendence of an elderly female who received the culprits at and for the consideration of sevenpence-halfpenny per small head per week.</p>
                    
                    <p>Sevenpence-halfpenny's worth per week is a good round diet for a child; a great deal may be got for sevenpence-halfpenny: quite enough to overload its stomach, and make it uncomfortable. The elderly female was a woman of wisdom and experience; she knew what was good for children; and she had a very accurate perception of what was good for herself. So, she appropriated the greater part of the weekly stipend to her own use, and consigned the rising parochial generation to even a shorter allowance than was originally provided for them. Thereby finding in the lowest depth a deeper still; and proving herself a very great experimental philosopher.</p>
                </div>
                
                <div class="chapter">
                    <h2>Chapter 3: Relates How Oliver Twist was Very Near Getting a Place, Which Would Not Have Been a Sinecure</h2>
                    
                    <p>For a week after the commission of the impious and profane offence of asking for more, Oliver remained a close prisoner in the dark and solitary room to which he had been consigned by the wisdom and mercy of the board. It appears, at first sight, not unreasonable to suppose, that, if he had entertained a becoming feeling of respect for the prediction of the gentleman in the white waistcoat, he would have established that sage individual's prophetic character, once and for ever, by tying one end of his pocket-handkerchief to a hook in the wall, and attaching the other end to his neck. But to perform the act, he would have been obliged to climb upon a chair; and the chair was very rickety; and the wall was very high; and the handkerchief was very thin; and the hook was very rusty; and the board was very wise; and the gentleman in the white waistcoat was very dignified; and Oliver was very young; and Oliver was very much afraid of the board; and Oliver was very much afraid of the gentleman in the white waistcoat; and Oliver was very much afraid of the workhouse; and Oliver was very much afraid of the parish; and Oliver was very much afraid of the beadle; and Oliver was very much afraid of the master; and Oliver was very much afraid of the mistress; and Oliver was very much afraid of the matron; and Oliver was very much afraid of the cook; and Oliver was very much afraid of the nurse; and Oliver was very much afraid of the doctor; and Oliver was very much afraid of the apothecary; and Oliver was very much afraid of the undertaker; and Oliver was very much afraid of the sexton; and Oliver was very much afraid of the clergyman; and Oliver was very much afraid of the churchwarden; and Oliver was very much afraid of the overseer; and Oliver was very much afraid of the guardian; and Oliver was very much afraid of the committee; and Oliver was very much afraid of the board; and Oliver was very much afraid of the gentleman in the white waistcoat.</p>
                </div>
            `;

            textContent.innerHTML = sampleText;
        }
        
        // Ê∑ªÂä†Êô∫ËÉΩÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÂô®
        function addSmartClickHandler() {
            const textContent = document.getElementById('textContent');
            if (!textContent) return;
            
            let clickTimer = null;
            let isLongPress = false;
            
            // Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂
            textContent.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    isLongPress = false;
                    clickTimer = setTimeout(() => {
                        isLongPress = true;
                        console.log('üìù Ê£ÄÊµãÂà∞ÈïøÊåâÔºåÂêØÂä®ÊñáÊú¨ÈÄâÊã©');
                        // Ë∞ÉÁî®startHighlightTimerÂ§ÑÁêÜÈïøÊåâÈÄªËæë
                        startHighlightTimer(e);
                    }, 500);
                }
            });
            
            // Èº†Ê†áÊä¨Ëµ∑‰∫ã‰ª∂
            textContent.addEventListener('mouseup', function(e) {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÈÄâÊã©ËèúÂçï
                if (e.target.closest('#native-selection-menu')) {
                    return;
                }
                
                if (!isLongPress && e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    setTimeout(() => {
                        if (!isSelectingText) {
                            handleTextClick(e);
                        }
                    }, 10);
                }
                
                isLongPress = false;
            });
            
            // Ëß¶Êë∏‰∫ã‰ª∂
            textContent.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    isLongPress = false;
                    clickTimer = setTimeout(() => {
                        isLongPress = true;
                        // Ë∞ÉÁî®startHighlightTimerÂ§ÑÁêÜÈïøÊåâÈÄªËæë
                        startHighlightTimer(e);
                    }, 500);
                }
            });
            
            textContent.addEventListener('touchend', function(e) {
                if (clickTimer) {
                    clearTimeout(clickTimer);
                    clickTimer = null;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÈÄâÊã©ËèúÂçï
                if (e.target.closest('#native-selection-menu')) {
                    return;
                }
                
                if (!isLongPress && e.target.tagName === 'P' && !e.target.classList.contains('highlighted')) {
                    setTimeout(() => {
                        if (!isSelectingText) {
                            handleTextClick(e);
                        }
                    }, 10);
                }
                
                isLongPress = false;
            });
        }
    </script>
    
</body>
</html>
